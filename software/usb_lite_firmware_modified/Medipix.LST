A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE     1


MACRO ASSEMBLER A51 V7.04a
OBJECT MODULE PLACED IN Medipix.OBJ
ASSEMBLER INVOKED BY: C:\Keil\C51\BIN\A51.EXE Medipix.asm SET(SMALL) DEBUG EP

LOC  OBJ            LINE     SOURCE

                       1     ;
                       2     ; Authors       : Jan Jakubek, Zdenek Vykydal
                       3     ;
                       4     ; Date          : November 2004, June 2005, May 2006, September 2007
                       5     ;
                       6     ; File          : Main1.asm
                       7     ;
                       8     ; Hardware      : ADuC841
                       9     ;
                      10     ; Description   : Main program for Medipix2 USB 1.X interface
                      11     ;
                      12     ;*******************************************************************************
                      13     
                      14     ; CERN cable:
                      15     ;==============
                      16     ; Coditional compilations for different CERN cable lengths are driven by
                      17     ; definition of CERN_CABLE symbol just one of following four lines has to
                      18     ; be uncomented:
                      19     
  0000                20     CERN_CABLE              SET     0       ; No cable
                      21     ;CERN_CABLE             SET     1       ; Short cable           (<20m)
                      22     ;CERN_CABLE             SET     2       ; Long cable            (<40m)
                      23     ;CERN_CABLE             SET     3       ; Very long cable       (<60m)
                      24     
                      25     ; Version control:
                      26     ;===================
  0001                27     VERSION_MAJOR           SET     1
  0002                28     VERSION_MINOR           SET     2
  0000                29     VERSION_SUBMINOR        SET     0
                      30     
                      31     
                      32     
                      33     ; Communication protocol:
                      34     ;==========================
                      35     
                      36     ; Command received has a following format:
                      37     ;   X[parameters]
                      38     ; where:
                      39     ;   X is single byte command character.
                      40     ;   parameters is optional block of parameters (length depends on command)
                      41     
                      42     ; As a responste to each command the command character is echoed
                      43     ; followed by optional block of data and "OK" suffix:
                      44     ;   X[data]"OK"CR
                      45     ; where:
                      46     ;   X is single byte command character (the same as it was received)
                      47     ;   data is optional block of output data (length depends on command)
                      48     ;   "OK" is suffix informing about success (without quotes)
                      49     ;   CR is cariage return character (0Dh) terminating packet
                      50     
                      51     ; If command finishes with an error then output has this format:
                      52     ;   X"!Error string"CR
                      53     ; where
                      54     ;   X is single byte command character (the same as it was received)
                      55     ;   "!Error string" is suffix (without quotes) informing about failure. The '!' sign is man
                             datory!
                      56     ;   CR is cariage return character (0Dh) terminating packet
                      57     
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE     2

                      58     ; All other errors reported by the device (not in response to any command)
                      59     ; have format:
                      60     ;   "!Error string"CR
                      61     ; where
                      62     ;   "!Error string" is suffix (without quotes) informing about failure. The '!' sign is man
                             datory!
                      63     ;   CR is cariage return character (0Dh) terminating packet
                      64     
                      65     
                      66     ; Main program loop
                      67     ;==========================
                      68     
                      69     ; is reading commands received by USB interface (FTDI 245BM)
                      70     ; When command is recognized then the command is echoed on the USB
                      71     ; and appropriate service routine is called
                      72     ; After return from the command service the result is examined and appropriate
                      73     ; message is transmited (i.e. in case of no error it is "OK", and error message
                      74     ; starting withn '!' character elsewhere).
                      75     ; List of known commands and adresses of their services are in "Com_Table"
                      76     ; Received command is passed to command service in B register!
                      77     
                      78     ; Main loop also cheks flags from background processes running as interrupt services
                      79     ; If some of them would like to transmit its output it have to set the flag.
                      80     ; Main loop will call Service appropriate to this flag.
                      81     ; Main loop doesn't check the result of a background service call.
                      82     
                      83     
                      84     ; Command services
                      85     ;-------------------
                      86     ; Command service don't have to preserve any register value.
                      87     ; The command character is passed to the service in B register.
                      88     ; Command may not to echo the command character.
                      89     
                      90     ; If service finishes with no error it has to set CY=0.
                      91     ; Main loop will transmit the "OK" message.
                      92     
                      93     ; In case of an error it has to set CY=1 and DPTR to point to error message.
                      94     ; Main loop will transmit this message. Service can transmit error message itself
                      95     ; in that case DPTR has to be set to zero.
                      96     
                      97     
                      98     ; Background processes:
                      99     ;==========================
                     100     
                     101     ; Interval Timer
                     102     ;-----------------
                     103     ; As resolution of built in interval timer is not satisfactory the more
                     104     ; precise timer is implemnted using timer/counter TO.
                     105     ; Timer T0 is configured as 16 bit timer (Mode 1) generating interrupt
                     106     ; The whole amount of clocks which have to be counted is stored in 6 bytes of memory INTERV
                             AL_TIME
                     107     ; allowing to measure interval of 162 days with precission of 50ns.
                     108     ; When interval timer overflows actions given by TODO register (INTERVAL_TODO) are performe
                             d.
                     109     
                     110     ; Period timer:
                     111     ;---------------
                     112     ; Is implemented using timer T1. Resolution is the same as in case of Interval Timer.
                     113     ; When period timer overflows actions given by TODO register (PERIOD_TODO) are performed
                     114     ; and timer is restarted.
                     115     
                     116     ; Frame counter:
                     117     ;----------------
                     118     ; When a frame is transmited as a result of some of background processes the frma counter i
                             s
                     119     ; decremented and specific TODO actions (FRAME_TODO) are performed. If Frame counter underf
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE     3

                             lows all
                     120     ; background processes are stopped.
                     121     
                     122     ; Scope
                     123     ;-----------------
                     124     ; ADC is configured to perform DMA measurement, on max 8 preselected channels
                     125     ; with preselected timing. Whole amount of samples which it can take per single trigger is
                     126     ; given by scope memory which is 1kB.
                     127     
                     128     ; Trigger
                     129     ;-----------------
                     130     ; INT0 is configured to generate interrupt.
                     131     ; The interrupt service can call actions given by its TODO register (TRIGGER_TODO).
                     132     ; Coincidence modes can be used with trigger (configured by TRIGGER_COINC):
                     133     ; - If TRIGGER_COINC is set and trigger occures then if TRIGGER_TODO contain flag
                     134     ;   TODO_CloseShutter the shutter will be closed and value of P3.0 (RxD) will be checked
                     135     ; - If P3.0 (RxD) is the same as value configured in bit 2 of TRIGGER_COINC register
                     136     ;   the coincidence is signalised and data are transfered from Medipix chip to USB.
                     137     ; - If P3.0 is different then coincidence is rejected and Medipix data are reseted.
                     138     ;   The shutter is opened and trigger started to continue the measurement.
                     139     ; - The coincidence can be notified on P3.1 (TxD) line. Mode of notification can be
                     140     ;   configured by bits 3,4,5 of TRIGGER_COINC register.
                     141     
                     142     ; Counter
                     143     ;-----------------
                     144     ; T1 is configured as counter of external pulses. Max number of pulses is given by 6 bytes 
                             integer.
                     145     ; It generates interrupt and calls service routione in dependence on predefined TODO Action
                              (COUNTER_TODO).
                     146     
                     147     
                     148     ; TODO actions:
                     149     ;==========================
                     150     ; Each of background processes can on its action perform its specific Actions.
                     151     ; Actions are defined for each of them by specific TODO register. Each bit
                     152     ; of this register can start certain action:
                     153     ; - Close shutter and stop interval measurement
                     154     ; - Open the shutter
                     155     ; - Start the Interval
                     156     ; - Trigger for scope
                     157     ; - Start waiting for external trigger (interrupt)
                     158     ; - Start of waiting for counter event (counter overflow)
                     159     ; - Makes predefined command number 1
                     160     ; - Makes predefined command number 2
                     161     
                     162     
                     163     ;###############################################################################
                     164     ;#                                                                             #
                     165     ;#                      I M P L E M E N T A T I O N                            #
                     166     ;#                                                                             #
                     167     ;###############################################################################
                     168     
                     169     ;REV.  1.0   30 September 2003
                     170     ;ADuC841   Apps, Analog Devices Inc.
  0091               171     I2CADD1  DATA  091H  ;I2C ADDRESS REGISTER1
  0092               172     I2CADD2  DATA  092H  ;I2C ADDRESS REGISTER2
  0093               173     I2CADD3  DATA  093H  ;I2C ADDRESS REGISTER3
  009A               174     I2CDAT   DATA  09AH  ;I2C DATA REGISTER
  009B               175     I2CADD   DATA  09BH  ;I2C ADDRESS REGISTER
  009E               176     T3CON    DATA  09EH  ;TIMER 3 CONTROL
  009D               177     T3FD     DATA  09DH  ;TIMER 3 FRACTIONAL DIVIDER
  00A1               178     TIMECON  DATA  0A1H  ;TIC CONTROL
  00A2               179     HTHSEC   DATA  0A2H  ;TIC - HTHSEC DATA
  00A3               180     SEC      DATA  0A3H  ;TIC - SEC DATA
  00A4               181     MIN      DATA  0A4H  ;TIC - MIN DATA
  00A5               182     HOUR     DATA  0A5H  ;TIC - HOUR DATA
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE     4

  00A6               183     INTVAL   DATA  0A6H  ;TIC INTERVAL REGISTER
  00A7               184     DPCON    DATA  0A7H  ;DUAL DATA POINTER CONTROL REGISTER
  00A9               185     IEIP2    DATA  0A9H  ;INTERRUPT ENABLE 2
  00AE               186     PWMCON   DATA  0AEH  ;PWM CONTROL REGISTER
  00AF               187     CFG841   DATA  0AFH  ;GENERAL FLASH/PWM CONTROL REGISTER
  00B1               188     PWM0L    DATA  0B1H  ;PWM DATA REGISTER
  00B2               189     PWM0H    DATA  0B2H  ;PWM DATA REGISTER
  00B3               190     PWM1L    DATA  0B3H  ;PWM DATA REGISTER
  00B4               191     PWM1H    DATA  0B4H  ;PWM DATA REGISTER
  00B7               192     SPH      DATA  0B7H  ;EXTENDED STACK POINTER REGISTER
  00B9               193     ECON     DATA  0B9H  ;FLASH EEPROM CONTROL
  00BC               194     EDATA1   DATA  0BCH  ;FLASH EEPROM DATA1 
  00BD               195     EDATA2   DATA  0BDH  ;FLASH EEPROM DATA2 
  00BE               196     EDATA3   DATA  0BEH  ;FLASH EEPROM DATA3 
  00BF               197     EDATA4   DATA  0BFH  ;FLASH EEPROM DATA4 
  00C0               198     WDCON    DATA  0C0H  ;WATCHDOG TIMER CONTROL
  00C2               199     CHIPID   DATA  0C2H  ;CHIPID REGISTER
  00C6               200     EADRL    DATA  0C6H  ;FLASH EEPROM PAGE ADDRESS - LOW BYTE
  00C7               201     EADRH    DATA  0C7H  ;FLASH EEPROM PAGE ADDRESS - LOW BYTE
  00C8               202     T2CON    DATA  0C8H  ;TIMER 2 CONTROL
  00CA               203     RCAP2L   DATA  0CAH  ;TIMER 2 CAPTURE REGISTER - LOW BYTE
  00CB               204     RCAP2H   DATA  0CBH  ;TIMER 2 CAPTURE REGISTER - HIGH BYTE
  00CC               205     TL2      DATA  0CCH  ;TIMER 2 - LOW BYTE
  00CD               206     TH2      DATA  0CDH  ;TIMER 2 - HIGH BYTE
  00D2               207     DMAL     DATA  0D2H  ;DMA ADDRESS LOW BYTE
  00D3               208     DMAH     DATA  0D3H  ;DMA ADDRESS HIGH BYTE
  00D4               209     DMAP     DATA  0D4H  ;DMA ADDRESS PAGE BYTE
  00D7               210     PLLCON   DATA  0D7H  ;PLL CONTROL
  00D8               211     ADCCON2  DATA  0D8H  ;ADC CONTROL
  00D9               212     ADCDATAL DATA  0D9H  ;ADC DATA LOW BYTE
  00DA               213     ADCDATAH DATA  0DAH  ;ADC DATA HIGH BYTE
  00DF               214     PSMCON   DATA  0DFH  ;POWER SUPPLY MONITOR
  00E8               215     DCON     DATA  0E8H  ;D1 AND D0 CONTROL
  00E8               216     I2CCON   DATA  0E8H  ;I2C CONTROL
  00EF               217     ADCCON1  DATA  0EFH  ;ADC CONTROL
                     218     
  00F1               219     ADCOFSL  DATA  0F1H  ;ADC OFFSET LOW BYTE
  00F2               220     ADCOFSH  DATA  0F2H  ;ADC OFFSET HIGH BYTE
  00F3               221     ADCGAINL DATA  0F3H  ;ADC GAIN LOW BYTE
  00F4               222     ADCGAINH DATA  0F4H  ;ADC GAIN HIGH BYTE
  00F5               223     ADCCON3  DATA  0F5H  ;ADC CONTROL
  00F7               224     SPIDAT   DATA  0F7H  ;SPI DATA REGISTER
  00F8               225     SPICON   DATA  0F8H  ;SPI CONTROL REGISTER
  00F9               226     DAC0L    DATA  0F9H  ;DAC0 LOW BYTE
  00FA               227     DAC0H    DATA  0FAH  ;DAC0 HIGH BYTE
  00FB               228     DAC1L    DATA  0FBH  ;DAC1 LOW BYTE
  00FC               229     DAC1H    DATA  0FCH  ;DAC1 HIGH BYTE
  00FD               230     DACCON   DATA  0FDH  ;DAC CONTROL REGISTER
  0084               231     DPP      DATA  084H  ;DATA POINTER - PAGE BYTE
                     232     
                     233     
                     234     
                     235     
  0090               236     T2       BIT   090H  ;P1.0 - TIMER 2 TRIGGER INPUT
  0091               237     T2EX     BIT   091H  ;P1.1 - TIMER 2 COUNT INPUT
                     238     
                     239     
  00AE               240     EADC     BIT   0AEH  ;IE.6 - ENABLE ADC INTURRUPT
  00BD               241     PT2      BIT   0BDH  ;IP.5 - TIMER 2 PRIORITY
  00BE               242     PADC     BIT   0BEH  ;IP.6 - ADC PRIORITY
  00BF               243     PSI      BIT   0BFH  ;IP.7 - SPI OR 2-WIRE SERIAL INTERFACE PRIORITY
  00C0               244     WDWR     BIT   0C0H  ;WDCON.0 - WATCHDOG WRITE ENABLE
  00C1               245     WDE      BIT   0C1H  ;WDCON.1 - WATCHDOG ENABLE
  00C2               246     WDS      BIT   0C2H  ;WDCON.2 - WATCHDOG STATUS BIT
  00C3               247     WDIR     BIT   0C3H  ;WDCON.3 - WATCHDOG INTERRUPT RESPONSE ENABLE BIT
  00C4               248     PRE0     BIT   0C4H  ;WDCON.4 - WATCHDOG TIMEOUT SELECTION BIT0
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE     5

  00C5               249     PRE1     BIT   0C5H  ;WDCON.5 - WATCHDOG TIMEOUT SELECTION BIT1
  00C6               250     PRE2     BIT   0C6H  ;WDCON.6 - WATCHDOG TIMEOUT SELECTION BIT2
  00C7               251     PRE3     BIT   0C7H  ;WDCON.7 - WATCHDOG TIMEOUT SELECTION BIT3
  00C8               252     CAP2     BIT   0C8H  ;T2CON.0 - CAPTURE OR RELOAD SELECT
  00C9               253     CNT2     BIT   0C9H  ;T2CON.1 - TIMER OR COUNTER SELECT
  00CA               254     TR2      BIT   0CAH  ;T2CON.2 - TIMER 2 ON/OFF CONTROL
  00CB               255     EXEN2    BIT   0CBH  ;T2CON.3 - TIMER 2 EXTERNAL ENABLE FLAG
  00CC               256     TCLK     BIT   0CCH  ;T2CON.4 - TRANSMIT CLOCK SELECT
  00CD               257     RCLK     BIT   0CDH  ;T2CON.5 - RECEIVE CLOCK SELECTT
  00CE               258     EXF2     BIT   0CEH  ;T2CON.6 - EXTERNAL TRANSITION FLAG
  00CF               259     TF2      BIT   0CFH  ;T2CON.7 - TIMER 2 OVERFLOW FLAG
  00D1               260     F1       BIT   0D1H  ;PSW.1 - FLAG 0
  00D8               261     CS0      BIT   0D8H  ;ADCCON2.0 - ADC INPUT CHANNEL SELECT BIT0
  00D9               262     CS1      BIT   0D9H  ;ADCCON2.1 - ADC INPUT CHANNEL SELECT BIT1
  00DA               263     CS2      BIT   0DAH  ;ADCCON2.2 - ADC INPUT CHANNEL SELECT BIT2
  00DB               264     CS3      BIT   0DBH  ;ADCCON2.3 - ADC INPUT CHANNEL SELECT BIT3
  00DC               265     SCONV    BIT   0DCH  ;ADCCON2.4 - SINGLE CONVERSION ENABLE
  00DD               266     CCONV    BIT   0DDH  ;ADCCON2.5 - CONTINUOUS CONVERSION ENABLE
  00DE               267     DMA      BIT   0DEH  ;ADCCON2.6 - DMA MODE ENABLE
  00DF               268     ADCI     BIT   0DFH  ;ADCCON2.7 - ADC INTURRUPT FLAG
  00E8               269     I2CI     BIT   0E8H  ;I2CCON.0 - I2C INTURRUPT FLAG
  00E9               270     I2CTX    BIT   0E9H  ;I2CCON.1 - I2C TRANSMIT SELECT
  00EA               271     I2CRS    BIT   0EAH  ;I2CCON.2 - I2C RESET
  00EB               272     I2CM     BIT   0EBH  ;I2CCON.3 - I2C MASTER MODE SELECT
  00EC               273     MDI      BIT   0ECH  ;I2CCON.4 - I2C MASTER MODE SDATA INPUT
  00EC               274     I2CID0   BIT   0ECH  ;I2CCON.4 - I2C SLAVE MODE INTERRUPT DECODE
  00ED               275     MCO      BIT   0EDH  ;I2CCON.5 - I2C MASTER MODE SCLOCK OUTPUT
  00ED               276     I2CID1   BIT   0EDH  ;I2CCON.5 - I2C SLAVE MODE INTERRUPT DECODE
  00EE               277     MDE      BIT   0EEH  ;I2CCON.6 - I2C MASTER MODE SDATA ENABLE
  00EE               278     I2CGC    BIT   0EEH  ;I2CCON.6 - I2C SLAVE MODE GENERAL CALL STATUS BIT
  00EF               279     MDO      BIT   0EFH  ;I2CCON.7 - I2C MASTER MODE SDATA OUTPUT
  00EF               280     I2CSI    BIT   0EFH  ;I2CCON.7 - I2C SLAVE  MODE STOP INTERRUPT ENABLE 
  00F8               281     SPR0     BIT   0F8H  ;SPICON.0 - SPI BITRATE SELECT BIT0
  00F9               282     SPR1     BIT   0F9H  ;SPICON.1 - SPI BITRATE SELECT BIT1
  00FA               283     CPHA     BIT   0FAH  ;SPICON.2 - SPI CLOCK PHASE SELECT
  00FB               284     CPOL     BIT   0FBH  ;SPICON.3 - SPI CLOCK POLARITY SELECT
  00FC               285     SPIM     BIT   0FCH  ;SPICON.4 - SPI MASTER/SLAVE MODE SELECT
  00FD               286     SPE      BIT   0FDH  ;SPICON.5 - SPI INTERFACE ENABLE
  00FE               287     WCOL     BIT   0FEH  ;SPICON.6 - SPI WRITE COLLISION ERROR FLAG
  00FF               288     ISPI     BIT   0FFH  ;SPICON.7 - SPI END OF TRANSFER FLAG
  00AD               289     ET2      BIT   0ADH  ;IE.5 - TIMER 2 INTERRUPT ENABLE
                     290     
                     291     ; $MOD841                         ; Use 8052&ADuC841 predefined symbols
                     292     
                     293     ;===============================================================================
                     294     ; DEFINE VARIABLES IN INTERNAL RAM
                     295     
----                 296     DSEG
0030                 297     ORG 0030h
                     298     
                     299     ; Chip counter
                     300     ;----------------
0030                 301     MPX_CHIPS:              DS      1       ; Counter of Medipix chips
0031                 302     MPX_ISMXR:              DS      1       ; If MXR is connected then this is nonzero, if time
                             pix is connected then 0x80 mask is added (MSB is set)
                     303     ;2
                     304     
                     305     ; Interval timer
                     306     ;----------------
0032                 307     INTERVAL_TIME:          DS      6       ; Preset interval duration LSB byte is first
0038                 308     INTERVAL_CURR:          DS      4       ; Upper four bytes of interval counter LSB first
003C                 309     INTERVAL_TODO:          DS      1       ; Mask of actions which should be done in interrupt
003D                 310     INTERVAL_MODE:          DS      1       ; Reflects if timer has been started loaded by zero
                             es (to measure interval) or loaded by INTERVAL_TIME (to generate interrupt)
                     311     ;12+2=14
                     312     
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE     6

                     313     ; Period timer
                     314     ;----------------
003E                 315     PERIOD_TIME:            DS      6       ; Preset period duration LSB byte is first
0044                 316     PERIOD_CURR:            DS      4       ; Upper four bytes of period counter LSB first
0048                 317     PERIOD_TODO:            DS      1       ; Mask of actions which should be done in interrupt
                     318     ;11+14=25
                     319     
                     320     ; External Counter:
                     321     ;--------------------
0049                 322     COUNTER_COUNT:          DS      6       ; Preset count
004F                 323     COUNTER_CURR:           DS      4       ; Current count
0053                 324     COUNTER_TODO:           DS      1       ; Mask of actions which should be done in interrupt
                     325     ;11+25=36
                     326     
                     327     ; External trigger:
                     328     ;--------------------
0054                 329     TRIGGER_COUNT:          DS      4       ; Counter of external triggers
0058                 330     TRIGGER_TODO:           DS      1       ; Mask of actions which should be done in interrupt
0059                 331     TRIGGER_COINC:          DS      1       ; Flags for coincident measurement
005A                 332     TRIGGER_COINCDELAY:     DS      1       ; Wait time for coincidence (for TriggerIn input)
                     333     ;7+36=43
                     334     
                     335     ; Delay loop:
                     336     ;--------------------
005B                 337     DELAY_TODOWHEN:         DS      1       ; Flags (same like TODO) teling when delay should b
                             e applied
005C                 338     DELAY_HOWMUCH:          DS      2       ; How long delay should be used
                     339     ;3+43=46
                     340     
                     341     ; Frame counter:
                     342     ;--------------------
005E                 343     FRAME_COUNT:            DS      4       ; How many frames have to be taken
0062                 344     FRAME_CURR:             DS      4       ; Current number of frames
0066                 345     FRAME_TODO:             DS      1       ; Mask of actions which should be done after matrix
                              readout
                     346     ;9+46=55
                     347     
                     348     ; TODO Commands:
                     349     ;----------------
0067                 350     TODO_Command1:          DS      1       ; Command which should be done if TODO mask contain
                             s bit TODO_MakeCommand1
0068                 351     TODO_Command2:          DS      1       ; Command which should be done if TODO mask contain
                             s bit TODO_MakeCommand2
                     352     ;2+55=57
                     353     
                     354     ; To do mask bits:
                     355     ;------------------
  00E0               356     TODO_CloseShutter       EQU     ACC.0   ; Closes shutter and stops interval measurement
  00E1               357     TODO_OpenShutter        EQU     ACC.1   ; Opens shutter
  00E2               358     TODO_StartInterval      EQU     ACC.2   ; Starts Interval
  00E3               359     TODO_StartScope         EQU     ACC.3   ; Trigger for scope
  00E4               360     TODO_StartTrigger       EQU     ACC.4   ; Start of waiting for external trigger
  00E5               361     TODO_StartCounter       EQU     ACC.5   ; Start of waiting for counter event
  00E6               362     TODO_MakeCommand1       EQU     ACC.6   ; Makes command number 1
  00E7               363     TODO_MakeCommand2       EQU     ACC.7   ; Makes command number 2
                     364     
                     365     ; Triggered coincidence modes:
                     366     ;------------------------------
  00E0               367     COINC_Test              EQU     ACC.0   ; Coincidence mode is activated
                     368     ; COINC_TestLevel               EQU     ACC.1   ; This level of P3.0 (RxD) means coincidenc
                             e (data have to be transmitted), oposite level means noncoincidence (data are scratched)
  00E2               369     COINC_Notify            EQU     ACC.2   ; The notification on P3.1 (TxD) should be generate
                             d
  00E3               370     COINC_NotifyInitLevel   EQU     ACC.3   ; This is default level of P3.1 (TxD)
  00E4               371     COINC_NotifyValidCoinc  EQU     ACC.4   ; If TRUE just coincidence will be notified, if FAL
                             SE each trigger generates notification
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE     7

  00E5               372     COINC_NotifyByPulse     EQU     ACC.5   ; If TRUE then two transitions (forming pulse) are 
                             generated on P3.1. If FALSE then just one
  00E6               373     COINC_CoincEvent        EQU     ACC.6   ; If TRUE then Back_ReadMatrix service generates no
                             tifcation after data transfer.
  00E7               374     COINC_InValidCoinc      EQU     ACC.7   ; Flag for Back_ReadMatrix service. If set then mat
                             rix should be reseted instead of Read.
                     375     
                     376     ; Scope using DMA ADC mode:
                     377     ;--------------------------
  01C2               378     SCOPE_MAXCOUNT          EQU     450     ; Maximal Number of ADC readings to be taken
  0384               379     SCOPE_DATALEN           EQU     SCOPE_MAXCOUNT*2
  0388               380     SCOPE_BUFFLEN           EQU     SCOPE_DATALEN+4
  0002               381     SCOPE_DEFCHANMSK        EQU     02h     ; Default is ADC 1
                     382     
0069                 383     SCOPE_SAMPLES:          DS      2       ; Number of samples to take (All channels summed)
006B                 384     SCOPE_TIMING:           DS      1       ; Timing of ADC conversions: 0 0 0 0 CK1 CK0 AQ1 AQ
                             0 (see ADC manual)
006C                 385     SCOPE_CHANNELS:         DS      1       ; Which channels to sample ? Each bit means appropr
                             iate channel
006D                 386     SCOPE_CHANBUFF:         DS      8       ; Buffer for channel numbers (to configure memory f
                             or DMA)
0075                 387     SCOPE_CHANCNT:          DS      1       ; Number of channels
                     388     ;13+57=70
                     389     
                     390     
                     391     ; Flash DATA commands:
                     392     ;-------------------------
  0001               393     FLASH_READ              EQU     1
  0002               394     FLASH_WRITE             EQU     2
  0004               395     FLASH_VERIFY            EQU     4
  0005               396     FLASH_ERASE             EQU     5
  0081               397     FLASH_READBYTE          EQU     81h
  0082               398     FLASH_WRITEBYTE         EQU     82h
                     399     
                     400     
                     401     ;SPI configurations:
                     402     ;-------------------------
  0034               403     SPI_CONFIG_MPX_1        SET     34h     ; SPI is enabled in Master Mode (I2C is enabled), C
                             POL=0, CPHA=1, frequency Fosc/2, fastest (no cable)
  0035               404     SPI_CONFIG_MPX_2        SET     35h     ; SPI is enabled in Master Mode (I2C is enabled), C
                             POL=0, CPHA=1, frequency Fosc/4
  0036               405     SPI_CONFIG_MPX_3        SET     36h     ; SPI is enabled in Master Mode (I2C is enabled), C
                             POL=0, CPHA=1, frequency Fosc/8
  0037               406     SPI_CONFIG_MPX_4        SET     37h     ; SPI is enabled in Master Mode (I2C is enabled), C
                             POL=0, CPHA=1, frequency Fosc/16, slowest (long cable)
                     407     
                     408     ; SPI configuration for TimePix clock generation
  0034               409     SPI_CONFIG_CLOCK        SET     34h     ; SPI is enabled in Master Mode (I2C is enabled), C
                             POL=0, CPHA=1, frequency Fosc/2
                     410     ; SPI configuration for BIAS voltage settings:
  0033               411     SPI_CONFIG_BIAS         SET     33h     ; SPI is enabled in Master Mode (I2C is enabled), C
                             POL=0, CPHA=0, frequency Fosc/16
                     412     
                     413     
                     414     ; The slowest communication speed requires certain wait time:
                     415     SPI_WAIT_MAX    MACRO
                     416             NOP
                     417             NOP
                     418             NOP
                     419             NOP
                     420             NOP
                     421             ENDM
                     422     
                     423     ; Actual SPI speed for MPX communication:
                     424     ;========================================
                     425     ; is given here according to CERN_CABLE
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE     8

  0034               426     SPI_CONFIG_MPX          SET     (SPI_CONFIG_MPX_1 + CERN_CABLE)
                     427     
                     428     ; Actual wait time is given here (according to value of SPI_CONFIG_MPX):
                     429     SPI_WAIT MACRO
                     430          IF (SPI_CONFIG_MPX = SPI_CONFIG_MPX_4)
                     431            SPI_WAIT_MAX
                     432          ENDIF
                     433       ENDM
                     434     
                     435     ;===============================================================================
                     436     ; External memory reservation
                     437     
----                 438     XSEG            ; Set the external memory space segment
0000                 439     ORG 000000h
                     440     
                     441     
0000                 442     CHIPBOARD_ID:   DS 8*4                  ; Buffer for chip ID (max 8 chips per 4 bytes)
0020                 443     SCOPE_BUFF:     DS SCOPE_BUFFLEN        ; Buffer for scope - DMA acquisition will be target
                             ed here
03A8                 444     MONITOR_BUFF:   DS 14*2+4               ; Buffer for monitor - DMA acquisition will be targ
                             eted here
                     445     
                     446     ;===============================================================================
                     447     ; Code segment
                     448     
----                 449     CSEG                            ; Set the program memory space segment
                     450     
                     451     ;===============================================================================
                     452     ; Flags:
                     453     ;===============================================================================
                     454     
                     455     ; Background register holds flags from background processes
                     456     ; Main loop checks this register periodicaly
                     457     ; If some of these flags is set its appropriate service is called
                     458     
  0020               459     Background      DATA    020H
  0000               460     Back_Interval   BIT     000H    ; Flag is set from interval interrupt service (T0 timer)
  0001               461     Back_Period     BIT     001H    ; Flag is set from period interrupt service  (T2 timer)
  0002               462     Back_Trigger    BIT     002H    ; Flag is set form interrupt caused by external pin INT0
  0003               463     Back_Counter    BIT     003H    ; Flag is set from interrupt caused by T1 counter
  0004               464     Back_Scope      BIT     004H    ; Flag is set from ADC interrupt (after scope action)
  0005               465     Back_ReadMatrix BIT     005H    ; Flag is set from either interrupt - Data readout has to b
                             e done
  0006               466     Back_ToDoCom1   BIT     006H    ; Flag is set from either interrupt - TODO_Command1 has to 
                             be performed
  0007               467     Back_ToDoCom2   BIT     007H    ; Flag is set from either interrupt - TODO_Command2 has to 
                             be performed
                     468     
                     469     ; Medipix CMOS inputs:
                     470     ;-----------------------
  0021               471     M_CmosIn        DATA    021H    ; Adress of byte with Medipix CMOS inputs settings
  0008               472     M_Reset         BIT     008H
  0009               473     M_PulseAdress   BIT     009H
  000A               474     M_EnablePulse   BIT     00AH
  000B               475     M_Polarity      BIT     00BH
  000C               476     M_SpareFSR      BIT     00CH
  000D               477     M_M1            BIT     00DH
  000E               478     M_M0            BIT     00EH
  000F               479     M_Shutter       BIT     00FH    ; 1 = Shutter is closed
                     480     
                     481     ; ADC is used (for):
                     482     ;--------------------
  0022               483     ADCused         DATA    022H
  0010               484     ADCused_Scope   BIT     010H
  0011               485     ADCused_Monitor BIT     011H
                     486     
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE     9

                     487     ; Other flags:
                     488     ;--------------------
  0023               489     OFlags          DATA    023H
  0018               490     IgnoreNextTrg   BIT     018H    ; If IgnoreNextTrg=1 then next trigger will be received but
                              ignored
  0019               491     ScopeTgrDisabled BIT    019H    ; Scope can't be started - ADC is busy or old scope data ar
                             e not fully transmited
                     492     
                     493     
                     494     ;===============================================================================
                     495     ; Macros:
                     496     ;===============================================================================
                     497     
                     498     ; Pushes all registers used by firmware on the stack
                     499     PUSHALL MACRO
                     500             PUSH    02
                     501             PUSH    01
                     502             PUSH    00
                     503             PUSH    B
                     504             PUSH    DPP
                     505             PUSH    DPH
                     506             PUSH    DPL
                     507             PUSH    ACC
                     508             PUSH    PSW
                     509             ENDM
                     510     
                     511     ; Pops all registers pushed by PUSHALL
                     512     POPALL MACRO
                     513             POP     PSW
                     514             POP     ACC
                     515             POP     DPL
                     516             POP     DPH
                     517             POP     DPP
                     518             POP     B
                     519             POP     00
                     520             POP     01
                     521             POP     02
                     522             ENDM
                     523     
                     524     ; Start watchdog timer
                     525     StartWatchdog MACRO
                     526             SETB    WDWR
                     527             MOV     WDCON,#72h
                     528             ENDM
                     529     
                     530     ; Refresh Watchdog - use just when interrupts are disabled
                     531     RefreshWatchdogBase MACRO
                     532             SETB    WDWR
                     533             SETB    WDE
                     534             ENDM
                     535     
                     536     ; Refresh watchdog timer
                     537     RefreshWatchdog MACRO
                     538             CLR     EA
                     539             RefreshWatchdogBase
                     540             SETB    EA
                     541             ENDM
                     542     
                     543     ; Macro starting interval timer: Starts the T0 timer, Enables its interrupt
                     544     IntervalStart   MACRO
                     545             SETB    ET0             ; Enable interrupt from T0
                     546             SETB    TR0             ; Start T0 counting
                     547             ENDM
                     548     
                     549     ;  Macro stoping interval timer: Stops the T0 timer, disables its interrrupt
                     550     IntervalStop    MACRO
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    10

                     551             CLR     TR0             ; Stop T0
                     552             CLR     ET0             ; Disable T0 interrupt
                     553             ENDM
                     554     
                     555     ; Macro starting interval timer: Starts the T1 counter, Enables its interrupt
                     556     CounterStart    MACRO
                     557             SETB    ET1             ; Enable interrupt from T1
                     558             SETB    TR1             ; Start T1 counting
                     559             ENDM
                     560     
                     561     ;  Macro stoping interval timer: Stops the T1 counter, disables its interrrupt
                     562     CounterStop     MACRO
                     563             CLR     TR1             ; Stop T1
                     564             CLR     ET1             ; Disable T1 interrupt
                     565             ENDM
                     566     
                     567     ; Macro starting period timer: Starts the T2 timer, Enables its interrupt
                     568     PeriodStart     MACRO
                     569             SETB    ET2             ; Enable interrupt from T2
                     570             SETB    TR2             ; Start T2 counting
                     571             ENDM
                     572     
                     573     ;  Macro stoping period timer: Stops the T2 timer, disables its interrrupt
                     574     PeriodStop      MACRO
                     575             CLR     TR2             ; Stop T2
                     576             CLR     ET2             ; Disable T2 interrupt
                     577             ENDM
                     578     
                     579     ; Macro enabling external trigger
                     580     TriggerStart    MACRO
                     581             SETB    IgnoreNextTrg   ; Following interrupt will be ignored if it hapens imediate
                             lly
                     582             SETB    EX0             ; Enable interrupt from INT0
                     583             NOP                     ; Wait a litle bit
                     584             NOP                     ; Wait a litle bit
                     585             CLR     IgnoreNextTrg   ; Now an interrupt can hapen
                     586             ENDM
                     587     
                     588     ; Macro disabling external trigger
                     589     TriggerStop     MACRO
                     590             CLR     EX0             ; Disable interrupt from INT0
                     591             ENDM
                     592     
                     593     ; Macro starting scope measurement
                     594     ScopeStart      MACRO
                     595             MOV     ADCCON2,#040h           ; enable DMA mode
                     596             SETB    CCONV                   ; start continuous ADC conversions using DMA
                     597             SETB    EADC                    ; Enable ADC interrupt
                     598             SETB    ADCused_Scope           ; Capture ADC
                     599             SETB    ScopeTgrDisabled        ; Scope operation is not finished
                     600             ENDM
                     601     
                     602     ;===============================================================================
                     603     ; Medipix support:
                     604     ;===============================================================================
                     605     
                     606     ; Symbols:
                     607     
  00A4               608     LatchEnable     EQU     P2.4            ; 1->transparent, 0->previous
  00A5               609     M_EnableOut     EQU     P2.5
  00A6               610     M_EnableIn      EQU     P2.6
  00A7               611     DCShutdown      EQU     P2.7
  0080               612     M_port          EQU     P0
  00B1               613     TriggerOut      EQU     P3.1            ; Txd pin (output)
  00B0               614     TriggerIn       EQU     P3.0            ; RxD pin (input)
                     615     
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    11

  00B6               616     SCL_I2C         EQU     P3.6
  00B4               617     SDA_I2C         EQU     P3.4
                     618     
  00B6               619     Tmpx_FREQ0      EQU     P3.6            ; FS0
  00B4               620     Tmpx_FREQ1      EQU     P3.4            ; FS1
                     621     
                     622     
                     623     ; Macros:
                     624     ;=========
                     625     
                     626     ; Macro for setting levels stored in M_CmosIn register to CMOS inputs of Medipix
                     627     SET_CmosIn      MACRO
                     628             MOV     M_port,M_CmosIn ; Send Medipix CMOS input configuration to latch
                     629             SETB    LatchEnable     ; Enable Medipix CMOS input latch
                     630             CLR     LatchEnable     ; Disable Medipix CMOS input latch
                     631             ENDM
                     632     
                     633     ; Macro openning Medipix shutter
                     634     OpenShutter     MACRO
                     635             SETB    M_M0
                     636             SETB    M_M1
                     637             SET_CmosIn              ; Set correct M0 and M1 (needed for timepix, can't be combi
                             ned with M_Shutter - it must follow)
                     638             CLR     M_Shutter       ; M_Shutter = 0 ... Shutter is open
                     639             SET_CmosIn              ; Shutter is open now
                     640             ENDM
                     641     
                     642     ; Macro closing Medipix shutter (TimePix version):
                     643     CloseShutterTPX MACRO
                     644             SETB    M_Shutter       ; M_Shutter = 1 ... Shutter is closed
                     645             SET_CmosIn              ; Close shutter now (clock generator is stopped now in case
                              of Timepix => some extra clock are needed)
                     646             MOV     SPIDAT,A        ; Write any data from ACC to SPI => This initiates clock ge
                             neration (8 clocks) - needed for Timepix
                     647             CLR     M_M0
                     648             CLR     M_M1
                     649             SET_CmosIn              ; Set correct M0 and M1 (needed for Timepix)
                     650             JNB     ISPI,$          ; Wait until whole byte is transmited by SPI => clock is qu
                             iet now
                     651             ENDM
                     652     
                     653     ; Macro closing Medipix shutter (Medipix version):
                     654     CloseShutterMPX MACRO
                     655             SETB    M_Shutter
                     656             CLR     M_M0
                     657             CLR     M_M1
                     658             SET_CmosIn              ; Close shutter
                     659             ENDM
                     660     
                     661     ; Macro openning Medipix shutter and starting Interval measurement from the zero
                     662     OpenShutterInt  MACRO
                     663             CALL    IntervalMeasure ; Starts Interval timer to measure exposition time
                     664             OpenShutter
                     665             ENDM
                     666     
                     667     ;===============================================================================
                     668     ; Begining of the code
                     669     ;===============================================================================
                     670     
                     671     
0000                 672     ORG 0000H                       ; Load Code at adress 0
0000 21C8            673             JMP     MAIN            ; Jump to MAIN program
                     674     
                     675     ;===============================================================================
                     676     ; Interrupt jump table
                     677     
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    12

0003                 678     ORG 0003H
0003 805A            679             JMP     Int_IE0         ; External interrupt 0
000B                 680     ORG 000BH
000B 01DB            681             JMP     Int_TF0         ; Timer/Counter 0 interrupt
0013                 682     ORG 0013H
0013 2107            683             JMP     Int_IE1         ; External interrupt 1
001B                 684     ORG 001BH
001B 2108            685             JMP     Int_TF1         ; Timer/Counter 1 interrupt
0023                 686     ORG 0023H
0023 212F            687             JMP     Int_RI_TI       ; Serial interrupt
002B                 688     ORG 002BH
002B 2130            689             JMP     Int_TF2_EXF2    ; Timer/Counter 2 interrupt
0033                 690     ORG 0033H
0033 01CD            691             JMP     Int_ADCI        ; ADC interupt
003B                 692     ORG 003BH
003B 212E            693             JMP     Int_ISPI_I2CI   ; SPI interrupt/I2C interrupt
0043                 694     ORG 0043H
0043 8018            695             JMP     Int_PSMI        ; Power supply monitor interrupt
0053                 696     ORG 0053H
0053 2159            697             JMP     Int_TII         ; Timer interval counter interrupt
005B                 698     ORG 005BH
005B 8001            699             JMP     Int_WDS         ; Watchdog timer interrupt
                     700     
                     701     ;===============================================================================
                     702     ; Interrupt services (sorted by priority level)
                     703     ;===============================================================================
                     704     
005D                 705     Int_PSMI:                       ; Power supply monitor interrupt - priority 1 (Highest)
005D 32              706             RETI
                     707     
005E                 708     Int_WDS:                        ; Watchdog timer interrupt - priority 2
005E 32              709             RETI
                     710     
                     711     ;-------------------------------------------------------------------------------
                     712     ; Trigger in:
                     713     
005F                 714     Int_IE0:                        ; External interrupt 0 - priority 3
                     715     
005F 20186A          716             JB      IgnoreNextTrg,TriggerVeryReturn ; This Trigger shoulfd be ignored
                     717     
0062 C0E0            718             PUSH    ACC
0064 C0D0            719             PUSH    PSW
                     720     
                     721             TriggerStop                             ; Trigger is stopped and can be restarted b
                             y TODO action
                     723     
0068 E558            724             MOV     A,TRIGGER_TODO
006A 719D            725             CALL    ProcessTODO                     ; Make tasks given by TRIGGER_TODO
                     726     
006C C0F0            727             PUSH    B
                     728     
                     729       ;Coincidence mode?
                     730       ;-----------------
006E 30E042          731             JNB     TODO_CloseShutter, NonCoincidenceMode           ; Coincidence mode is avail
                             able just if TODO_CloseShutter is in TRIGGER_TODO actions
0071 E559            732             MOV     A,TRIGGER_COINC
0073 30E03D          733             JNB     COINC_Test, NonCoincidenceMode
                     734     
                     735             ; We are working in coincidence mode: If notification is enabled raise it
0076 D2E6            736             SETB    COINC_CoincEvent                                ; This is a coincidence eve
                             nt (valid or invalid)
0078 30E208          737             JNB     COINC_Notify, CoincidenceMode                   ; If no notification is des
                             ired then continue
007B 20E405          738             JB      COINC_NotifyValidCoinc, CoincidenceMode         ; If just positive coincide
                             nces should be notified then skip notification now (generate it later)
                     739     
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    13

                     740             ; Generate notification:
007E A2E3            741             MOV     C,COINC_NotifyInitLevel                         ; Trigger out initial level
                              is restored (no change should be seen on output)
0080 B3              742             CPL     C
0081 92B1            743             MOV     TriggerOut,C                                    ; Trigger out is set
                     744     
                     745         ; Wait for coincidence flag (to be signaled on TriggerIn input = RxD):
0083                 746         CoincidenceMode:
                     747             ; MOV   B,TRIGGER_COINCDELAY                            ; Time of maximum allowed d
                             elay of TriggerIn signal
                     748             ; JNB   COINC_TestLevel, CoincTestLow
0083                 749           CoincTestHigh:
0083 20B017          750             JB      TriggerIn, CoincApproved                        ; TriggerIn is signaling th
                             e coincidence        2 cycles
0086 D5F0FA          751             DJNZ    B,CoincTestHigh                                 ; Wait 256 times           
                                                  3 cycles => 5 cycles = 250ns => max 64us
0089 8008            752             JMP     CoincRejected
008B                 753           CoincTestLow:
008B 30B00F          754             JNB     TriggerIn, CoincApproved                        ; TriggerIn is signaling th
                             e coincidence        2 cycles
008E D5F0FA          755             DJNZ    B,CoincTestLow                                  ; Wait 256 times           
                                                  3 cycles => 5 cycles = 250ns => max 64us
0091 8000            756             JMP     CoincRejected
                     757     
                     758           ; Coincidence is not recognized
0093                 759           CoincRejected:
0093 D2E7            760             SETB    COINC_InValidCoinc                              ; Invalid coincidence => ma
                             trix to be reseted
0095 30E219          761             JNB     COINC_Notify, CoincidenceModeEnd                ; If no notification is des
                             ired then goto End
0098 20E416          762             JB      COINC_NotifyValidCoinc, CoincidenceModeEnd      ; If just valid coincidence
                              should be notified then skip notification
009B 800D            763             JMP     CoincNotifPulse
                     764     
                     765           ; Coincidence is positively identified
009D                 766           CoincApproved:
009D C2E7            767             CLR     COINC_InValidCoinc                              ; Valid coincidence
009F 30E20F          768             JNB     COINC_Notify, CoincidenceModeEnd                ; If no notification is des
                             ired then goto End
00A2 30E405          769             JNB     COINC_NotifyValidCoinc, CoincNotifPulse         ; Just valid coincidences s
                             hould be notified => this is valid => notify it
00A5 A2E3            770             MOV     C,COINC_NotifyInitLevel                         ; Trigger out initial level
                              is restored (no change should be seen on output)
00A7 B3              771             CPL     C
00A8 92B1            772             MOV     TriggerOut,C                                    ; Trigger out is set
                     773     
                     774           ; If pulse mode notification is desired:
00AA                 775           CoincNotifPulse:
00AA 30E504          776             JNB     COINC_NotifyByPulse, CoincidenceModeEnd         ; If non-pulse mode is sele
                             cted for notification then goto end
00AD A2E3            777             MOV     C,COINC_NotifyInitLevel                         ; Trigger out initial level
                              is restored (no change should be seen on output)
00AF 92B1            778             MOV     TriggerOut,C                                    ; Trigger out is reset
                     779     
00B1                 780         CoincidenceModeEnd:
00B1 F559            781             MOV     TRIGGER_COINC,A                                 ; Set coincidence flags bac
                             k to register
                     782     
                     783       ;Standard non coincidence mode:
                     784       ;------------------------------
00B3                 785       NonCoincidenceMode:
00B3 C000            786             PUSH    00
                     787     
00B5 7854            788             MOV     R0,#TRIGGER_COUNT               ; Address of current counter value is in R0
00B7 75F004          789             MOV     B,#4                            ; 4 bytes of counter
00BA                 790       TriggerIncrement:
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    14

00BA 06              791             INC     @R0                             ; Increment one byte of counter
00BB E6              792             MOV     A,@R0
00BC 7004            793             JNZ     TriggerEvent                    ; If value of the byte is not zero after in
                             crement => Overflow doesn't occured
00BE 08              794             INC     R0                              ; Next counter byte has to be inctremented 
                             as well
00BF D5F0F8          795             DJNZ    B,TriggerIncrement              ; Do it 4 times at maximum
                     796     
00C2                 797       TriggerEvent:                                 ; overflow occured => service it
00C2 D202            798             SETB    Back_Trigger                    ; Set flag for Main loop
                     799     
00C4 D000            800             POP     00
00C6 D0F0            801             POP     B
00C8 D0D0            802             POP     PSW
00CA D0E0            803             POP     ACC
                     804     
00CC                 805       TriggerVeryReturn:
00CC 32              806             RETI
                     807     
                     808     ;-------------------------------------------------------------------------------
                     809     
00CD                 810     Int_ADCI:                       ; ADC interupt - priority 4
00CD C2DD            811             CLR     CCONV                           ; stop conversions
00CF 201102          812             JB      ADCused_Monitor, JustMonitor
00D2 D204            813             SETB    Back_Scope                      ; Set flag to foreground process (scope dat
                             a have to be transmited)
00D4                 814       JustMonitor:
00D4 121B95          815             CALL    ScopeSetupADC                   ; Prepare ADC for next batch
00D7 752200          816             MOV     ADCused,#0                      ; ADC is free now
00DA 32              817             RETI
                     818     
                     819     ;-------------------------------------------------------------------------------
                     820     ; Interval timer:
                     821     
00DB                 822     Int_TF0:                        ; Timer/Counter 0 interrupt - priority 5
00DB C0E0            823             PUSH    ACC
00DD C0D0            824             PUSH    PSW
00DF C000            825             PUSH    00
00E1 C0F0            826             PUSH    B
                     827     
00E3 7838            828             MOV     R0,#INTERVAL_CURR               ; Address of curent counter value is in R0
00E5 75F004          829             MOV     B,#4                            ; 4 bytes of counter
00E8                 830       IntervalIncrement:
00E8 06              831             INC     @R0                             ; Increment one byte of counter
00E9 E6              832             MOV     A,@R0
00EA 7012            833             JNZ     IntervalReturn                  ; If value of the byte is not zero after in
                             crement => Overflow doesn't occured
00EC 08              834             INC     R0                              ; Next counter byte has to be inctremented 
                             as well
00ED D5F0F8          835             DJNZ    B,IntervalIncrement             ; Do it 4 times at maximum
                     836     
00F0                 837       IntervalOverflow:                             ; Timer overflow occured => call service if
                              needed
00F0 E53D            838             MOV     A, INTERVAL_MODE
00F2 600A            839             JZ      IntervalReturn                  ; If MODE is 0 then no action have to be do
                             ne
                     840     
00F4 D200            841             SETB    Back_Interval                   ; Set flag for Main loop in the service of 
                             this flag the data are transfered if needed
                     842     
                     843             IntervalStop                            ; Interval is stoped, can be restarted by T
                             ODO action
00FA E53C            846             MOV     A,INTERVAL_TODO
00FC 719D            847             CALL    ProcessTODO                     ; Make tasks given by TODO
                     848     
00FE                 849       IntervalReturn:
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    15

00FE D0F0            850             POP     B
0100 D000            851             POP     00
0102 D0D0            852             POP     PSW
0104 D0E0            853             POP     ACC
0106 32              854             RETI
                     855     
                     856     ;-------------------------------------------------------------------------------
                     857     
0107                 858     Int_IE1:                        ; External interrupt 1 - priority 6
0107 32              859             RETI
                     860     
                     861     ;-------------------------------------------------------------------------------
                     862     ; Counter
                     863     
0108                 864     Int_TF1:                        ; Timer/Counter 1 interrupt - priority 7
0108 C0E0            865             PUSH    ACC
010A C0D0            866             PUSH    PSW
010C C000            867             PUSH    00
010E C0F0            868             PUSH    B
                     869     
0110 784F            870             MOV     R0,#COUNTER_CURR                ; Address of curent counter value is in R0
0112 75F004          871             MOV     B,#4                            ; 4 bytes of counter
0115                 872       CounterIncrement:
0115 06              873             INC     @R0                             ; Increment one byte of counter
0116 E6              874             MOV     A,@R0
0117 700C            875             JNZ     CounterReturn                   ; If value of the byte is not zero after in
                             crement => Overflow doesn't occured
0119 08              876             INC     R0                              ; Next counter byte has to be inctremented 
                             as well
011A D5F0F8          877             DJNZ    B,CounterIncrement              ; Do it 4 times at maximum
                     878     
011D                 879       CounterOverflow:                              ; Timer overflow occured => call service if
                              some exists
011D C2AB            880             CLR     ET1                             ; Disable interrupt (can be reenabled in TO
                             DO action)
011F D203            881             SETB    Back_Counter                    ; Set flag for Main loop
                     882     
0121 E553            883             MOV     A,COUNTER_TODO
0123 719D            884             CALL    ProcessTODO                     ; Make tasks given by TODO
                     885     
0125                 886       CounterReturn:
0125 D0F0            887             POP     B
0127 D000            888             POP     00
0129 D0D0            889             POP     PSW
012B D0E0            890             POP     ACC
012D 32              891             RETI
                     892     
                     893     ;-------------------------------------------------------------------------------
012E                 894     Int_ISPI_I2CI:                  ; SPI interrupt/I2C interrupt - priority 8
012E 32              895             RETI
                     896     
012F                 897     Int_RI_TI:                      ; Serial interrupt - priority 9
012F 32              898             RETI
                     899     
                     900     ;-------------------------------------------------------------------------------
                     901     ; Period timer:
                     902     
0130                 903     Int_TF2_EXF2:                   ; Timer/Counter 2 interrupt - priority 10
                     904     
0130 C2CF            905             CLR     TF2             ; Clear the interrupt flag
                     906     
0132 C0E0            907             PUSH    ACC
0134 C0D0            908             PUSH    PSW
0136 C000            909             PUSH    00
0138 C0F0            910             PUSH    B
                     911     
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    16

013A 7844            912             MOV     R0,#PERIOD_CURR                 ; Address of curent counter value is in R0
013C 75F004          913             MOV     B,#4                            ; 4 bytes of counter
013F                 914       PeriodIncrement:
013F 06              915             INC     @R0                             ; Increment one byte of counter
0140 E6              916             MOV     A,@R0
0141 700D            917             JNZ     PeriodReturn                    ; If value of the byte is not zero after in
                             crement => Overflow doesn't occured
0143 08              918             INC     R0                              ; Next counter byte has to be inctremented 
                             as well
0144 D5F0F8          919             DJNZ    B,PeriodIncrement               ; Do it 4 times at maximum
                     920     
0147                 921       PeriodOverflow:                               ; Timer overflow occured => call service if
                              some exists
0147 1218C1          922             CALL    PeriodRestart                   ; PERIOD_CURR is refilled
                     923     
014A D201            924             SETB    Back_Period                     ; Set flag for Main loop
                     925     
014C E548            926             MOV     A,PERIOD_TODO
014E 719D            927             CALL    ProcessTODO                     ; Make tasks given by TODO
                     928     
0150                 929       PeriodReturn:
0150 D0F0            930             POP     B
0152 D000            931             POP     00
0154 D0D0            932             POP     PSW
0156 D0E0            933             POP     ACC
0158 32              934             RETI
                     935     
                     936     ;-------------------------------------------------------------------------------
                     937     
0159                 938     Int_TII:                        ; Timer interval counter interrupt - priority 11 (Lowest)
0159 32              939             RETI
                     940     
                     941     
                     942     ;===============================================================================
                     943     ; Utilities:
                     944     
                     945     ;Closing Medipix shutter        - In past this was realized by MACRO but due to support of
                     946                                     ; TimePix it has to be changed
015A                 947     CloseShutter:
015A C0E0            948             PUSH    ACC
015C E531            949             MOV     A,MPX_ISMXR
015E 20E710          950             JB      ACC.7,CloseShutterTimepix       ; It is Timepix => Optimized version of Wai
                             tForCommand
                     951     
                     952             CloseShutterMPX
                     956+1           SET_CmosIn              ; Close shutter
016E D0E0            960             POP     ACC
0170 22              961             RET
                     962     
0171                 963         CloseShutterTimepix:
                     964             CloseShutterTPX
                     966+1           SET_CmosIn              ; Close shutter now (clock generator is stopped now in case
                              of Timepix => some extra clock are needed)
                     973+1           SET_CmosIn              ; Set correct M0 and M1 (needed for Timepix)
018A D0E0            978             POP     ACC
018C 22              979             RET
                     980     
                     981     ; Closing Medipix shutter and stoping Interval measurement
018D                 982     CloseShutterInt:
018D C0E0            983             PUSH    ACC
018F E531            984             MOV     A,MPX_ISMXR
0191 20E714          985             JB      ACC.7,CloseShutterIntTimepix    ; It is Timepix => Optimized version of Wai
                             tForCommand
                     986     
                     987             IntervalStop            ; Stops Interval timer - now it contains time of exposition
                     990             CloseShutterMPX
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    17

                     994+1           SET_CmosIn              ; Close shutter
01A5 D0E0            998             POP     ACC
01A7 22              999             RET
                    1000     
01A8                1001         CloseShutterIntTimepix:
                    1002             IntervalStop            ; Stops Interval timer - now it contains time of exposition
                    1005             CloseShutterTPX
                    1007+1           SET_CmosIn              ; Close shutter now (clock generator is stopped now in case
                              of Timepix => some extra clock are needed)
                    1014+1           SET_CmosIn              ; Set correct M0 and M1 (needed for Timepix)
01C5 D0E0           1019             POP     ACC
01C7 22             1020             RET
                    1021     
                    1022     ;###############################################################################
                    1023     ;###############################################################################
                    1024     ;###############                                                ################
                    1025     ;###############            Main program: Initialization        ################
                    1026     ;###############                                                ################
                    1027     ;###############################################################################
                    1028     ;###############################################################################
                    1029     
01C8                1030     MAIN:
                    1031             ;JMP    $                               ;
                    1032     
                    1033     ; Global settings
01C8 C2AF           1034             CLR     EA                              ; Disable all interrupts
01CA 75817F         1035             MOV     SP,#127                         ; Set the top of the stack (stack begin at 
                             adress 128)
01CD 75D700         1036             MOV     PLLCON,#00h                     ; Core clock divider = 0, Set the highest c
                             lock frequency 20MHz
01D0 43AF01         1037             ORL     CFG841,#01h                     ; Map internal X-RAM into lower 2kB of exte
                             rnal adress space
                    1038     
                    1039     ; Configure SPI
01D3 75F834         1040             MOV     SPICON,#SPI_CONFIG_MPX          ; SPI is enabled in Master Mode (I2C is ena
                             bled), CPOL=0, CPHA=1, frequency Fosc/N
                    1041     
                    1042     ; Configure Timer T0 (used for Interval):
01D6 C28C           1043             CLR     TR0                             ; Timer 0 is turned OFF
                    1044             ;MOV    TMOD,#00100010h                 ; Both timers (0 and 1) are configured in M
                             ode 1 (16bit timer), gating is disabled
                    1045     ;       CALL    IntervalDefault                 ; Clears variables of Interval timer
                    1046     
                    1047     ; Configure UART
01D8 759850         1048             MOV SCON,#50h
01DB 438920         1049             ORL TMOD,#20h
01DE 758BFD         1050             MOV TL1, #0FDh
01E1 758DFD         1051             MOV TH1,#0FDh
                    1052             
                    1053             ;MOV   SCON,#01010010B
                    1054             
                    1055             ;SET_SMOD equ 80h ; or mask 
                    1056             ;CLR_SMOD equ 7Fh ; and mask 
                    1057             ;orl PCON,#SET_SMOD ; set SMOD to '1' 
                    1058     
01E4 D28E           1059             SETB    TR1
01E6 D2AF           1060             SETB    EA
01E8 D2AC           1061             SETB    ES
                    1062             ;MOV   SCON,#01000000B
                    1063             ;MOV   SCON,#00010010B
                    1064     
                    1065     ; Configure Timer T1 (used for Counter):f
                    1066                             ; Timer 1 is turned OFF 
                    1067             ;ORL    TMOD,#00100000b
                    1068             ;ORL    TMOD,#40h                       ; T1 is counter now
                    1069             ;CALL    CounterDefault                         ; Clears variables of the counter
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    18

                    1070     
                    1071     ; Configure Timer T2 (used for Period):
01EA 75C800         1072             MOV     T2CON,#00h                      ; T2 is timer now (turned off)
01ED 75CA00         1073             MOV     RCAP2L,#00h
01F0 75CB00         1074             MOV     RCAP2H,#00h                     ; Autoreload by zero => no autoreload
01F3 121886         1075             CALL    PeriodDefault                   ; Clears variables of the period
                    1076     
                    1077     ; External Interrupt INT0 (used for Trigger):
01F6 C2A8           1078             CLR     EX0                             ; Disable interrupt from INT0
01F8 D288           1079             SETB    IT0                             ; INT0 is edge sensitive 1->0 edge will cau
                             se the interrupt
01FA D2B8           1080             SETB    PX0                             ; Interupt priority: high
01FC 12196B         1081             CALL    TriggerDefault
                    1082     
                    1083     ; DACs:
01FF 75FD1F         1084             MOV     DACCON,#01Fh                    ; 12bit, Range 0-2.5V, No Clear, No Sync, P
                             ower ON
                    1085     
                    1086     ; Initialize registers and memories:
0202 752000         1087             MOV     Background,#0                   ; None of background processes wants to out
                             put data
0205 752200         1088             MOV     ADCused,#0                      ; ADC is not used
0208 752300         1089             MOV     OFlags,#0                       ; No other flag
020B 756765         1090             MOV     TODO_Command1,#'e'              ; Default TODO command1 is Erase matrix
020E 75683D         1091             MOV     TODO_Command2,#'='              ; Default TODO command2 is Periodic erase a
                             nd wait for trigger
0211 121A03         1092             CALL    FrameCounterDefault             ; Initialize frame counter to its default s
                             tate
0214 121C00         1093             CALL    MonitorSetup                    ; Initialize Monitor XRAM buffer
0217 121AF8         1094             CALL    ScopeSetDefaults                ; Initialize Scope XRAM buffer
                    1095     
                    1096     ;-------------------------------------------------------------------------------
                    1097     ; Medipix default configuration and watchdog test:
                    1098     
021A 121D62         1099             CALL    FT_ClearFIFO                    ; EMpty FTDI FIFO to discard some old messa
                             ges
                    1100     
021D 30C208         1101             JNB     WDS,NormalReset                 ; If not watchdog alert then continue to No
                             rmalReset
                    1102     
0220                1103         ResetByWatchdog:
0220 9006DB         1104             MOV     DPTR,#Watchdog_Alert            ; Send Watchdog Alert message
0223 121D70         1105             CALL    FT_SendString
0226 8037           1106             JMP     WatchdogConfig                  ; Skip normal Medipix cinfiguration in case
                              of reset by Watchdog
                    1107     
0228                1108         NormalReset:
0228 9005F8         1109             MOV     DPTR,#Str_Online                ; Send OnLine Message
022B 121D70         1110             CALL    FT_SendString
                    1111     
                    1112             ;CALL   ComServ_Info
                    1113     
022E                1114         InitMedipix:
                    1115             ; Timepix defaults:
022E C2B6           1116             CLR     Tmpx_FREQ0                      ; P3.6
0230 D2B4           1117             SETB    Tmpx_FREQ1                      ; P3.4  => Lowest frequency = 10MHz (option
                             s are: 10, 20, 40, 80)
                    1118     
0232 120D77         1119             CALL    ComServ_ResetBias               ; Reset bias
0235 120D39         1120             CALL    ComServ_DCswitchON              ; Switch on medipix power supply
0238 121D2E         1121             CALL    WaitQuarter                     ; Wait quarter of second to power stabilisa
                             tion
023B 1208C4         1122             CALL    ComServ_ResetToDefault          ; Medipix reset and default settings of its
                              CMOS inputs
                    1123     
023E 120B75         1124             CALL    GetChipboardTypeAndIDSilent     ; Determine type of the chipboard connected
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    19

                              (According to chipID - not very reliable)
                    1125             ;CALL   NotifyChipboardType             ; Send information concerning chip type and
                              count
                    1126             ;CALL   NotifyNumberOfChips             ; Sends notification with number of chips
                    1127     
0241 120D3C         1128             CALL    ComServ_DCswitchOFF             ; Switch off medipix power supply
0244 121D2E         1129             CALL    WaitQuarter                     ; Wait quarter of second to power stabilisa
                             tion
0247 120D39         1130             CALL    ComServ_DCswitchON              ; Switch on medipix power supply
024A 121D2E         1131             CALL    WaitQuarter                     ; Wait quarter of second to power stabilisa
                             tion
                    1132     
024D 1208C4         1133             CALL    ComServ_ResetToDefault          ; Medipix reset and default settings of its
                              CMOS inputs
0250 1208DA         1134             CALL    ComServ_SetMatrixDefault        ; Sets default mask
0253 120BF4         1135             CALL    NotifyChipboardType             ; Send information concerning chip type and
                              count
0256 12094F         1136             CALL    NotifyNumberOfChips             ; Sends notification with number of chips
                    1137     
0259 90060B         1138             MOV     DPTR,#Str_ReadySpc
025C 121D70         1139             CALL    FT_SendString                   ; Sends READY message
                    1140     
                    1141     ;-------------------------------------------------------------------------------
                    1142     ; Configure Watchdog timer
                    1143                             ; Enable Watchdog timer to cause
                    1144                             ; - 2.0 second timeout period
                    1145                             ; - enable WDIR bit to generate
                    1146                             ;   a reset and not an interrupt
025F                1147     WatchdogConfig:
                    1148     
                    1149             StartWatchdog   ; Done by macro
0264 75F000         1152             MOV     B,#0
                    1153     
                    1154             ; If Timepix is connected then Optimized version of WaitForCommand loop is used:
0267 E531           1155             MOV     A,MPX_ISMXR
0269 20E700         1156             JB      ACC.7, WaitForCommand      ; It is Timepix => Optimized version of WaitForC
                             ommand
                    1157     
                    1158     
                    1159     ;===============================================================================
                    1160     ; Main Endless loop - waits for command character received via USB
                    1161     ;===============================================================================
                    1162     
026C                1163     WaitForCommand:         ; WaitForCommand is Main program loop
                    1164                             ; It is periodically checking flags from background processes
                    1165                             ; as well as command received from USB
                    1166                             ; Refreshes watchdog timer.
                    1167     
                    1168             ; Refresh watchdog timer
026C D5F008         1169             DJNZ    B,DontRefreshNow
                    1170             RefreshWatchdog
                    1172+1           RefreshWatchdogBase
                    1176     
0277                1177          DontRefreshNow:
                    1178             ; Check Background processes:
0277 C0F0           1179             PUSH    B
0279 7131           1180             CALL    CheckBackground                         ; Checks whether some of background
                              processes wants to output data
                    1181     
                    1182             ; Check commands received form host PC:
027B 121D57         1183             CALL    FT_CheckChar                            ; Checks whether the character has 
                             been received by FTDI, sets CY if no
027E D0F0           1184             POP     B
0280 40EA           1185             JC      WaitForCommand                          ; No command has been received
                    1186     
0282                1187          CommandReceived:
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    20

0282 51CD           1188             CALL    ProcessCommand                          ; Call process command procedure
0284 75F000         1189             MOV     B,#0
0287 80E3           1190             JMP     WaitForCommand                          ; Wait for next command
                    1191     
                    1192     
                    1193     ; Optimized version - for timepix clock generation
                    1194     ; Clock signal is generated by SPI interface just if shutter is opened
                    1195     ; With fastest setting it generates 8 periods with 10MHz in 16 cycles
                    1196     
0289                1197     WaitForCommandOptim:                            ; Cycles/Sum
0289 75F834         1198             MOV     SPICON,#SPI_CONFIG_CLOCK
                    1199     
028C                1200       WaitForCommandOptimLoop:
                    1201             ; If shutter is open then generate 8 clocks by SPI interface:
028C 200F02         1202             JB      M_Shutter,WFCO_ShutterClosed1   ; 4   7 ; 0 = Shutter is opened, 1 = Shutte
                             r is closed
028F F5F7           1203             MOV     SPIDAT,A                        ; 1  12 ; Write any data from ACC to SPI =>
                              This initiates the transmission and clock generation
0291                1204             WFCO_ShutterClosed1:                            ; There is time for next 16 cycles 
                             but next initialization will take 5 cycles =>
                    1205                                                             ; => time for 11 cycles
0291                1206       CheckBackgroundProc:
0291 E520           1207             MOV     A,Background                    ; 1   1 ; Register of flags from background
                              processes
0293 6005           1208             JZ      CheckFTDICommand                ; 3   4 ; Checks whether some of background
                              processes wants to output data, if not => jump
0295 7131           1209             CALL    CheckBackground
0297 75F834         1210             MOV     SPICON,#SPI_CONFIG_CLOCK        ; 1   1 ; SPI is enabled in Master Mode (I2
                             C is enabled), CPOL=0, CPHA=1, frequency Fosc/2
                    1211     
029A                1212       CheckFTDICommand:
                    1213             ;JB     FT_RxF,MakeWathchdogRefresh     ; 4   8 ; Check if FTDI is ready to be read
                              (if not ready then jump)
029A 20980C         1214             JB      RI,MakeWathchdogRefresh
029D 121D5C         1215             CALL    FT_TakeChar                             ; Takes a command to A
02A0 D0F0           1216             POP     B
02A2 40E5           1217             JC      WaitForCommandOptim
02A4 51CD           1218             CALL    ProcessCommand                          ; Process command in A
02A6 75F834         1219             MOV     SPICON,#SPI_CONFIG_CLOCK        ; 1   1 ; SPI is enabled in Master Mode (I2
                             C is enabled), CPOL=0, CPHA=1, frequency Fosc/2
                    1220     
02A9                1221       MakeWathchdogRefresh:
                    1222             ; If shutter is open then generate 8 clocks by SPI interface:
02A9 200F0E         1223             JB      M_Shutter,MakeRefreshWatchdog   ; 4  12 ; 0 = Shutter is opened, 1 = Shutte
                             r is closed
02AC F5F7           1224             MOV     SPIDAT,A                        ; 1  17 ; Write any data from ACC to SPI =>
                              This initiates the transmission and clock generation
                    1225     
                    1226             RefreshWatchdog                         ; 8   8 ; Watchdog reset done by macro
                    1228+1           RefreshWatchdogBase
                    1232     
                    1233             ; The shutter is open => generate 8 clocks by SPI interface:
02B6 F5F7           1234             MOV     SPIDAT,A                        ; 1  17 ; Write any data from ACC to SPI =>
                              This initiates the transmission and clock generation
02B8 80D2           1235             JMP     WaitForCommandOptimLoop         ; 3   3 ; Go to begining of the loop
                    1236     
02BA                1237       MakeRefreshWatchdog:
                    1238             RefreshWatchdog                         ; 8   8 ; Watchdog reset done by macro
                    1240+1           RefreshWatchdogBase
02C2 80C8           1244             JMP     WaitForCommandOptimLoop         ; 3   3 ; Go to begining of the loop
                    1245     
02C4                1246       JustRefreshWatchdog:
                    1247             RefreshWatchdog
                    1249+1           RefreshWatchdogBase
02CC 22             1253             RET
                    1254     
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    21

                    1255     ;-------------------------------------------------------------------------------
                    1256     
02CD                1257     ProcessCommand:         ; ProcessCommand will search the Com_Table for command A
                    1258                             ; if it is found it will be called else error message will be trans
                             mitted.
                    1259                             ; Service call is preceeded with command character transmission and
                    1260                             ; followed by OK/Error message transmission.
                    1261     
                    1262             ; Refresh watchdog timer before command processing:
                    1263             RefreshWatchdog
                    1265+1           RefreshWatchdogBase
                    1269     
02D5 F5F0           1270             MOV     B,A                                     ; Store received command in B
02D7 758400         1271             MOV     DPP,#0
02DA 900513         1272             MOV     DPTR,#Com_Table                         ; DPTR points to Command table
                    1273     
02DD                1274       TestItem:
                    1275             ; Compare current table item with zero (end of the table) or with received command
02DD E4             1276             CLR     A
02DE 93             1277             MOVC    A,@A+DPTR                               ; Read a command from the table
02DF A3             1278             INC     DPTR                                    ; Points to command service routine
                              adress
02E0 6035           1279             JZ      UnknownCom                              ; End of table => go to UnknownCom
02E2 B5F02E         1280             CJNE    A,B,NextItem                            ; This is not just received command
                    1281     
                    1282             ; This is the command => after command code there is address of the command service
02E5 E4             1283             CLR     A
02E6 93             1284             MOVC    A,@A+DPTR                               ; Read lower half of command servic
                             e address
02E7 F9             1285             MOV     R1,A
02E8 A3             1286             INC     DPTR
02E9 E4             1287             CLR     A
02EA 93             1288             MOVC    A,@A+DPTR                               ; Read upper half of command servic
                             e address
02EB F8             1289             MOV     R0,A                                    ; R1R0 contains address of the comm
                             and service
                    1290     
                    1291             ; Send an echo:
02EC E5F0           1292             MOV     A,B
02EE 121D3F         1293             CALL    FT_SendChar                             ; Echoes received command
                    1294     
                    1295             ; Store return address on the stack and call service:
02F1 9002FE         1296             MOV     DPTR,#EndOfCommand
02F4 C082           1297             PUSH    DPL
02F6 C083           1298             PUSH    DPH                                     ; Address of the EndOfCommand is st
                             ored in the stack (return address from command service routine)
02F8 C000           1299             PUSH    00
02FA C001           1300             PUSH    01                                      ; Address of the command service ro
                             utine is in the stack
02FC C3             1301             CLR     C                                       ; Clear the CY flag (CY=1 after ser
                             vice call indicates an error)
02FD 22             1302             RET                                             ; Jump to service, service has to e
                             nd with RET instruction to jump to EndOfCommand
                    1303     
02FE                1304       EndOfCommand:
                    1305             ; Command service finished - check its output:
                    1306             ; if CY=0 then OK message has to be transmited,
                    1307             ; if CY=1 then message pointed by dptr (if not zero) has to be transmited
                    1308     
02FE 758400         1309             MOV     DPP,#0          ; Message is in built in EEROM
0301 4008           1310             JC      ErrorOccured
0303 900613         1311             MOV     DPTR,#Str_OK    ; Send OK message
0306                1312         SendReport:
0306 121D70         1313             CALL    FT_SendString
0309 801D           1314             JMP     EndOfProcessCommand                     ; Command processing finished => en
                             d
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    22

                    1315     
030B                1316         ErrorOccured:
030B E583           1317             MOV     A,DPH
030D 4582           1318             ORL     A,DPL
030F 70F5           1319             JNZ     SendReport                              ; Pointer to error message is in dp
                             tr => just send it
0311 8015           1320             JMP     EndOfProcessCommand                     ; Command service reported an Error
                              itself => no other message form here, finished
                    1321     
0313                1322       NextItem:
0313 A3             1323             INC     DPTR                                    ; Skip the first part of the comman
                             d service routine address
0314 A3             1324             INC     DPTR                                    ; Skip the second part of the comma
                             nd service routine address
0315 80C6           1325             JMP     TestItem                                ; Check next table item
                    1326     
0317                1327       UnknownCom:
0317 9006EC         1328             MOV     DPTR,#STR_UnknownComBeg
031A 121D70         1329             CALL    FT_SendString
031D E5F0           1330             MOV     A,B                                     ; Received unknown command is in A
031F 121D3F         1331             CALL    FT_SendChar
0322 900700         1332             MOV     DPTR,#STR_UnknownComEnd
0325 121D70         1333             CALL    FT_SendString
                    1334     
0328                1335       EndOfProcessCommand:
                    1336             ; Refresh watchdog timer after command processing:
                    1337             RefreshWatchdog
                    1339+1           RefreshWatchdogBase
0330 22             1343             RET
                    1344     
                    1345     ;-------------------------------------------------------------------------------
                    1346     
0331                1347     CheckBackground:        ; Check Background processes
                    1348                             ; For each not zero flag in Background register appropriate action 
                             is taken
                    1349     
0331 E520           1350             MOV     A,Background            ; Register of flags from background processes
0333 7009           1351             JNZ     CheckBackgroundBody     ; Checks whether some of background processes wants
                              to output data, if not => return
0335 22             1352             RET
                    1353     
                    1354             ; Refresh watchdog timer before background processing:
                    1355             RefreshWatchdog
                    1357+1           RefreshWatchdogBase
                    1361     
033E                1362       CheckBackgroundBody:
033E 745B           1363             MOV     A,#'['
0340 121D3F         1364             CALL    FT_SendChar     ; Send '[' character to identify message from background pr
                             ocess
                    1365     
                    1366             ; Just for debugging: Send text message with background register
                    1367             ;MOV    A,#'"'
                    1368             ;CALL   FT_SendChar     ; Send '"' character to identify text message
                    1369             ;MOV    A,Background    ; Register of flags from background processes
                    1370             ;CALL   FT_SendChar     ; Send background register content
                    1371             ;MOV    A,#'"'
                    1372             ;CALL   FT_SendChar     ; Send '"' character to identify text message
                    1373             ;MOV    A,#0dh
                    1374             ;CALL   FT_SendChar     ; Send CR character to identify end of text message
                    1375     
0343                1376         CheckBack_Interval:
0343 300004         1377             JNB     Back_Interval, CheckBack_Period
0346 C200           1378             CLR     Back_Interval                           ; Clear Interval flag
0348 9125           1379             CALL    BackServ_Interval                       ; Service of Interval call
                    1380     
034A                1381         CheckBack_Period:
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    23

034A 300104         1382             JNB     Back_Period, CheckBack_Trigger
034D C201           1383             CLR     Back_Period                             ; Clear Period flag
034F 912C           1384             CALL    BackServ_Period                         ; Service of Period call
                    1385     
0351                1386         CheckBack_Trigger:
0351 300204         1387             JNB     Back_Trigger, CheckBack_Counter
0354 C202           1388             CLR     Back_Trigger                            ; Clear trigger flag
0356 9133           1389             CALL    BackServ_Trigger                        ; Service of Trigger call
                    1390     
0358                1391         CheckBack_Counter:
0358 300304         1392             JNB     Back_Counter, CheckBack_Scope
035B C203           1393             CLR     Back_Counter                            ; Clear counter flag
035D 9150           1394             CALL    BackServ_Counter                        ; Service of Counter call
                    1395     
035F                1396         CheckBack_Scope:
035F 300404         1397             JNB     Back_Scope, CheckBack_ReadMatrix
0362 C204           1398             CLR     Back_Scope                              ; Clear scope flag
0364 9157           1399             CALL    BackServ_Scope                          ; Service of Counter call
                    1400     
0366                1401         CheckBack_ReadMatrix:
0366 300504         1402             JNB     Back_ReadMatrix, CheckBack_Command1
0369 C205           1403             CLR     Back_ReadMatrix
036B 9168           1404             CALL    BackServ_ReadMatrix
                    1405     
036D                1406         CheckBack_Command1:
036D 30060E         1407             JNB     Back_ToDoCom1, CheckBack_Command2
0370 C206           1408             CLR     Back_ToDoCom1                           ; Clear ToDoCom1 flag
0372 9007FE         1409             MOV     DPTR,#Str_Command2                      ; Send OK message
0375 121D70         1410             CALL    FT_SendString
0378 E567           1411             MOV     A,TODO_Command1
037A 6002           1412             JZ      CheckBack_Command2
037C 51CD           1413             CALL    ProcessCommand                          ; Call processing of TODO_Command1
                    1414     
037E                1415         CheckBack_Command2:
037E 30070E         1416             JNB     Back_ToDoCom2, CheckBackFinished
0381 C207           1417             CLR     Back_ToDoCom2                           ; Clear ToDoCom2 flag
0383 9007FE         1418             MOV     DPTR,#Str_Command2                      ; Send message
0386 121D70         1419             CALL    FT_SendString
0389 E568           1420             MOV     A,TODO_Command2
038B 6002           1421             JZ      CheckBackFinished
038D 51CD           1422             CALL    ProcessCommand                          ; Call processing of TODO_Command2
                    1423     
038F                1424         CheckBackFinished:
038F 745D           1425             MOV     A,#']'
0391 121D3F         1426             CALL    FT_SendChar                             ; Send ']' character to identify en
                             d of background messages
                    1427     
0394                1428       ChkBackReturn:
                    1429             ; Refresh watchdog timer after background processing:
                    1430             RefreshWatchdog
                    1432+1           RefreshWatchdogBase
039C 22             1436             RET
                    1437     
                    1438     ;-------------------------------------------------------------------------------
                    1439     
039D                1440     ProcessTODO:            ; Calls procedures given by TODO mask stored in A
                    1441                             ; Called from various interrupts.
                    1442                             ; Changes just PSW and ACC
                    1443     
                    1444     ;       JNZ     TDStartScope
                    1445     ;       RET
                    1446     
039D                1447       TDStartScope:
                    1448       ;---------------
039D 30E31A         1449             JNB     TODO_StartScope, TDStartScopeEnd
                    1450             ; Skipping this event if previous was not processed yet (Scope is not finished)
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    24

03A0 201917         1451             JB      ScopeTgrDisabled, TDStartScopeEnd
                    1452     ;       JB      Back_Trigger, TDStartScopeEnd
                    1453     
03A3 C0E0           1454             PUSH    ACC
03A5 E55B           1455             MOV     A,DELAY_TODOWHEN                        ; Should be delay inserted?
03A7 30E303         1456             JNB     TODO_StartScope,TDStartScopeMake
03AA 121ABB         1457             CALL    MakeDelayNotPushA                       ; Delay
03AD                1458         TDStartScopeMake:
                    1459             ScopeStart
03B8 D0E0           1465             POP     ACC
03BA                1466         TDStartScopeEnd:
                    1467     
03BA                1468       TDCloseShutter:
                    1469       ;---------------
03BA 30E010         1470             JNB     TODO_CloseShutter, TDCloseShutterEnd
03BD C0E0           1471             PUSH    ACC
03BF E55B           1472             MOV     A,DELAY_TODOWHEN                        ; Should be delay inserted?
03C1 30E003         1473             JNB     TODO_CloseShutter,TDCloseShutterMake
03C4 121ABB         1474             CALL    MakeDelayNotPushA                       ; Delay
03C7                1475         TDCloseShutterMake:
03C7 D0E0           1476             POP     ACC
03C9 318D           1477             call    CloseShutterInt
03CB D205           1478             SETB    Back_ReadMatrix                         ; Everytime when shutter is closed 
                             in interrupt the data transfer is initiated
03CD                1479         TDCloseShutterEnd:
                    1480     
03CD                1481       TDOpenShutter:
                    1482       ;---------------
03CD 30E126         1483             JNB     TODO_OpenShutter, TDOpenShutterEnd
03D0 C0E0           1484             PUSH    ACC
03D2 E55B           1485             MOV     A,DELAY_TODOWHEN                        ; Should be delay inserted?
03D4 30E103         1486             JNB     TODO_OpenShutter,TDOpenShutterMake
03D7 121ABB         1487             CALL    MakeDelayNotPushA                       ; Delay
03DA                1488         TDOpenShutterMake:
03DA D0E0           1489             POP     ACC
03DC 20E203         1490             JB      TODO_StartInterval,TDOpenShutterNoInt   ; If also interval has to be starte
                             d then it is not measured:
03DF 1216CB         1491             CALL    IntervalMeasure
03E2                1492         TDOpenShutterNoInt:
                    1493             OpenShutter
                    1496+1           SET_CmosIn              ; Set correct M0 and M1 (needed for timepix, can't be combi
                             ned with M_Shutter - it must follow)
                    1501+1           SET_CmosIn              ; Shutter is open now
03F6                1505         TDOpenShutterEnd:
                    1506     
03F6                1507       TDStartInterval:
                    1508       ;---------------
03F6 30E20F         1509             JNB     TODO_StartInterval, TDStartIntervalEnd
03F9 C0E0           1510             PUSH    ACC
03FB E55B           1511             MOV     A,DELAY_TODOWHEN                        ; Should be delay inserted?
03FD 30E203         1512             JNB     TODO_StartInterval,TDStartIntervalMake
0400 121ABB         1513             CALL    MakeDelayNotPushA                       ; Delay
0403                1514         TDStartIntervalMake:
0403 D0E0           1515             POP     ACC
0405 1216E8         1516             CALL    IntervalRestart
0408                1517         TDStartIntervalEnd:
                    1518     
0408                1519       TDStartTrigger:
                    1520       ;---------------
0408 30E40F         1521             JNB     TODO_StartTrigger, TDStartTriggerEnd
040B C0E0           1522             PUSH    ACC
040D E55B           1523             MOV     A,DELAY_TODOWHEN                        ; Should be delay inserted?
040F 30E403         1524             JNB     TODO_StartTrigger,TDStartTriggerMake
0412 121ABB         1525             CALL    MakeDelayNotPushA                       ; Delay
0415                1526         TDStartTriggerMake:
0415 D0E0           1527             POP     ACC
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    25

0417 1219AC         1528             CALL    TriggerRestart
041A                1529         TDStartTriggerEnd:
                    1530     
                    1531     ;  TDstartCounter:
                    1532       ;---------------
                    1533     ;       JNB     TODO_StartCounter,TDstartCounterEnd
                    1534     ;       PUSH    ACC
                    1535     ;       MOV     A,DELAY_TODOWHEN                        ; Should be delay inserted?
                    1536     ;       JNB     TODO_StartCounter,TDStartCounterMake
                    1537     ;       CALL    MakeDelayNotPushA                       ; Delay
                    1538     ;    TDStartCounterMake:
                    1539     ;       POP     ACC
                    1540     ;       CALL    CounterRestart
                    1541     ;    TDstartCounterEnd:
                    1542     
041A                1543       TDMakeCommand1:
                    1544       ;---------------
041A 30E602         1545             JNB     TODO_MakeCommand1, TDMakeCommand1End
041D D206           1546             SETB    Back_ToDoCom1                           ; TODO command is postponed to be e
                             xecuted in the main loop
041F                1547         TDMakeCommand1End:
                    1548     
041F                1549       TDMakeCommand2:
                    1550       ;---------------
041F 30E702         1551             JNB     TODO_MakeCommand2, TDMakeCommand2End
0422 D207           1552             SETB    Back_ToDoCom2                           ; TODO command is postponed to be e
                             xecuted in the main loop
0424                1553         TDMakeCommand2End:
                    1554     
0424                1555       TDReturn:
0424 22             1556             RET
                    1557     
                    1558     ;===============================================================================
                    1559     ; Background flags processes services:
                    1560     ;===============================================================================
                    1561     
0425                1562     BackServ_Interval:      ; Service of Interval process
                    1563     
0425 900774         1564             MOV     DPTR,#Str_IntervalFinished
0428 121D70         1565             CALL    FT_SendString
042B 22             1566             RET
                    1567     ;-------------------------------------------------------------------------------
                    1568     
042C                1569     BackServ_Period:        ; Service of Period process
                    1570     
042C 900789         1571             MOV     DPTR,#Str_PeriodFinished
042F 121D70         1572             CALL    FT_SendString
0432 22             1573             RET
                    1574     
                    1575     ;-------------------------------------------------------------------------------
                    1576     
0433                1577     BackServ_Trigger:       ; Service of Trigger process
                    1578     
0433 9007B2         1579             MOV     DPTR,#Str_TriggerFinished
0436 121D70         1580             CALL    FT_SendString
0439 E559           1581             MOV     A,TRIGGER_COINC
043B 20E601         1582             JB      COINC_CoincEvent,BackServTriggerCoinc
043E 22             1583             RET
                    1584     
043F                1585       BackServTriggerCoinc:
043F 20E707         1586             JB      COINC_InValidCoinc,BackServTriggerInvCoinc
0442                1587         BackServTriggerValCoinc:
0442 9007C6         1588             MOV     DPTR,#Str_CoincidenceEventValid
0445 121D70         1589             CALL    FT_SendString
0448 22             1590             RET
0449                1591         BackServTriggerInvCoinc:
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    26

0449 9007DB         1592             MOV     DPTR,#Str_CoincidenceEventInValid
044C 121D70         1593             CALL    FT_SendString
044F 22             1594             RET
                    1595     
                    1596     ;-------------------------------------------------------------------------------
                    1597     
0450                1598     BackServ_Counter:       ; Service of Counter process
                    1599     
0450 90079C         1600             MOV     DPTR,#Str_CounterFinished
0453 121D70         1601             CALL    FT_SendString
0456 22             1602             RET
                    1603     
                    1604     ;-------------------------------------------------------------------------------
                    1605     
0457                1606     BackServ_Scope:         ; Service of Scope process
                    1607                             ; Transmits scope data
                    1608                             ; Clears Back_Scope flag.
                    1609     
0457 7424           1610             MOV     A,#'$'
0459 121D3F         1611             CALL    FT_SendChar
045C 121BB9         1612             CALL    ScopeSendData
045F 900613         1613             MOV     DPTR,#Str_OK
0462 121D70         1614             CALL    FT_SendString
0465 C219           1615             CLR     ScopeTgrDisabled                ; Scope action finished
0467 22             1616             RET
                    1617     
                    1618     ;-------------------------------------------------------------------------------
                    1619     
0468                1620     BackServ_ReadMatrix:    ; Service of any process which will set the Back_ReadMatrix flag
                    1621                             ; Transmits matrix data
                    1622     
0468 318D           1623             call    CloseShutterInt                 ; Close the shutter and interval (just to b
                             e sure as it is probably already stopped)
                    1624     
                    1625       ; If Scope is measuring wait for end of measurement:
046A                1626       WaitForScope:
046A E522           1627             MOV     A,ADCused                       ; is ADC free?
046C 70FC           1628             JNZ     WaitForScope
                    1629     
                    1630       ; If Coincidence mode is set and a not valid coincidence is detected then just reset the 
                             matrix
046E                1631       ReadoutOrResetMatrix:
046E E559           1632             MOV     A,TRIGGER_COINC
0470 30E646         1633             JNB     COINC_CoincEvent,ReadOutAndSendMatrix           ; Is it coincidence event?
0473 30E743         1634             JNB     COINC_InValidCoinc,ReadOutAndSendMatrix         ; Is it valid coincidence?
                    1635     
                    1636       ; Bad coincidence detected => Matrix has to be reseted
                    1637       ; Waiting for a next trigger is started:
0476                1638       ResetMatrixNotifyAndContinue:
0476 7425           1639             MOV     A,#'%'
0478 121D3F         1640             CALL    FT_SendChar                     ; Send command prefix
047B 1217E4         1641             CALL    IntervalElapsedTime             ; Live time is notified
047E 900613         1642             MOV     DPTR,#Str_OK                    ; Send OK string
0481 121D70         1643             CALL    FT_SendString
0484 7465           1644             MOV     A,#'e'
0486 121D3F         1645             CALL    FT_SendChar                     ; Send command prefix
0489 120967         1646             CALL    ComServ_EraseMatrix             ; Erase matrix
048C 7496           1647             MOV     A,#150
048E 121CCF         1648             CALL    WaitMicroseconds                ; Wait a little bit to avoid immediate trig
                             ger caused by EraseMatrix
0491 900613         1649             MOV     DPTR,#Str_OK                    ; Send OK string
0494 121D70         1650             CALL    FT_SendString
0497 91F2           1651             CALL    CoincFinalNotification          ; Make final notification if desired, clear
                              coincidence flags
                    1652     
                    1653             ; Reopen the shutter and wait for next trigger
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    27

                    1654             OpenShutterInt
                    1656+1           OpenShutter
                    1668             TriggerStart
04B8 22             1674             RET
                    1675             ; Continue wait for coincidence:
                    1676             ;JMP    FrameDone                       ; Make the same action which is done after 
                             matrix readout if coincidence is valid.
                    1677     
                    1678       ; Send data via USB:
04B9                1679       ReadOutAndSendMatrix:
04B9 7443           1680             MOV     A,#'C'
04BB 121D3F         1681             CALL    FT_SendChar                     ; Send prefix
04BE 120A20         1682             CALL    ReadMatrixAndTime               ; Read a data matrix
04C1 900613         1683             MOV     DPTR,#Str_OK                    ; Send OK string
04C4 121D70         1684             CALL    FT_SendString
04C7 91F2           1685             CALL    CoincFinalNotification          ; Make final notification if desired, clear
                              flags
                    1686     
                    1687       ; Count of taken frames:
04C9                1688       FrameCountTest:
04C9 7862           1689             MOV     R0,#FRAME_CURR                  ; Address of curent counter value is in R0
04CB 75F004         1690             MOV     B,#4                            ; 4 bytes of counter
04CE                1691       FrameCounterIncrement:
04CE 06             1692             INC     @R0                             ; Increment one byte of counter
04CF E6             1693             MOV     A,@R0
04D0 701B           1694             JNZ     FrameDone                       ; If value of the byte is not zero after in
                             crement => Overflow doesn't occured
04D2 08             1695             INC     R0                              ; Next counter byte has to be inctremented 
                             as well
04D3 D5F0F8         1696             DJNZ    B,FrameCounterIncrement         ; Do it 4 times at maximum
                    1697     
04D6                1698       FrameCounterOverflow:                         ; Frame counter overflow occured
                    1699             IntervalStop
                    1702             PeriodStop
                    1705             CounterStop
                    1708             TriggerStop                             ; Stop all processes
04E4 900761         1710             MOV     DPTR,#Str_FramesFinished
04E7 121D70         1711             CALL    FT_SendString
04EA 021A45         1712             JMP FrameCounterRestart                 ; Reload frame counter and end
                    1713     
04ED                1714       FrameDone:
                    1715             ; TODO actions:
04ED E566           1716             MOV     A,FRAME_TODO
                    1717             ;CALL   SendTODOdescription             ; Sends todo cdescription
04EF 719D           1718             CALL    ProcessTODO                     ; Make tasks given by TODO
04F1 22             1719             RET
                    1720     
                    1721     
                    1722       ; If coincidence mode is set and notification is desired then generate it:
04F2                1723       CoincFinalNotification:
04F2 E559           1724             MOV     A,TRIGGER_COINC
04F4 30E61B         1725             JNB     COINC_CoincEvent,CoincFinalNotifDone    ; If COINC_CoincEvent is not set th
                             en coincidence mode is not used
04F7 30E218         1726             JNB     COINC_Notify,CoincFinalNotifDone        ; If COINC_Notify is not set then n
                             otification is switched off
04FA 30E403         1727             JNB     COINC_NotifyValidCoinc, CoincFinalNotifyMake    ; If all coincidenes have t
                             o be notified then do notify
04FD 20E70C         1728             JB      COINC_InValidCoinc, CoincResetEventFlags        ; If it is invalid coincide
                             nce => skip the notification
0500                1729         CoincFinalNotifyMake:
0500 A2E3           1730             MOV     C,COINC_NotifyInitLevel                         ; Trigger out initial level
                              is restored (no change should be seen on output)
0502 B3             1731             CPL     C
0503 92B1           1732             MOV     TriggerOut,C                                    ; Trigger out is set
0505 30E504         1733             JNB     COINC_NotifyByPulse, CoincResetEventFlags
0508 B3             1734             CPL     C
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    28

0509 92B1           1735             MOV     TriggerOut,C                                    ; Trigger out is reset
050B C3             1736             CLR     C
050C                1737         CoincResetEventFlags:
050C C2E6           1738             CLR     COINC_CoincEvent
050E C2E7           1739             CLR     COINC_InValidCoinc
0510 F559           1740             MOV     TRIGGER_COINC,A                         ; Write reseted flags back to regis
                             ter
0512                1741         CoincFinalNotifDone:
0512 22             1742             RET
                    1743     
                    1744     ;===============================================================================
                    1745     ; Command table:
                    1746     ;===============================================================================
                    1747     ;   XX   - Command
                    1748     ;   XXXX - Service address
                    1749     ; Last command in the table has to be 0
                    1750     
0513                1751     Com_Table:
                    1752             ;General commands
                    1753             ;-----------------------
0513 5F             1754             DB '_'
0514 08A6           1755             DW CompServ_CPUReset                    ; CPU Reset, reinitialization
0516 69             1756             DB 'i'
0517 0D32           1757             DW ComServ_Info                         ; Version information
0519 3F             1758             DB '?'
051A 0D17           1759             DW ComServ_Help                         ; List of all supported commands
                    1760     
                    1761             ; Trigger out:
                    1762             ;-----------------------
051C 2B             1763             DB '+'
051D 1AEF           1764             DW ComServ_TriggerOutHigh               ; Sets trigger out line to high level
051F 2D             1765             DB '-'
0520 1AF2           1766             DW ComServ_TriggerOutLow                ; Sets trigger out line to low level
0522 2A             1767             DB '*'
0523 1AF5           1768             DW ComServ_TriggerOutCpl                ; Inverts leel of trigger out line
                    1769     
                    1770             ; Medipix
                    1771             ;-----------------------
0525 72             1772             DB 'r'
0526 08AF           1773             DW ComServ_Reset                        ; Medipix Reset
0528 52             1774             DB 'R'
0529 08C4           1775             DW ComServ_ResetToDefault               ; Medipix Reset, default values of CmosIn
052B 53             1776             DB 'S'
052C 09CA           1777             DW ComServ_SetMatrixStream              ; Set matrix. Values are received from USB
052E 45             1778             DB 'E'
052F 08DA           1779             DW ComServ_SetMatrixDefault             ; Matrix is set to default values FF
0531 5E             1780             DB '^'
0532 094D           1781             DW ComServ_SetMatrixDefaultNotify       ; Matrix is set to default values FF
0534 24             1782             DB '$'
0535 0948           1783             DW ComServ_SetMatrixTestPattern         ; Matrix is set to default values AA
0537 65             1784             DB 'e'
0538 0A7B           1785             DW ComServ_ReadMatrixClear              ; Erase matrix (MPX command)
053A 6D             1786             DB 'm'
053B 0A1F           1787             DW ComServ_ReadMatrix                   ; Read matrix and send it to USB
053D 66             1788             DB 'f'
053E 0AC7           1789             DW ComServ_TestFSR                      ; FSR test
0540 73             1790             DB 's'
0541 0B34           1791             DW ComServ_TestFSRCyclic                ; Cyclic FSR test
0543 64             1792             DB 'd'
0544 0C18           1793             DW ComServ_SetDACs                      ; Set all DACS. Values received from USB
0546 6F             1794             DB 'o'
0547 0C58           1795             DW ComServ_OpenShutter                  ; Open the shutter
0549 63             1796             DB 'c'
054A 0C70           1797             DW ComServ_CloseShutter                 ; Close the shutter
054C 43             1798             DB 'C'
054D 0C74           1799             DW ComServ_CloseShutterAndSendData      ; Closes the shutter and sends data to USB
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    29

054F 30             1800             DB '0'
0550 0CE9           1801             DW ComServ_SelectFSR0                   ; Selects FSR0
0552 31             1802             DB '1'
0553 0CF3           1803             DW ComServ_SelectFSR1                   ; Selets FSR1
0555 70             1804             DB 'p'
0556 0CFD           1805             DW ComServ_PolarityNegative             ; Sets Negative polarity
0558 50             1806             DB 'P'
0559 0D07           1807             DW ComServ_PolarityPositive             ; Sets Positive polarity
055B 6E             1808             DB 'n'
055C 0D11           1809             DW ComServ_SendCMOSSettings             ; Sends CMOS setings to USB
055E 4F             1810             DB 'O'
055F 0C79           1811             DW ComServ_TestPulse                    ; Generates given number of test pulses
0561 23             1812             DB '#'
0562 0961           1813             DW ComServ_MedipixCount                 ; Sends number of detected Medipix chips
0564 7C             1814             DB '|'
0565 0B57           1815             DW ComServ_ChipboardID                  ; Returns chipboard ID
0567 33             1816             DB '3'
0568 0D3F           1817             DW ComServ_SetTPXClock                  ; Set clock frequency for Timepix
                    1818     
                    1819             ; Power sources
                    1820             ;-----------------------
056A 78             1821             DB 'x'
056B 0D39           1822             DW ComServ_DCswitchON                   ; Switch Medipix power ON
056D 58             1823             DB 'X'
056E 0D3C           1824             DW ComServ_DCswitchOFF                  ; Switch Medipix power OFF
0570 62             1825             DB 'b'
0571 0D62           1826             DW ComServ_SetBias                      ; Sets bias value (8 bit) is received from 
                             USB
0573 42             1827             DB 'B'
0574 0D77           1828             DW ComServ_ResetBias                    ; Sets bias to 0.
                    1829     
                    1830             ; ADCs (Monitor, Scope)
                    1831             ;-----------------------
0576 4D             1832             DB 'M'                                  ; Performs single shot monitor measurement
0577 1C1F           1833             DW MonitorSingleShotMeasurement
0579 61             1834             DB 'a'
057A 1BA9           1835             DW ScopeSingleShotMeasurement           ; Performs single shot scope measurement
057C 41             1836             DB 'A'
057D 1BE0           1837             DW ComServ_ScopeConfigure               ; Configures the scope (channels, samples, 
                             timing)
057F 24             1838             DB '$'
0580 1BB9           1839             DW ComServ_ScopeSendData                ; Sends last scope data (length and data)
                    1840     
                    1841             ; DACs
                    1842             ;-----------------------
0582 3E             1843             DB '>'
0583 0D7A           1844             DW ComServ_SetDAC                       ; Sets n-th internal DAC value
                    1845     
                    1846             ; Interval timer:
                    1847             ;-----------------------
0585 79             1848             DB 'y'
0586 1791           1849             DW ComServ_IntervalReset                ; Sets zeroes to interval timer and starts 
                             it
0588 48             1850             DB 'H'
0589 16E8           1851             DW IntervalRestart                      ; Reloads CURR from TIME and starts the int
                             erval timer
058B 59             1852             DB 'Y'
058C 1794           1853             DW ComServ_IntervalStop                 ; Stops the interval timer
058E 5A             1854             DB 'Z'
058F 177D           1855             DW ComServ_IntervalSet                  ; Sets interval length and ToDo config
0591 7A             1856             DB 'z'
0592 1799           1857             DW ComServ_IntervalState                ; Sends current interval state (on/off, tod
                             o, all-time, curr-time)
0594 25             1858             DB '%'
0595 17E4           1859             DW ComServ_IntervalElapsedTime          ; Sends elapsed interval time
0597 67             1860             DB 'g'
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    30

0598 1708           1861             DW ComServ_IntervalExposition           ; Starts single interval exposition
059A 3B             1862             DB ';'
059B 1706           1863             DW ComServ_IntervalExpositionSet
059D 68             1864             DB 'h'
059E 1738           1865             DW ComServ_IntervalMultiExposition      ; Starts multiple interval exposition
05A0 47             1866             DB 'G'
05A1 176C           1867             DW ComServ_AbortExposition              ; Aborts interval exposition
                    1868     
                    1869             ; Period timer:
                    1870             ;-----------------------
05A3 75             1871             DB 'u'
05A4 18C1           1872             DW ComServ_PeriodStart
05A6 55             1873             DB 'U'
05A7 18EE           1874             DW ComServ_PeriodStop
05A9 56             1875             DB 'V'
05AA 18DC           1876             DW ComServ_PeriodSet
05AC 76             1877             DB 'v'
05AD 18F3           1878             DW ComServ_PeriodState
05AF 26             1879             DB '&'
05B0 1935           1880             DW ComServ_PeriodicalExposition
                    1881     
                    1882             ; Counter
                    1883             ;-----------------------
05B2 6A             1884             DB 'j'
05B3 186E           1885             DW ComServ_CounterStart
05B5 4A             1886             DB 'J'
05B6 1881           1887             DW ComServ_CounterStop
05B8 4B             1888             DB 'K'
05B9 186E           1889             DW ComServ_CounterSet
                    1890     ;        DB 'k'
                    1891     ;        DW ComServ_CounterState
                    1892     
                    1893             ; External trigger:
                    1894             ;-----------------------
05BB 6C             1895             DB 'l'
05BC 19AC           1896             DW ComServ_TriggerStart
05BE 4C             1897             DB 'L'
05BF 19DB           1898             DW ComServ_TriggerStop
05C1 51             1899             DB 'Q'
05C2 19BE           1900             DW ComServ_TriggerSet
05C4 71             1901             DB 'q'
05C5 19DE           1902             DW ComServ_TriggerState
05C7 3C             1903             DB '<'
05C8 19C3           1904             DW ComServ_TriggerCoincSet
                    1905     
                    1906             ; Delay
                    1907             ;-----------------------
05CA 2F             1908             DB '/'
05CB 1A8B           1909             DW ComServ_SetDelay
                    1910     
                    1911             ; Frame counter
                    1912             ;-----------------------
05CD 40             1913             DB '@'
05CE 1A45           1914             DW ComServ_FrameCounterStart
05D0 28             1915             DB '('
05D1 1A2D           1916             DW ComServ_FrameCounterSet
05D3 29             1917             DB ')'
05D4 1A56           1918             DW ComServ_FrameCounterState
                    1919     
                    1920             ; Common, ToDo commands
                    1921             ;-----------------------
05D6 57             1922             DB 'W'
05D7 1AD8           1923             DW ComServ_SetTODO
05D9 77             1924             DB 'w'
05DA 1AE1           1925             DW ComServ_GetTODO
05DC 7E             1926             DB '~'
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    31

05DD 1AEA           1927             DW ComServ_MakeTODO
                    1928     
                    1929             ; Some specialities:
                    1930             ;-----------------------
05DF 2C             1931             DB ','
05E0 0D9F           1932             DW ComServ_WatchdogTest
05E2 20             1933             DB ' '
05E3 0DA2           1934             DW ComServ_Synchonization
05E5 2E             1935             DB '.'
05E6 0DA9           1936             DW ComServ_OscilatingShutter
05E8 3D             1937             DB '='
05E9 15CA           1938             DW ComServ_ResetMpxStartTriggerStartInterval
                    1939     
                    1940             ; Flash firmware:
                    1941             ;-----------------------
05EB 46             1942             DB 'F'
05EC 160C           1943             DW ComServ_Flash
                    1944     
                    1945             ; Tester:
                    1946             ;-----------------------
05EE 3A             1947             DB ':'
05EF 1636           1948             DW ComServ_LVDSTest
05F1 49             1949             DB 'I'
05F2 1663           1950             DW ComServ_CMOSTest
05F4 27             1951             DB 27h
05F5 1678           1952             DW ComServ_I2CTest
                    1953     
                    1954             ; End of the table
                    1955             ;-----------------------
05F7 00             1956             DB 0
                    1957     
                    1958     ;===============================================================================
                    1959     ; Text data
                    1960     ;===============================================================================
                    1961     
                    1962     ; System messages:
                    1963     ; ------------------
                    1964     
05F8                1965     Str_Online:
05F8 21556E69       1966             DB '!Unit is on line. ',0
05FC 74206973                
0600 206F6E20                
0604 6C696E65                
0608 2E2000                  
060B                1967     Str_ReadySpc:
060B 20             1968             DB ' '
060C                1969     Str_Ready:
060C 52656164       1970             DB 'Ready',0dh,0
0610 790D00                  
0613                1971     Str_OK:
0613 4F4B0D00       1972             DB 'OK',0dh,0
0617                1973     Str_MedipixCnt:
0617 4D656469       1974             DB 'Medipix chips: ',0
061B 70697820                
061F 63686970                
0623 733A2000                
0627                1975     Str_Medipix20Cnt:
0627 4D656469       1976             DB 'Medipix 2.1 chips: ',0
062B 70697820                
062F 322E3120                
0633 63686970                
0637 733A2000                
063B                1977     Str_MedipixMXRCnt:
063B 4D656469       1978             DB 'Medipix MXR chips: ',0
063F 70697820                
0643 4D585220                
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    32

0647 63686970                
064B 733A2000                
064F                1979     Str_TimepixCnt:
064F 4D656469       1980             DB 'Medipix TPXXX chips: ',0
0653 70697820                
0657 54505858                
065B 58206368                
065F 6970733A                
0663 2000                    
0665                1981     Str_Info:
0665 4D656469       1982             DB 'Medipix USB readout interface.',0ah,'Firmware version:'
0669 70697820                
066D 55534220                
0671 72656164                
0675 6F757420                
0679 696E7465                
067D 72666163                
0681 652E0A46                
0685 69726D77                
0689 61726520                
068D 76657273                
0691 696F6E3A                
0695                1983     Str_Version:
0695 31             1984             DB ('0'+VERSION_MAJOR)
0696 2E             1985             DB '.'
0697 32             1986             DB ('0'+VERSION_MINOR)
0698 2E             1987             DB '.'
0699 30             1988             DB ('0'+VERSION_SUBMINOR)
069A 61             1989             DB ('a'+CERN_CABLE)
069B 0D00           1990             DB 0dh,0
069D                1991     Str_Help:
069D 4B6E6F77       1992             DB 'Known commands: ',0
06A1 6E20636F                
06A5 6D6D616E                
06A9 64733A20                
06AD 00                      
06AE                1993     Str_SyncString:
06AE 31323334       1994             DB '1234567890qwertyuiopasdfghjklzxcvbnm',0
06B2 35363738                
06B6 39307177                
06BA 65727479                
06BE 75696F70                
06C2 61736466                
06C6 67686A6B                
06CA 6C7A7863                
06CE 76626E6D                
06D2 00                      
                    1995     
                    1996     ; Errors:
                    1997     ; --------
                    1998     ; Each error has to begin with '!'
                    1999     
06D3                2000     Str_Error:
06D3 21457272       2001             DB '!Error',0dh,0
06D7 6F720D00                
06DB                2002     Watchdog_Alert:
06DB 21576174       2003             DB '!Watchdog alert',0dh,0
06DF 6368646F                
06E3 6720616C                
06E7 6572740D                
06EB 00                      
06EC                2004     Str_UnknownComBeg:
06EC 21556E6B       2005             DB '!Unknown command: "',0
06F0 6E6F776E                
06F4 20636F6D                
06F8 6D616E64                
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    33

06FC 3A202200                
0700                2006     Str_UnknownComEnd:
0700 220D00         2007             DB '"',0dh,0
0703                2008     Str_MedipixNotConnected:
0703 214D6564       2009             DB '!Medipix chipboard is not connected',0dh,0
0707 69706978                
070B 20636869                
070F 70626F61                
0713 72642069                
0717 73206E6F                
071B 7420636F                
071F 6E6E6563                
0723 7465640D                
0727 00                      
0728                2010     Str_MedipiNotEnableOut:
0728 21426164       2011             DB '!Bad response from Medipix - No Enable Out',0dh,0
072C 20726573                
0730 706F6E73                
0734 65206672                
0738 6F6D204D                
073C 65646970                
0740 6978202D                
0744 204E6F20                
0748 456E6162                
074C 6C65204F                
0750 75740D00                
0754                2012     Str_ErrorFSR:
0754 21465352       2013             DB '!FSR Failed',0dh,0
0758 20466169                
075C 6C65640D                
0760 00                      
                    2014     
                    2015     
                    2016     ; Various messages:
                    2017     ; ------------------
                    2018     
0761                2019     Str_FramesFinished:
0761 22467261       2020             DB '"Frames finished"',0dh,0
0765 6D657320                
0769 66696E69                
076D 73686564                
0771 220D00                  
0774                2021     Str_IntervalFinished:
0774 22496E74       2022             DB '"Interval finished"',0dh,0
0778 65727661                
077C 6C206669                
0780 6E697368                
0784 6564220D                
0788 00                      
0789                2023     Str_PeriodFinished:
0789 22506572       2024             DB '"Period finished"',0dh,0
078D 696F6420                
0791 66696E69                
0795 73686564                
0799 220D00                  
079C                2025     Str_CounterFinished:
079C 22436F75       2026             DB '"Counter overflowed"',0dh,0
07A0 6E746572                
07A4 206F7665                
07A8 72666C6F                
07AC 77656422                
07B0 0D00                    
07B2                2027     Str_TriggerFinished:
07B2 22547269       2028             DB '"Trigger detected"',0dh,0
07B6 67676572                
07BA 20646574                
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    34

07BE 65637465                
07C2 64220D00                
07C6                2029     Str_CoincidenceEventValid:
07C6 22436F69       2030             DB '"Coincidence valid"',0dh,0
07CA 6E636964                
07CE 656E6365                
07D2 2076616C                
07D6 6964220D                
07DA 00                      
07DB                2031     Str_CoincidenceEventInValid:
07DB 22436F69       2032             DB '"Coincidence invalid"',0dh,0
07DF 6E636964                
07E3 656E6365                
07E7 20696E76                
07EB 616C6964                
07EF 220D00                  
07F2                2033     Str_Command1:
07F2 22436F6D       2034             DB '"Command1"',0dh,0
07F6 6D616E64                
07FA 31220D00                
07FE                2035     Str_Command2:
07FE 22436F6D       2036             DB '"Command2"',0dh,0
0802 6D616E64                
0806 32220D00                
080A                2037     Str_Scope:
080A 2253636F       2038             DB '"Scope"',0dh,0
080E 7065220D                
0812 00                      
                    2039     
0813                2040     Str_TODO:
0813 544F444F       2041             DB 'TODO actions: ',0
0817 20616374                
081B 696F6E73                
081F 3A2000                  
0822                2042     Str_TODO_CloseShutter:
0822 436C6F73       2043             DB 'Close shutter ',0
0826 65207368                
082A 75747465                
082E 722000                  
0831                2044     Str_TODO_OpenShutter:
0831 4F70656E       2045             DB 'Open shutter ',0
0835 20736875                
0839 74746572                
083D 2000                    
083F                2046     Str_TODO_StartInterval:
083F 53746172       2047             DB 'Start interval ',0
0843 7420696E                
0847 74657276                
084B 616C2000                
084F                2048     Str_TODO_StartScope:
084F 53746172       2049             DB 'Start scope ',0
0853 74207363                
0857 6F706520                
085B 00                      
085C                2050     Str_TODO_StartTrigger:
085C 53746172       2051             DB 'Start trigger ',0
0860 74207472                
0864 69676765                
0868 722000                  
086B                2052     Str_TODO_StartCounter:
086B 53746172       2053             DB 'Start counter ',0
086F 7420636F                
0873 756E7465                
0877 722000                  
087A                2054     Str_TODO_Command1:
087A 436F6D6D       2055             DB 'Command1 ',0
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    35

087E 616E6431                
0882 2000                    
0884                2056     Str_TODO_Command2:
0884 436F6D6D       2057             DB 'Command2 ',0
0888 616E6432                
088C 2000                    
                    2058     
                    2059     ;===============================================================================
                    2060     ; Stream length for different Medipixes:
                    2061     ;===============================================================================
                    2062     ; Number of bytes to be received from Medipix as a response to ReadMatrix:
                    2063     ; Or number of bytes to be transmited during WriteMatrix
                    2064     ; The most significant byte is first!
                    2065     
088E                2066     StreamLength_Medipix21:
088E                2067       Mpx21_Single:
088E 01C001         2068             DB      001h,0c0h,001h          ; 114689
0891                2069       Mpx21_Double:
0891 038001         2070             DB      003h,080h,001h          ; 229377
0894                2071       Mpx21_Triple:
0894 054001         2072             DB      005h,040h,001h          ; 344065
0897                2073       Mpx21_Quad:
0897 070001         2074             DB      007h,000h,001h          ; 458753
                    2075     
089A                2076     StreamLength_MedipixMXR:
089A                2077       MpxMXR_Single:
089A 01C021         2078             DB      001h,0c0h,021h          ; 114721
089D                2079       MpxMXR_Double:
089D 038042         2080             DB      003h,080h,042h          ; 229442
08A0                2081       MpxMXR_Triple:
08A0 054063         2082             DB      005h,040h,063h          ; 344163
08A3                2083       MpxMXR_Quad:
08A3 070084         2084             DB      007h,000h,084h          ; 458884
                    2085     
                    2086     
                    2087     ;===============================================================================
                    2088     ; Medipix support:
                    2089     ;===============================================================================
                    2090     
08A6                2091     CompServ_CPUReset:              ;CPU reset
08A6 900613         2092             MOV     DPTR,#Str_OK
08A9 121D70         2093             CALL    FT_SendString
08AC 0201C8         2094             JMP     MAIN
                    2095     ;_______________________________________________________________________________
                    2096     
                    2097                                     ; General reset of Medipix2
08AF                2098     ComServ_Reset:                  ; Resets only Medipix2 chip. The CMOS inputs are in the pre
                             vious state
                    2099     
08AF C208           2100             CLR     M_Reset
                    2101             SET_CmosIn
08B8 D208           2105             SETB    M_Reset
                    2106             SET_CmosIn
08C1 D2A6           2110             SETB    M_EnableIn
08C3 22             2111             RET
                    2112     ;_______________________________________________________________________________
                    2113                                     ; General reset of Medipix2
08C4                2114     ComServ_ResetToDefault:         ; Resets the Medipix2 chip. The CMOS inputs are in default 
                             state:
                    2115                                     ; Reset=1, PulseAdress=0,EnablePulse=0, Polarity=1, SpareFS
                             R=0, M1=0, M0=0,
                    2116     
08C4 C208           2117             CLR     M_Reset
                    2118             SET_CmosIn
08CD 752189         2122             MOV     M_CmosIn,#089H          ; Set the Medipix input byte to default values: Res
                             et=1, PulseAdress=0, EnablePulse=0, Polarity=1, SpareFSR=0, M1=0, M0=0, Shutter=1
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    36

                    2123             SET_CmosIn
08D7 D2A6           2127             SETB    M_EnableIn
08D9 22             2128             RET
                    2129     ;_______________________________________________________________________________
                    2130                                     ; Erase the Medipix2 matrix
08DA                2131     ComServ_SetMatrixDefault:       ; Erase matrix sending 0FFH to all pixels
                    2132     
08DA 7AFF           2133             MOV     R2,#0FFH                ; Data to be written
                    2134     
                    2135       ; Alternative entry point - data from R2 are written to MPX:
08DC                2136       SetMatrixR2:
                    2137     
08DC 75F834         2138             MOV     SPICON,#SPI_CONFIG_MPX  ; SPI is enabled in Master Mode (I2C is enabled), C
                             POL=0, CPHA=1, frequency Fosc/N
08DF C2FA           2139             CLR     CPHA                    ; Write data on leading edge (prepare on trailing e
                             dge)
                    2140     
08E1 C20E           2141             CLR     M_M0                    ; Set the control bits to Set Matrix configuration
08E3 D20D           2142             SETB    M_M1
08E5 D20F           2143             SETB    M_Shutter
                    2144             SET_CmosIn                      ; Put control bits to output register
08EE C2A6           2148             CLR     M_EnableIn              ; Start the operation
                    2149     
08F0 20A509         2150             JB      M_EnableOut,SetMatrixStartBytes ; Is Enable out in correct state?
08F3 753000         2151             MOV     MPX_CHIPS,#00h
08F6 900728         2152             MOV     DPTR,#Str_MedipiNotEnableOut    ; Load pointer to Error message to DPTR
08F9 D3             2153             SETB    C                               ; CY flag indicates an Error
08FA 8046           2154             JMP     SetMatrixDefEnd
                    2155     
08FC                2156       SetMatrixStartBytes:
08FC 900000         2157             MOV     DPTR,#0
08FF 758400         2158             MOV     DPP,#0                          ; Initialize byte counter (24 bit DPTR)
                    2159     
0902 EA             2160             MOV     A,R2                            ; Data to be sent to Medipix
                    2161     
0903                2162       SetMatrixDefByte:
0903 F5F7           2163             MOV     SPIDAT,A                        ; Write data from ACC to SPI => This initia
                             tes transmission
                    2164     
                    2165             ; To avoid deadlock let count bytes:            Cycles:
0905 A3             2166             INC     DPTR                            ;               3
                    2167     
0906 E582           2168             MOV     A,DPL                           ;               1
0908 7016           2169             JNZ     SetMatrixByteDefContinue        ;               2
                    2170     
                    2171             ; Just refresh watchdog whenever 256 bytes are transmitted
                    2172             RefreshWatchdog
                    2174+1           RefreshWatchdogBase
                    2178     
0912 A884           2179             MOV     R0,DPP                          ;               1
0914 B80809         2180             CJNE    R0,#8,SetMatrixByteDefContinue  ;               4       => 11 cycles => eve
                             n at max SPI speed transmission of one byte
                    2181                                                     ;                                       wil
                             l take 16 cycles => OK
0917                2182         SetMatrixNoMpxDetected:
                    2183             ; If we are here then Medipix chipboard is probably not connected:
0917 753000         2184             MOV     MPX_CHIPS,#00h
091A 900703         2185             MOV     DPTR,#Str_MedipixNotConnected   ; Load pointer to Error message to DPTR
091D D3             2186             SETB    C                               ; CY flag indicates an Error
091E 8022           2187             JMP     SetMatrixDefEnd
                    2188     
0920                2189         SetMatrixByteDefContinue:
0920 EA             2190             MOV     A,R2                            ; Data to be sent to Medipix
0921 30FFFD         2191             JNB     ISPI,$                          ; Wait until whole byte is transmited by SP
                             I
0924 C2FF           2192             CLR     ISPI                            ; Clear ISPI
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    37

                    2193     
                    2194             SPI_WAIT                                ; If low communication speed is set then ce
                             rtain wait time is inserted here
                    2198     
0926 20A5DA         2199             JB      M_EnableOut,SetMatrixDefByte    ; End of transmission?
                    2200     
                    2201             ; Mask has been successfully loaded
                    2202             ; Let us determine number of Medipix chips:
0929 E584           2203             MOV     A,DPP                           ; ACC = 01 (Single), 03 (Double), 05 (Tripl
                             e), 07 (Quad)
092B 04             2204             INC     A                               ; ACC = 02 (Single), 04 (Double), 06 (Tripl
                             e), 08 (Quad)
092C 03             2205             RR      A                               ; ACC = 01 (Single), 02 (Double), 03 (Tripl
                             e), 04 (Quad) => v ACC je pocet cipu
092D 5407           2206             ANL     A,#07h
092F F530           2207             MOV     MPX_CHIPS,A
                    2208     
                    2209             ; Let us determine type of chip:
0931 E531           2210             MOV     A,MPX_ISMXR
0933 5480           2211             ANL     A,#80h                          ; Reset number of MXR chips, conserve just 
                             Timepix flag
0935 F531           2212             MOV     MPX_ISMXR,A
                    2213     
0937 E582           2214             MOV     A,DPL                           ; ACC = 01 (Mpx21), 21/42/63/84 (MpxMXR)
0939 54F0           2215             ANL     A,#0F0h                         ; ACC = 00 (Mpx21), 20/40/60/80 (MpxMXR)
093B C4             2216             SWAP    A                               ; ACC = 00 (Mpx21), 02/04/06/08 (MpxMXR)
093C 03             2217             RR      A                               ; ACC = 00 (Mpx21), 01/02/03/04 (MpxMXR)
                    2218     
093D 4531           2219             ORL     A,MPX_ISMXR                     ; ADD Timepix fleg if it was set
093F F531           2220             MOV     MPX_ISMXR,A                     ; Zero for Mpx21, Nonzero for MXR (number o
                             f MXR chips)
                    2221     
                    2222             ; Divide it by 16384 - shift right 8 x and then 6 x, then divide by 7 = divide by 1
                             14688
                    2223             ;MOV    A,DPH
                    2224             ;SWAP   A
                    2225             ;RR     A
                    2226             ;RR     A
                    2227             ;ANL    A,#03h
                    2228             ;MOV    DPL,A
                    2229             ;MOV    A,DPP
                    2230             ;RL     A
                    2231             ;RL     A
                    2232             ;ORL    A,DPL
                    2233             ;MOV    B,#7
                    2234             ;DIV    AB
                    2235             ;MOV    MPX_CHIPS,A
0941 C3             2236             CLR     C
                    2237     
0942                2238        SetMatrixDefEnd:
0942 D2A6           2239             SETB    M_EnableIn              ; End of operation
0944 758400         2240             MOV     DPP,#0                  ; As DPTR overflowed DPP can be nonzero => reinitia
                             lize it to zero
0947 22             2241             RET
                    2242     
0948                2243     ComServ_SetMatrixTestPattern:
0948 7AAA           2244             MOV     R2,#0AAH                ; Data to be written
094A 11DC           2245             CALL    SetMatrixR2             ; Jump to SetMatrix function
094C 22             2246             RET
                    2247     
                    2248     ;_______________________________________________________________________________
                    2249     
094D                2250     ComServ_SetMatrixDefaultNotify:         ; Sets default Matrix in Medipix
                    2251                                             ; Outputs notification containing number of detecte
                             d chips
094D 11DA           2252             CALL    ComServ_SetMatrixDefault
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    38

                    2253             ;JC     SetMatrixDefError
                    2254     
094F                2255       NotifyNumberOfChips:                  ; Outputs notification with number of chips connect
                             ed
094F 900617         2256             MOV     DPTR,#Str_MedipixCnt
0952 121D70         2257             CALL    FT_SendString
0955 7430           2258             MOV     A,#'0'
0957 2530           2259             ADD     A,MPX_CHIPS
0959 121D3F         2260             CALL    FT_SendChar
095C 22             2261             RET
                    2262     
095D                2263       SetMatrixDefError:
095D 121D70         2264             CALL    FT_SendString
0960 22             2265             RET
                    2266     
                    2267     ;_______________________________________________________________________________
                    2268     
0961                2269     ComServ_MedipixCount:
0961 E530           2270             MOV     A,MPX_CHIPS
0963 121D3F         2271             CALL    FT_SendChar
0966 22             2272             RET
                    2273     
                    2274     ;_______________________________________________________________________________
                    2275                                     ; Erase the Medipix2 matrix
0967                2276     ComServ_EraseMatrix:            ; Erase matrix using Medipix2 commands
                    2277     
0967 E531           2278             MOV     A,MPX_ISMXR
0969 703C           2279             JNZ     DummyReadMatrix         ; MXR doesn't support erase command
                    2280     
096B 75F834         2281             MOV     SPICON,#SPI_CONFIG_MPX  ; SPI is enabled in Master Mode (I2C is enabled), C
                             POL=0, CPHA=1, frequency Fosc/N
                    2282     
096E C2FA           2283             CLR     CPHA                    ; Write data on leading edge (prepare on trailing e
                             dge)
0970 D20E           2284             SETB    M_M0                    ; Set control bits to Reset Matrix configuration
0972 D20D           2285             SETB    M_M1
0974 D20F           2286             SETB    M_Shutter
                    2287             SET_CmosIn
097D C2A6           2291             CLR     M_EnableIn              ; Start the operation
                    2292     
097F 900000         2293             MOV     DPTR,#0
0982 758400         2294             MOV     DPP,#0                  ; Initialize byte counter (24 bit DPTR)
                    2295     
0985 74FF           2296             MOV     A,#0FFH                 ; This data has to be written to Medipix
                    2297     
0987                2298       EraseMatrixByte:
0987 F5F7           2299             MOV     SPIDAT,A                        ; Write data from ACC to SPI => This initia
                             tes transmission
                    2300     
                    2301             ; To avoid deadlock let count bytes:            Cycles:
0989 A3             2302             INC     DPTR                            ;               3
098A A884           2303             MOV     R0,DPP                          ;               1
098C B80109         2304             CJNE    R0,#1,EraseMatrixByteContinue   ;               4       => 8 cycles =>  eve
                             n at max SPI speed transmission of one byte
                    2305                                                     ;                                       wil
                             l take 16 cycles => OK
                    2306             ; If we are here then Medipix chipboard is probably not connected:
098F 753000         2307             MOV     MPX_CHIPS,#00h
0992 900703         2308             MOV     DPTR,#Str_MedipixNotConnected   ; Load pointer to Error message to DPTR
0995 D3             2309             SETB    C                               ; CY flag indicates an Error
0996 8009           2310             JMP     EraseMatrixEnd
                    2311     
0998                2312         EraseMatrixByteContinue:
0998 30FFFD         2313             JNB     ISPI,$                  ; Wait until whole byte is transmited by SPI
099B C2FF           2314             CLR     ISPI                    ; Clear ISPI
                    2315             SPI_WAIT                        ; If low communication speed is set then certain wa
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    39

                             it time is inserted here
099D 20A5E7         2319             JB      M_EnableOut,EraseMatrixByte
                    2320     
                    2321             ; If we are here then at least one Medipix chip is present
                    2322             ; We can check number of Medipix chips.
                    2323     
09A0 C3             2324             CLR     C
                    2325     
09A1                2326       EraseMatrixEnd:
09A1 D2A6           2327             SETB    M_EnableIn              ; End of operation
09A3 758400         2328             MOV     DPP,#0                  ; As DPTR overflowed DPP can be nonzero => reinitia
                             lize it to zero
09A6 22             2329             RET
                    2330     
                    2331     ; Dymmy reading of a matrix (no data are sent to USB) - just to erase matrix
09A7                2332     DummyReadMatrix:
09A7 75F834         2333             MOV     SPICON,#SPI_CONFIG_MPX  ; SPI is enabled in Master Mode (I2C is enabled), C
                             POL=0, CPHA=1, frequency Fosc/N
09AA D2FA           2334             SETB    CPHA                    ; Read data on trailing edge (prepare on leading ed
                             ge)
                    2335     
09AC C20E           2336             CLR     M_M0                    ; Set control bits to Read Matrix configuration
09AE C20D           2337             CLR     M_M1
09B0 D20F           2338             SETB    M_Shutter               ; Shutter is closed
                    2339             SET_CmosIn
09B9 C2A6           2343             CLR     M_EnableIn              ; Start the operation
                    2344     
09BB 74FF           2345             MOV     A,#0FFH
09BD                2346       DRM_1:
09BD F5F7           2347             MOV     SPIDAT,A                ; Transmit one byte (transmitted data are dummy - j
                             ust to initiate clocks)
09BF 30FFFD         2348             JNB     ISPI,$                  ; Wait until whole byte is received by SPI
09C2 C2FF           2349             CLR     ISPI
                    2350             SPI_WAIT                        ; If low communication speed is set then certain wa
                             it time is inserted here
09C4 20A5F6         2354             JB      M_EnableOut,DRM_1       ; End of transmission?
                    2355     
09C7 D2A6           2356             SETB    M_EnableIn              ; End of operation
09C9 22             2357             RET
                    2358     
                    2359     ;_______________________________________________________________________________
                    2360                                     ; Set the matrix via USB
09CA                2361     ComServ_SetMatrixStream:
                    2362     
                    2363             ; We will count number of transmitted bytes:
09CA 900000         2364             MOV     DPTR,#0
09CD 758400         2365             MOV     DPP,#0                  ; Initialize byte counter (24 bit DPTR)
                    2366     
                    2367             ; Configure SPI interface
09D0 75F834         2368             MOV     SPICON,#SPI_CONFIG_MPX  ; SPI is enabled in Master Mode (I2C is enabled), C
                             POL=0, CPHA=1, frequency Fosc/N
09D3 C2FA           2369             CLR     CPHA                    ; Write data on leading edge (prepare on trailing e
                             dge)
                    2370     
                    2371             ; Configure Medipix interface
09D5 C20E           2372             CLR     M_M0                    ; Set the control bits to Set Matrix configuration
09D7 D20D           2373             SETB    M_M1
09D9 D20F           2374             SETB    M_Shutter
                    2375             SET_CmosIn
09E2 C2A6           2379             CLR     M_EnableIn              ; Start the operation
                    2380     
09E4 7599FF         2381             MOV     SBUF,#0FFH                      ; Dummy byte is not taken from USB
09E7                2382       SetMatrixLoop:
                    2383             ; MOV     FT_port,A               ; Set FT_port as input
                    2384             ; JB      FT_RxF,$                ; Wait until FTDI is ready to read
                    2385             ; CLR     FT_RD                   ; Make read data pulse
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    40

                    2386             ;CLR    TI
                    2387             ;MOV    SBUF, #41
                    2388             ;JNB    TI,$
                    2389     
                    2390             ; Just refresh watchdog whenever 256 bytes are transmitted
                    2391             RefreshWatchdog
                    2393+1           RefreshWatchdogBase
                    2397     
09EF 3098F5         2398             JNB     RI,SetMatrixLoop              ; test if it is a reception
09F2 C298           2399             CLR     RI                             ; clear reception flag for next reception
                    2400     
09F4 8599F7         2401             MOV SPIDAT, SBUF
                    2402     
                    2403             ;MOV    A, #'A'
                    2404             ;CALL FT_SendChar
                    2405     
                    2406             ; To avoid deadlock let count bytes:       Cycles:
09F7 A3             2407             INC     DPTR                            ;       3
09F8 A882           2408             MOV     R0,DPL                          ;       1
09FA B80013         2409             CJNE    R0,#0,SetMatrixContinue         ;       4 => 8 cycles => even at max SPI sp
                             eed transmission of one byte will take 16 cycles => OK
                    2410     
                    2411             ; Just refresh watchdog whenever 256 bytes are transmitted
                    2412             RefreshWatchdog
                    2414+1           RefreshWatchdogBase
                    2418     
0A05 A884           2419             MOV     R0,DPP
0A07 B80806         2420             CJNE    R0,#8,SetMatrixContinue         ; Too many bytes written => Error
                    2421     
                    2422             ; If we are here then to many bytes are transmitted => error
0A0A 900703         2423             MOV     DPTR,#Str_MedipixNotConnected   ; Load pointer to Error message to DPTR
0A0D D3             2424             SETB    C                               ; CY flag indicates an Error
0A0E 8009           2425             JMP     SetMatrixEnd
                    2426     
0A10                2427       SetMatrixContinue:
                    2428     
                    2429             ;MOV    A, #'B'
                    2430             ;CALL FT_SendChar
                    2431     
0A10 30FFFD         2432             JNB     ISPI,$                  ; Wait until whole byte is sent/received by SPI
                    2433     
                    2434             ;MOV    A, #'C'
                    2435             ;CALL FT_SendChar
                    2436     
0A13 C2FF           2437             CLR     ISPI                    ; Clear ISPI
                    2438             SPI_WAIT                        ; If low communication speed is set then certain wa
                             it time is inserted here
0A15 20A5CF         2442             JB      M_EnableOut,SetMatrixLoop
                    2443     
0A18 C3             2444             CLR     C                       ; No error
                    2445     
0A19                2446       SetMatrixEnd:
                    2447             ;MOV    A, #'X'
                    2448             ;CALL FT_SendChar
0A19 D2A6           2449             SETB    M_EnableIn              ; Stop the operation
0A1B 758400         2450             MOV     DPP,#0                  ; As DPTR overflowed DPP can be nonzero => reinitia
                             lize it to zero
0A1E 22             2451             RET
                    2452     ;_______________________________________________________________________________
                    2453                                     ; Alternative entry point of ReadMatrix
                    2454                                     ; Sends elapsed interval time first                        
                                  
0A1F                2455     ComServ_ReadMatrix:
0A1F 00             2456             NOP                             ; To have possibility to set breakpoint here
                    2457     
0A20                2458     ReadMatrixAndTime:
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    41

0A20 12018D         2459             call    CloseShutterInt         ; Closes shutter and stops the interval if it is no
                             t stopped yet
                    2460             ;; TADY SE PREDTIM POSILAL CAS
                    2461             ;CALL   IntervalElapsedTime     ; Sends 6 bytes with elapsed time
                    2462     
                    2463                                     ; Entry point of ReadMatrix
                    2464                                     ; Sends data read from MPX chip
0A23                2465     ReadMatrix:
                    2466             ; We will count number of transmitted bytes:
0A23 121CEF         2467             CALL    Wait10MicroSeconds
0A26 900000         2468             MOV     DPTR,#0
0A29 758400         2469             MOV     DPP,#0                  ; Initialize byte counter (24 bit DPTR)
                    2470     
                    2471             ; Configure SPI interface
0A2C 75F834         2472             MOV     SPICON,#SPI_CONFIG_MPX  ; SPI is enabled in Master Mode (I2C is enabled), C
                             POL=0, CPHA=1, frequency Fosc/N
                    2473     
                    2474             ; Configure Medipix interface
0A2F C20E           2475             CLR     M_M0                    ; Set control bits to Read Matrix mode
0A31 C20D           2476             CLR     M_M1
0A33 D20F           2477             SETB    M_Shutter               ; 1 = Shutter is closed
                    2478             SET_CmosIn
                    2482     
0A3C C2A6           2483             CLR     M_EnableIn              ; Start the operation
                    2484     
0A3E 74FF           2485             MOV     A,#0FFH
0A40 F5F7           2486             MOV     SPIDAT,A                ; Transmit dymmy byte
0A42 8022           2487             JMP     ReadMatrixContinue      ; Go to loop entry point
                    2488     
0A44                2489       ReadMatrixLoop:
0A44 F5F7           2490             MOV     SPIDAT,A                ; Transmit one byte (transmitted data are dummy - j
                             ust to initiate clocks)
                    2491             
                    2492             ;; TADY SE DRIVE CEKALO, NEZ BYLO FTDI READY
                    2493             ;JB      FT_TxE,$                ; Wait util FTDI is ready to write
                    2494             ;CLR     FT_WR                   ; Make a write pulyse
                    2495             ;SETB    FT_WR                  ; Prepare a write pulse
                    2496             
                    2497             ;; CEKA SE AZ BUDE UART READY
0A46 3099FD         2498             JNB     TI,$
                    2499     
0A49                2500       ReadMatrixLoopEntry:
                    2501             ; To avoid deadlock let count bytes:            Cycles:
0A49 A3             2502             INC     DPTR                            ;               3
0A4A E582           2503             MOV     A,DPL                           ;               1
0A4C 7018           2504             JNZ     ReadMatrixContinue              ;               2       => 6 cycles => even
                              at max SPI speed transmission of one byte will take 16 cycles => OK
0A4E 8000           2505             JMP     WaitingForPes
                    2506     
0A50                2507        WaitingForPes:
                    2508     
                    2509             ; Just refresh watchdog whenever 256 bytes are received
                    2510             RefreshWatchdog
                    2512+1           RefreshWatchdogBase
                    2516     
0A58 3098F5         2517             JNB     RI,WaitingForPes
                    2518     
                    2519             ;MOV    A, #0DH
                    2520             ;CALL FT_SendChar
                    2521     
0A5B C298           2522             CLR     RI
                    2523     
0A5D A884           2524             MOV     R0,DPP
0A5F B80804         2525             CJNE    R0,#8,ReadMatrixContinue        ; Too many bytes => Error
                    2526     
                    2527             ; If we are here then to many bytes are received => error
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    42

0A62 900703         2528             MOV     DPTR,#Str_MedipixNotConnected   ; Load pointer to Error message to DPTR
0A65 D3             2529             SETB    C                               ; CY flag indicates an Error
                    2530     
0A66                2531       ReadMatrixContinue:
0A66 30FFFD         2532             JNB     ISPI,$                  ; Wait until whole byte is received by SPI
                    2533             ;MOV     FT_port,SPIDAT          ; Send received data from SPIDAD to FTDI port (SPI
                              is cleared)
                    2534     
                    2535             ;; TADY SE POSILAJI TA SKUTECNA DATA ZE SENSORU
                    2536             ;;;; UART ;;;;
0A69 C299           2537             CLR     TI                      ; write uart
0A6B 85F799         2538             MOV     SBUF,SPIDAT
                    2539     
                    2540             SPI_WAIT                        ; If low communication speed is set then certain wa
                             it time is inserted here
0A6E 20A5D3         2544             JB      M_EnableOut,ReadMatrixLoop     ; End of transmision?
                    2545     
                    2546             ;; TADY SE DRIVE POSILALA DATA DO FTDI
                    2547             ;JB      FT_TxE,$                ; Wait util FTDI is ready to write
                    2548             ;CLR     FT_WR                   ; Make a write pulse
                    2549             ;SETB    FT_WR
                    2550             
                    2551             ;; TADY SE CEKA, NEZ JSOU DATA (ZNAK) POSLANA
0A71 3099FD         2552             JNB     TI,$                    ; Wait until Uart is written
                    2553     
0A74 C3             2554             CLR     C                       ; No error
                    2555     
0A75                2556       ReadMatrixEnd:
0A75 D2A6           2557             SETB    M_EnableIn              ; End of operation
0A77 758400         2558             MOV     DPP,#0                  ; As DPTR overflowed DPP can be nonzero => reinitia
                             lize it to zero
0A7A 22             2559             RET
                    2560     ;_______________________________________________________________________________
                    2561     
0A7B                2562     ComServ_ReadMatrixClear:
0A7B 00             2563             NOP                             ; To have possibility to set breakpoint here
                    2564     
0A7C                2565     ReadMatrixClearAndTime:
0A7C 12018D         2566             call    CloseShutterInt         ; Closes shutter and stops the interval if it is no
                             t stopped yet
                    2567             ;; TADY SE PREDTIM POSILAL CAS
                    2568             ;CALL   IntervalElapsedTime     ; Sends 6 bytes with elapsed time
                    2569     
                    2570                                     ; Entry point of ReadMatrix
                    2571                                     ; Sends data read from MPX chip
0A7F                2572     ReadMatrixClear:
                    2573             ; We will count number of transmitted bytes:
0A7F 121CEF         2574             CALL    Wait10MicroSeconds
0A82 900000         2575             MOV     DPTR,#0
0A85 758400         2576             MOV     DPP,#0                  ; Initialize byte counter (24 bit DPTR)
                    2577     
                    2578             ; Configure SPI interface
0A88 75F834         2579             MOV     SPICON,#SPI_CONFIG_MPX  ; SPI is enabled in Master Mode (I2C is enabled), C
                             POL=0, CPHA=1, frequency Fosc/N
                    2580     
                    2581             ; Configure Medipix interface
0A8B C20E           2582             CLR     M_M0                    ; Set control bits to Read Matrix mode
0A8D C20D           2583             CLR     M_M1
0A8F D20F           2584             SETB    M_Shutter               ; 1 = Shutter is closed
                    2585             SET_CmosIn
                    2589     
0A98 C2A6           2590             CLR     M_EnableIn              ; Start the operation
                    2591     
0A9A 74FF           2592             MOV     A,#0FFH
0A9C F5F7           2593             MOV     SPIDAT,A                ; Transmit dymmy byte
0A9E 801A           2594             JMP     ReadMatrixClearContinue ; Go to loop entry point
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    43

                    2595     
0AA0                2596       ReadMatrixClearLoop:
0AA0 F5F7           2597             MOV     SPIDAT,A                ; Transmit one byte (transmitted data are dummy - j
                             ust to initiate clocks)
                    2598             
                    2599             ;; TADY SE DRIVE CEKALO, NEZ BYLO FTDI READY
                    2600             ;JB      FT_TxE,$                ; Wait util FTDI is ready to write
                    2601             ;CLR     FT_WR                   ; Make a write pulyse
                    2602             ;SETB    FT_WR                  ; Prepare a write pulse
                    2603             
                    2604             ;; CEKA SE AZ BUDE UART READY
                    2605             ;; ... NECEKA, V TETO METODE NECHCEME POSILAT DATA NA SERIOVOU LINKU
                    2606             ;; JNB  TI,$
                    2607     
0AA2                2608       ReadMatrixClearLoopEntry:
                    2609             ; To avoid deadlock let count bytes:            Cycles:
0AA2 A3             2610             INC     DPTR                            ;               3
0AA3 E582           2611             MOV     A,DPL                           ;               1
0AA5 7013           2612             JNZ     ReadMatrixClearContinue         ;               2       => 6 cycles => even
                              at max SPI speed transmission of one byte will take 16 cycles => OK
0AA7 8000           2613             JMP     WaitingForPesClear
                    2614     
0AA9                2615        WaitingForPesClear:
                    2616     
                    2617             ; Just refresh watchdog whenever 256 bytes are received
                    2618             RefreshWatchdog
                    2620+1           RefreshWatchdogBase
                    2624             
                    2625             ;; tady se cekalo az xmega posle potvrzovaci znak
                    2626             ;; JNB  RI,WaitingForPesClear
                    2627     
                    2628             ;MOV    A, #0DH
                    2629             ;CALL FT_SendChar
                    2630     
                    2631             ;; CLR  RI
0AB1 A884           2632             MOV     R0,DPP
0AB3 B80804         2633             CJNE    R0,#8,ReadMatrixClearContinue   ; Too many bytes => Error
                    2634     
                    2635             ; If we are here then to many bytes are received => error
0AB6 900703         2636             MOV     DPTR,#Str_MedipixNotConnected   ; Load pointer to Error message to DPTR
0AB9 D3             2637             SETB    C                               ; CY flag indicates an Error
                    2638     
0ABA                2639       ReadMatrixClearContinue:
0ABA 30FFFD         2640             JNB     ISPI,$                  ; Wait until whole byte is received by SPI
                    2641             ;MOV     FT_port,SPIDAT          ; Send received data from SPIDAD to FTDI port (SPI
                              is cleared)
                    2642     
                    2643             ;; TADY SE POSILAJI TA SKUTECNA DATA ZE SENSORU
                    2644             ;;;; UART ;;;;
                    2645             ;; CLR  TI                      ; write uart
                    2646             ;; MOV  SBUF,SPIDAT
                    2647     
                    2648             SPI_WAIT                        ; If low communication speed is set then certain wa
                             it time is inserted here
0ABD 20A5E0         2652             JB      M_EnableOut,ReadMatrixClearLoop     ; End of transmision?
                    2653     
                    2654             ;; TADY SE DRIVE POSILALA DATA DO FTDI
                    2655             ;JB      FT_TxE,$                ; Wait util FTDI is ready to write
                    2656             ;CLR     FT_WR                   ; Make a write pulse
                    2657             ;SETB    FT_WR
                    2658             
                    2659             ;; TADY SE CEKA, NEZ JSOU DATA (ZNAK) POSLANA
                    2660             ;; ... V TETO METODE NEPOSILAME DATA PO SERIOVE LINCE
                    2661             ;;JNB   TI,$                    ; Wait until Uart is written
                    2662     
0AC0 C3             2663             CLR     C                       ; No error
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    44

                    2664     
0AC1                2665       ReadMatrixClearEnd:
0AC1 D2A6           2666             SETB    M_EnableIn              ; End of operation
0AC3 758400         2667             MOV     DPP,#0                  ; As DPTR overflowed DPP can be nonzero => reinitia
                             lize it to zero
0AC6 22             2668             RET
                    2669     ;_______________________________________________________________________________
                    2670     
                    2671                                     ; Test Fast Shift Registers by microcontroller
0AC7                2672     ComServ_TestFSR:
                    2673     
                    2674     
                    2675             ; Make MPX reset to copy MXR ID to shift register:
0AC7 C208           2676             CLR     M_Reset
                    2677             SET_CmosIn
0AD0 D208           2681             SETB    M_Reset
                    2682             SET_CmosIn
                    2686     
                    2687             ; Configure SPI interface:
0AD9 75F834         2688             MOV     SPICON,#SPI_CONFIG_MPX  ; SPI is enabled in Master Mode (I2C is enabled), C
                             POL=0, CPHA=1, frequency Fosc/N
0ADC C2FA           2689             CLR     CPHA                    ; Write data on leading edge (prepare on trailing e
                             dge)
                    2690     
                    2691             ; Configure Medipix interface:
0ADE D20E           2692             SETB    M_M0                    ; Set the control bits to Set DACs configuration
0AE0 C20D           2693             CLR     M_M1
0AE2 D20F           2694             SETB    M_Shutter
                    2695             SET_CmosIn                      ; Write control bits to CMOS control register
0AEB C2A6           2699             CLR     M_EnableIn              ; Start the operation
                    2700     
                    2701       ; Send 1 dummy byte:
0AED 75F7FF         2702             MOV     SPIDAT,#0FFH            ; Move dummy data to SPI interface
0AF0 30FFFD         2703             JNB     ISPI,$                  ; Wait until whole byte is sent/received by SPI
                    2704             SPI_WAIT                        ; If low communication speed is set then certain wa
                             it time is inserted here
                    2708     
                    2709       ; Now send max 256 bytes of FFH => enough for 8 chips
0AF3 75F000         2710             MOV     B,#0
0AF6 7800           2711             MOV     R0,#0                   ; RO is used as counter of transmitted bytes
0AF8                2712       TestFSRSendByte:
0AF8 75F7FF         2713             MOV     SPIDAT,#0FFH            ; Move data to SPI interface
0AFB 30FFFD         2714             JNB     ISPI,$                  ; Wait until whole byte is sent/received by SPI
0AFE C2FF           2715             CLR     ISPI                    ; Clear ISPI
                    2716             SPI_WAIT                        ; If low communication speed is set then certain wa
                             it time is inserted here
                    2720     
0B00 E5F7           2721             MOV     A,SPIDAT                ; Received data byte is in A
0B02 121D3F         2722             CALL    FT_SendChar             ; Just for debugging
0B05 08             2723             INC     R0
                    2724     
0B06 30A50A         2725             JNB     M_EnableOut,TestFSREnableOut     ; End of transmision?
                    2726     
0B09 D5F0EC         2727             DJNZ    B,TestFSRSendByte       ;
                    2728     
0B0C                2729       TestFSRfailed:
0B0C D2A6           2730             SETB    M_EnableIn              ; End of operation
0B0E 900754         2731             MOV     DPTR,#Str_ErrorFSR      ; Enable out was not received
0B11 D3             2732             SETB    C                       ; Error
0B12 22             2733             RET
                    2734     
0B13                2735       TestFSREnableOut:                     ; Enable out was received
0B13 D2A6           2736             SETB    M_EnableIn              ; End of operation
0B15 E8             2737             MOV     A,R0
0B16 75F020         2738             MOV     B,#32
0B19 84             2739             DIV     AB                      ; Divide number of bytes by 32 => in A is number of
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    45

                              chips
0B1A F530           2740             MOV     MPX_CHIPS,A             ; Initialize MPX_CHIPS register
                    2741     
0B1C 900617         2742             MOV     dptr,#Str_MedipixCnt
0B1F 121D70         2743             CALL    FT_SendString
0B22 E530           2744             MOV     A,MPX_CHIPS
0B24 2430           2745             ADD     A,#'0'                  ; Convert number of chips to ASCII
0B26 121D3F         2746             CALL    FT_SendChar
0B29 740D           2747             MOV     A,#0dh
0B2B 121D3F         2748             CALL    FT_SendChar             ; Send terminating 'CR'
                    2749     
0B2E E530           2750             MOV     A,MPX_CHIPS             ; Initialize MPX_CHIPS register
0B30 60DA           2751             JZ      TestFSRfailed           ; If zero chips then error
                    2752     
0B32                2753       TestFSRdoneOK:
0B32 C3             2754             CLR     C
0B33 22             2755             RET                             ; FSR test has beenleted successfully
                    2756     
                    2757     
                    2758     ;_______________________________________________________________________________
                    2759                                     ; Cyclic FSR test
                    2760                                     ; FSR_Test is repeated till next byte is receiveed from FTD
                             I
                    2761     
0B34                2762     ComServ_TestFSRCyclic:
                    2763     
0B34 51C7           2764             CALL    ComServ_TestFSR         ; Make single FSR test
0B36 5003           2765             JNC     TestFSRCycl_NoErr
                    2766             ; Error occured => print it
0B38 121D70         2767             CALL    FT_SendString
                    2768     
0B3B                2769       TestFSRCycl_NoErr:
                    2770             ; Reset watchdog
                    2771             RefreshWatchdog
                    2773+1           RefreshWatchdogBase
                    2777             ; Wait a little:
0B43 121D2E         2778             CALL    WaitQuarter
                    2779             ; Reset watchdog
                    2780             RefreshWatchdog
                    2782+1           RefreshWatchdogBase
                    2786     
                    2787             ; Is there some stop command in FTDI?
0B4E 20A3E3         2788             JB      FT_RxF,ComServ_TestFSRCyclic                ; Repeat until FTDI is ready to
                              read
0B51 C2A0           2789             CLR     FT_RD                   ; Make FTDI read pulse
0B53 D2A0           2790             SETB    FT_RD                   ; End of FTDI read pulse
                    2791     
0B55 C3             2792             CLR     C
0B56 22             2793             RET                             ; FSR test has been completed successfully
                    2794     
                    2795     ;_______________________________________________________________________________
                    2796                                     ; Get ID of the chipboard, transmits ID stored in X memory
                    2797                                     ; IDs are copied to X-memory by CALL GetChipboardTypeAndIDS
                             ilent
                    2798                                     ; during reset sequence
0B57                2799     ComServ_ChipboardID:
0B57 8530F0         2800             MOV     B,MPX_CHIPS             ; Number of chips is in B
0B5A 900000         2801             MOV     dptr,#CHIPBOARD_ID      ; Pointer to memory buffer with ID(s)
                    2802     
0B5D                2803       TransmitSingleID:
0B5D E0             2804             MOVX    A,@dptr                 ; first byte of ID to A
0B5E 121D3F         2805             CALL    FT_SendChar             ; Send it
0B61 A3             2806             INC     dptr
0B62 E0             2807             MOVX    A,@dptr                 ; second byte of ID to A
0B63 121D3F         2808             CALL    FT_SendChar             ; Send it
0B66 A3             2809             INC     dptr
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    46

0B67 E0             2810             MOVX    A,@dptr                 ; third byte of ID to A
0B68 121D3F         2811             CALL    FT_SendChar             ; Send it
0B6B A3             2812             INC     dptr
0B6C E0             2813             MOVX    A,@dptr                 ; forth byte of ID to A
0B6D 121D3F         2814             CALL    FT_SendChar             ; Send it
0B70 A3             2815             INC     dptr
0B71 D5F0E9         2816             DJNZ    B,TransmitSingleID      ; Repeat it for all chips
0B74 22             2817             RET
                    2818     
                    2819     
                    2820     ; Get ID of the chipboard, number of chips and IsMXR flag, chip IDs are copied to X memory.
                    2821     ; Medipix FSR is reseted to value 0x88
                    2822     
0B75                2823     GetChipboardTypeAndIDSilent:
                    2824       ; Make MPX reset to copy MXR ID to shift register:
0B75 C208           2825             CLR     M_Reset
                    2826             SET_CmosIn
0B7E D208           2830             SETB    M_Reset
                    2831             SET_CmosIn
                    2835     
                    2836       ; Clear the MXR flag and a number of chips:
0B87 753100         2837             MOV     MPX_ISMXR,#0
0B8A 753000         2838             MOV     MPX_CHIPS,#0
                    2839     
                    2840       ; Configure SPI interface:
0B8D 75F834         2841             MOV     SPICON,#SPI_CONFIG_MPX  ; SPI is enabled in Master Mode (I2C is enabled), C
                             POL=0, CPHA=1, frequency Fosc/N
0B90 C2FA           2842             CLR     CPHA                    ; Write data on leading edge (prepare on trailing e
                             dge)
                    2843     
                    2844       ; Configure Medipix interface:
0B92 D20E           2845             SETB    M_M0                    ; Set the control bits to Set DACs configuration
0B94 C20D           2846             CLR     M_M1
0B96 D20F           2847             SETB    M_Shutter
                    2848             SET_CmosIn                      ; Write control bits to CMOS control register
0B9F C2A6           2852             CLR     M_EnableIn              ; Start the operation
                    2853     
0BA1 75F000         2854             MOV     B,#0                    ; Counter of bytes (max 256 => 8 chips)
0BA4 7805           2855             MOV     R0,#5                   ; Counter of ID position
0BA6 7904           2856             MOV     R1,#4                   ; Counter of ID bytes
0BA8 900000         2857             MOV     dptr,#CHIPBOARD_ID      ; Pointer to memory buffer for ID
                    2858     
                    2859       ; Start with one dummy byte:
                    2860             ; Put any data to SPI:
0BAB 75F7FF         2861             MOV     SPIDAT,#0FFH            ; Move default data to SPI interface
0BAE 30FFFD         2862             JNB     ISPI,$                  ; Wait until whole byte is sent/received by SPI
0BB1 C2FF           2863             CLR     ISPI                    ; Clear ISPI
                    2864     
                    2865             SPI_WAIT                        ; If low communication speed is set then certain wa
                             it time is inserted here
                    2869     
                    2870       ; Continue with FSR bits:
0BB3                2871       SetDACdefbyteS:
                    2872             ; Put default data to SPI:
0BB3 75F7FF         2873             MOV     SPIDAT,#0FFH            ; Move default data to SPI interface
0BB6 30FFFD         2874             JNB     ISPI,$                  ; Wait until whole byte is sent/received by SPI
0BB9 C2FF           2875             CLR     ISPI                    ; Clear ISPI
                    2876     
0BBB E5F7           2877             MOV     A,SPIDAT                ; Get received data from SPIDAT (SPI is cleared)
                    2878     
                    2879             ;CALL   FT_SendChar             ; Just for debugging
                    2880     
                    2881         ; Is it ID byte?
0BBD D821           2882             DJNZ    R0,SetDACdefnextbyteS   ; Increment ID position counter, if not zero jump t
                             o continuation
                    2883     
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    47

                    2884             ; Now we are at the ID position:
                    2885             ; Get byte received from SPI and put it to Xmemory:
0BBF F0             2886             MOVX    @dptr,A                 ; Save byte to buffer
0BC0 A3             2887             INC     DPTR
                    2888     
                    2889             ;CALL   FT_SendChar             ; Just for debugging
                    2890     
0BC1 6006           2891             JZ      GotonextIDbyteS         ; zero ID is invalid
0BC3 04             2892             INC     A                       ; if ID is 0xFF it overflows to 0x00
0BC4 6002           2893             JZ      GotonextIDbyteSdecA     ; 0xFF ID is also invalid
                    2894     
0BC6 0531           2895             INC     MPX_ISMXR               ; valid ID => it is MXR (or Timepix)
                    2896     
0BC8                2897           GotonextIDbyteSdecA:
0BC8 14             2898             DEC     A                       ; Recover original value of ACC
                    2899     
0BC9                2900         GotonextIDbyteS:
0BC9 D913           2901             DJNZ    R1,OtherIDbytefollowsS  ; R1 says how many bytes the ID takes
0BCB 781C           2902             MOV     R0,#28                  ; next ID will come after 28 = 32 - 4 - 4 + 4 bytes
0BCD 7904           2903             MOV     R1,#4                   ; next ID will take 4 bytes
0BCF 0530           2904             INC     MPX_CHIPS               ; At least one chip is connected
                    2905     
                    2906             ; Timepix test: Last ID byte (in A) contains 0x10 bit (if it is not MXR then it is 
                             definitely not Timepix)
0BD1 30E40C         2907             JNB     ACC.4,SetDACdefnextbyteS; Timepix bit is not set => not a Timepix => contin
                             ue
0BD4 E531           2908             MOV     A,MPX_ISMXR
0BD6 6008           2909             JZ      SetDACdefnextbyteS      ; To be Timepix it has to be MXR
0BD8 D2E7           2910             SETB    ACC.7
0BDA F531           2911             MOV     MPX_ISMXR,A             ; Timepix => MPX_ISMXR = 0x8X
0BDC 8002           2912             JMP     SetDACdefnextbyteS
                    2913     
0BDE                2914         OtherIDbytefollowsS:
0BDE 7801           2915             MOV     R0,#1                   ; DJNZ will reach zero next time
                    2916     
                    2917             ; Prepare for next byte:
0BE0                2918         SetDACdefnextbyteS:
0BE0 30A503         2919             JNB     M_EnableOut,DACdefEndS  ; M_EnableOut=0 is signal of end
0BE3 D5F0CD         2920             DJNZ    B,SetDACdefbyteS        ; Repeat at maximum 256 times (8 chips)
                    2921     
0BE6                2922       DACdefEndS:
0BE6 D2A6           2923             SETB    M_EnableIn              ; End of operation
                    2924     
                    2925             ; Determine number of chips
0BE8 E5F0           2926             MOV     A,B
0BEA F4             2927             CPL     A
0BEB 04             2928             INC     A
0BEC 04             2929             INC     A
0BED 75F020         2930             MOV     B,#32
0BF0 84             2931             DIV     AB
0BF1 F530           2932             MOV     MPX_CHIPS,A
0BF3 22             2933             RET
                    2934     
                    2935     
0BF4                2936     NotifyChipboardType:
0BF4 E531           2937             MOV     A,MPX_ISMXR
0BF6 600D           2938             JZ      NCT_NotMXRchipboard
                    2939     
0BF8 30E705         2940             JNB     ACC.7,NCT_MXRChipboard
0BFB 90064F         2941             MOV     dptr,#Str_TimepixCnt
0BFE 8008           2942             JMP     NCT_SendType
                    2943     
0C00                2944       NCT_MXRChipboard:
0C00 90063B         2945             MOV     dptr,#Str_MedipixMXRCnt
0C03 8003           2946             JMP     NCT_SendType
0C05                2947       NCT_NotMXRchipboard:
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    48

0C05 900627         2948             MOV     dptr,#Str_Medipix20Cnt
                    2949     
0C08                2950       NCT_SendType:
0C08 121D70         2951             CALL    FT_SendString
0C0B E530           2952             MOV     A,MPX_CHIPS
0C0D 2430           2953             ADD     A,#'0'                  ; Convert number of chips to ASCII
0C0F 121D3F         2954             CALL    FT_SendChar
0C12 7420           2955             MOV     A,#' '
0C14 121D3F         2956             CALL    FT_SendChar             ; Send terminating Space
0C17 22             2957             RET
                    2958     
                    2959     ;_______________________________________________________________________________
                    2960                                     ; Set DACs of Medipix2
0C18                2961     ComServ_SetDACs:                ; Set the Medipix DACs - dummy byte is sent by PC!!
                    2962     
                    2963       ; Configure SPI interface:
0C18 75F834         2964             MOV     SPICON,#SPI_CONFIG_MPX  ; SPI is enabled in Master Mode (I2C is enabled), C
                             POL=0, CPHA=1, frequency Fosc/N
0C1B C2FA           2965             CLR     CPHA                    ; Write data on leading edge (prepare on trailing e
                             dge)
                    2966     
                    2967       ; Configure Medipix interface:
0C1D D20E           2968             SETB    M_M0                    ; Set the control bits to Set DACs configuration
0C1F C20D           2969             CLR     M_M1
0C21 D20F           2970             SETB    M_Shutter
                    2971             SET_CmosIn
                    2975     
                    2976       ; Start the operation:
0C2A C2A6           2977             CLR     M_EnableIn              ; Start the operation
                    2978     
                    2979             ;MOV     A,#0FFH
                    2980             ;MOV     FT_port,A               ; Set FT_port as input
                    2981     
0C2C 900000         2982             MOV     DPTR,#0                 ; Counter of stream bytes
0C2F                2983       CS080:
                    2984             ;JB      FT_RxF,$                ; Wait until FTDI is ready to read
                    2985             ;CLR     FT_RD                   ; Make FTDI read pulse
                    2986             ;MOV     SPIDAT,FT_port          ; Move data from FTDI to SPI interface
                    2987             ;SETB    FT_RD                   ; End of FTDI read pulse
                    2988     
                    2989             ; Just refresh watchdog whenever 256 bytes are transmitted
                    2990             RefreshWatchdog
                    2992+1           RefreshWatchdogBase
                    2996     
0C37 3098F5         2997             JNB     RI, CS080
0C3A C298           2998             CLR     RI
0C3C 8599F7         2999             MOV     SPIDAT, SBUF
0C3F 30FFFD         3000             JNB     ISPI,$                  ; Wait until whole byte is sent/received by SPI
0C42 C2FF           3001             CLR     ISPI                    ; Clear ISPI
                    3002             SPI_WAIT                        ; If low communication speed is set then certain wa
                             it time is inserted here
0C44 A3             3006             INC     DPTR                    ; Incerement byte counter
0C45 20A5E7         3007             JB      M_EnableOut,CS080       ; Repeat until M_EnableOut=0 which is signal of end
                    3008     
0C48 D2A6           3009             SETB    M_EnableIn              ; End of operation
                    3010     
0C4A 121D62         3011             CALL    FT_ClearFIFO            ; Flush all other characters remaining in the FTDI 
                             FIFO
                    3012     
0C4D E582           3013             MOV     A,DPL
0C4F 121D3F         3014             CALL    FT_SendChar
0C52 E583           3015             MOV     A,DPH
0C54 121D3F         3016             CALL    FT_SendChar
                    3017     
0C57 22             3018             RET
                    3019     
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    49

                    3020     ;_______________________________________________________________________________
                    3021                                     ; Open the Shutter
0C58                3022     ComServ_OpenShutter:
                    3023     
                    3024             OpenShutterInt                  ; Open shutter and start interval measurement
                    3026+1           OpenShutter
0C6F 22             3038             RET
                    3039     ;_______________________________________________________________________________
                    3040                                     ; Close Shutter
0C70                3041     ComServ_CloseShutter:
                    3042     
0C70 12018D         3043             call    CloseShutterInt         ; Closes shutter, stops interval measurement
0C73 22             3044             RET
                    3045     ;_______________________________________________________________________________
                    3046                                     ; Close Shutter and send data
0C74                3047     ComServ_CloseShutterAndSendData:
                    3048     
0C74 12018D         3049             call    CloseShutterInt         ; Closes shutter, stops interval measurement
0C77 4120           3050             JMP     ReadMatrixAndTime       ; Reads and transmits matrix
                    3051     
                    3052     ;_______________________________________________________________________________
                    3053                                     ; Generates given number of test pulses
0C79                3054     ComServ_TestPulse:              ; Receives two bytes: count of pulses
                    3055                                     ; Receives one byte:  half period in microseconds
                    3056     
0C79 121D47         3057             CALL    FT_GetChar
0C7C F4             3058             CPL     A
0C7D F582           3059             MOV     DPL,A
0C7F 121D47         3060             CALL    FT_GetChar
0C82 F4             3061             CPL     A
0C83 F583           3062             MOV     DPH,A                   ; DPTR contains desired number of counts
                    3063     
0C85 121D47         3064             CALL    FT_GetChar
0C88 14             3065             DEC     A                       ; half period is decremented to correct overhead
0C89 F5F0           3066             MOV     B,A                     ; B contains half test pulse periode in microsecond
                             s
                    3067     
0C8B D20A           3068             SETB    M_EnablePulse
0C8D C20F           3069             CLR     M_Shutter
0C8F D20E           3070             SETB    M_M0
0C91 D20D           3071             SETB    M_M1
                    3072             SET_CmosIn                      ; Opens the shutter and enables test pulse
0C9A 7401           3076             MOV     A,#1
0C9C 121CEF         3077             CALL    Wait10MicroSeconds
                    3078     
0C9F                3079       GenerateSinglePulse:
0C9F D209           3080             SETB    M_PulseAdress           ;                                         (2 cycles
                             )
                    3081             SET_CmosIn                      ; Rising edge (depending on DAC setings)  (5 cycles
                             )
0CA8 E5F0           3085             MOV     A,B                     ;                                         (1 cycle 
                               => 8 extra cycles)
0CAA 121CCF         3086             CALL    WaitMicroseconds
                    3087     
                    3088             RefreshWatchdog                 ; Refresh watchdog to prevent reset       (8 extra 
                             cycles => 16)
                    3090+1           RefreshWatchdogBase
0CB5 00             3094             NOP
0CB6 00             3095             NOP
0CB7 00             3096             NOP
0CB8 00             3097             NOP                             ; Just wait                               (4 extra 
                             cycles => 20) => 1 us
                    3098     
0CB9 C209           3099             CLR     M_PulseAdress
                    3100             SET_CmosIn                      ; Falling edge (depending on DAC setings)
0CC2 E5F0           3104             MOV     A,B                     ;                                         (8 extra 
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    50

                             cycles)
0CC4 121CCF         3105             CALL    WaitMicroseconds
                    3106     
0CC7 00             3107             NOP
0CC8 00             3108             NOP
0CC9 00             3109             NOP
0CCA 00             3110             NOP                             ; Just wait                               (4 extra 
                             cycles => 12)
                    3111     
0CCB A3             3112             INC     DPTR                    ; 3
0CCC E583           3113             MOV     A,DPH                   ; 1
0CCE 4582           3114             ORL     A,DPL                   ; 1
0CD0 70CD           3115             JNZ     GenerateSinglePulse     ; 3                                       (8 extra 
                             cycles => 20) => 1us
                    3116     
0CD2 7401           3117             MOV     A,#1
0CD4 121CEF         3118             CALL    Wait10MicroSeconds
0CD7 D20F           3119             SETB    M_Shutter
0CD9 C20E           3120             CLR     M_M0
0CDB C20D           3121             CLR     M_M1
0CDD C20A           3122             CLR     M_EnablePulse
                    3123             SET_CmosIn                      ; Closes the shutter and disables test pulse
                    3127     
0CE6 C3             3128             CLR     C
0CE7 4120           3129             JMP     ReadMatrixAndTime       ; Reads and transmits matrix
                    3130     ;_______________________________________________________________________________
                    3131                                     ; Select first of two FSR registers
0CE9                3132     ComServ_SelectFSR0:
                    3133     
0CE9 C20C           3134             CLR     M_SpareFsr              ; Select FSR0
                    3135             SET_CmosIn
0CF2 22             3139             RET
                    3140     ;_______________________________________________________________________________
                    3141                                     ; Select second of two FSR registers
0CF3                3142     ComServ_SelectFSR1:
0CF3 D20C           3143             SETB    M_SpareFsr              ; Select FSR1
                    3144             SET_CmosIn
0CFC 22             3148             RET
                    3149     ;_______________________________________________________________________________
                    3150                                     ; Set pixel to collect negative charges (electrons)
0CFD                3151     ComServ_PolarityNegative:
                    3152     
0CFD C20B           3153             CLR     M_Polarity              ; Negative polarity - negative charges collecting
                    3154             SET_CmosIn
0D06 22             3158             RET
                    3159     ;_______________________________________________________________________________
                    3160                                     ; Set pixel to collect positive charges (holes)
0D07                3161     ComServ_PolarityPositive:
0D07 D20B           3162             SETB    M_Polarity              ; Positive polarity - positive charges collecting
                    3163             SET_CmosIn
0D10 22             3167             RET
                    3168     ;_______________________________________________________________________________
                    3169                                     ; Send the Medipix inputs settings to PC
0D11                3170     ComServ_SendCMOSSettings:
0D11 E521           3171             MOV     A,M_CmosIn              ; Send the Medipix CMOS inputs settings
0D13 121D3F         3172             CALL    FT_SendChar
0D16 22             3173             RET
                    3174     ;_______________________________________________________________________________
                    3175                                     ; Sends list of known commands
0D17                3176     ComServ_Help:
0D17 90069D         3177             MOV     DPTR,#Str_Help          ; Send the help text "Known commands: "
0D1A 121D70         3178             CALL    FT_SendString
0D1D 900513         3179             MOV     dptr,#Com_Table
0D20                3180       HelpSingleCommand:
0D20 E4             3181             CLR     A
0D21 93             3182             MOVC    A,@A+dptr
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    51

0D22 6008           3183             JZ      HelpFinished
0D24 121D3F         3184             CALL    FT_SendChar             ; Sends command character
0D27 A3             3185             INC     DPTR                    ; Skip the command
0D28 A3             3186             INC     DPTR
0D29 A3             3187             INC     DPTR                    ; Skip address of service => dptr points to the nex
                             t command
0D2A 80F4           3188             JMP     HelpSingleCommand
0D2C                3189       HelpFinished:
0D2C 740D           3190             MOV     A,#0dh
0D2E 121D3F         3191             CALL    FT_SendChar             ; Sends terminating 'CR' character
0D31 22             3192             RET
                    3193     ;_______________________________________________________________________________
                    3194                                     ; Name of the device
0D32                3195     ComServ_Info:
0D32 900665         3196             MOV     DPTR,#Str_Info          ; Send the device name info
0D35 121D70         3197             CALL    FT_SendString
0D38 22             3198             RET
                    3199     ;_______________________________________________________________________________
                    3200                                     ; Switch the DC-DC converter for Medipix power supply ON
0D39                3201     ComServ_DCswitchON:
0D39 C2A7           3202             CLR     DCShutdown
0D3B 22             3203             RET
                    3204     ;_______________________________________________________________________________
                    3205                                     ; Switch the DC-DC converter for Medipix power supply OFF
0D3C                3206     ComServ_DCswitchOFF:
0D3C D2A7           3207             SETB    DCShutdown
0D3E 22             3208             RET
                    3209     
                    3210     ;_______________________________________________________________________________
                    3211                                     ; Sets clock for Timepix
0D3F                3212     ComServ_SetTPXClock:
0D3F 121D47         3213             CALL    FT_GetChar              ; Wait for value FREQ and get it to A
                    3214             ; PLL   FREQ
                    3215             ; 10 .. 00 .. 10MHz
                    3216             ; 00 .. 01 .. 20MHz
                    3217             ; 01 .. 10 .. 40MHz
                    3218             ; 11 .. 11 .. 80MHz
0D42 5403           3219             ANL     A,#03h
                    3220     
0D44                3221        CSSTC_0:
0D44 7005           3222             JNZ     CSSTC_1
0D46 D2B4           3223             SETB    Tmpx_FREQ1
0D48 C2B6           3224             CLR     Tmpx_FREQ0
0D4A 22             3225             RET
0D4B                3226        CSSTC_1:
0D4B 15E0           3227             DEC     ACC
0D4D 7005           3228             JNZ     CSSTC_2
0D4F C2B4           3229             CLR     Tmpx_FREQ1
0D51 C2B6           3230             CLR     Tmpx_FREQ0
0D53 22             3231             RET
0D54                3232        CSSTC_2:
0D54 15E0           3233             DEC     ACC
0D56 7005           3234             JNZ     CSSTC_3
0D58 C2B4           3235             CLR     Tmpx_FREQ1
0D5A D2B6           3236             SETB    Tmpx_FREQ0
0D5C 22             3237             RET
0D5D                3238        CSSTC_3:
0D5D D2B4           3239             SETB    Tmpx_FREQ1
0D5F D2B6           3240             SETB    Tmpx_FREQ0
0D61 22             3241             RET
                    3242     ;_______________________________________________________________________________
                    3243                                     ; Receives byte from USB and sets it to HV voltage source
0D62                3244     ComServ_SetBias:
0D62 121D47         3245             CALL    FT_GetChar              ; Wait for value
0D65                3246     SetBias:                                ; Sets bias voltage to value A
                    3247             ; Configure SPI interface:
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    52

0D65 75F833         3248             MOV     SPICON,#SPI_CONFIG_BIAS ; SPI is enabled in Master Mode (I2C is enabled), C
                             POL=0, CPHA=1, frequency Fosc/16
                    3249     
0D68 C2B7           3250             CLR     P3.7                    ; Enable HV source
0D6A F5F7           3251             MOV     SPIDAT,A                ; Send value
0D6C 30FFFD         3252             JNB     ISPI,$                  ; Wait until whole byte is received by SPI
0D6F C2FF           3253             CLR     ISPI
0D71 D2B7           3254             SETB    P3.7                    ; Disable HV source
                    3255     
                    3256             ; Configure SPI interface to maximum speed:
0D73 75F834         3257             MOV     SPICON,#SPI_CONFIG_CLOCK; SPI is enabled in Master Mode (I2C is enabled), C
                             POL=0, CPHA=1, frequency Fosc/2
0D76 22             3258             RET
                    3259     ;_______________________________________________________________________________
                    3260                                     ; Sets HV voltage to initial state
0D77                3261     ComServ_ResetBias:
0D77 E4             3262             CLR     A
0D78 80EB           3263             JMP     SetBias
                    3264     ;_______________________________________________________________________________
                    3265     
0D7A                3266     ComServ_SetDAC:                 ; Receives three bytes from USB
                    3267                                     ; 1. DAC number (0,1)
                    3268                                     ; 2.-3. is DAC code (12 bits) LSB byte first
0D7A 121D47         3269             CALL    FT_GetChar
0D7D 5401           3270             ANL     A,#01h          ; Just 0 or 1 is allowed
0D7F F5F0           3271             MOV     B,A
                    3272     
0D81 121D47         3273             CALL    FT_GetChar
0D84 F582           3274             MOV     DPL,A
0D86 121D47         3275             CALL    FT_GetChar
0D89 540F           3276             ANL     A,#0Fh          ; Just 4 bits in upper byte
0D8B F583           3277             MOV     DPH,A
                    3278     
0D8D E5F0           3279             MOV     A,B
                    3280     
0D8F                3281       SetDAC:                       ; Alternative entry point: Sets DPTR to ADC of number given
                              by A
0D8F 7007           3282             JNZ     SetDAC1
                    3283     
0D91                3284       SetDAC0:
0D91 8583FA         3285             MOV     DAC0H,DPH
0D94 8582F9         3286             MOV     DAC0L,DPL
0D97 22             3287             RET
                    3288     
0D98                3289       SetDAC1:
0D98 8583FC         3290             MOV     DAC1H,DPH
0D9B 8582FB         3291             MOV     DAC1L,DPL
0D9E 22             3292             RET
                    3293     ;_______________________________________________________________________________
                    3294     
0D9F                3295     ComServ_WatchdogTest:
0D9F 80FE           3296             JMP     $
0DA1 22             3297             RET
                    3298     ;_______________________________________________________________________________
                    3299     
0DA2                3300     ComServ_Synchonization:
                    3301     
0DA2 9006AE         3302             MOV     DPTR,#Str_SyncString    ; Send the synchonisation string
0DA5 121D70         3303             CALL    FT_SendString
0DA8 22             3304             RET
                    3305     ;_______________________________________________________________________________
                    3306     
0DA9                3307     ComServ_OscilatingShutter:
                    3308                             ; Will make oscilations on shutter signal until
                    3309                             ; another USB command appears
                    3310     
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    53

                    3311     ; Helper macros
                    3312     ;---------------
                    3313     
                    3314     ; One pulse on Shutter pin (latch has to be transparent)
                    3315     ShutterPinTick  MACRO
                    3316             CPL     P0.7    ; P0.7 is connected to IN8 of the latch, Q8 of the latch is shutter
                    3317             CPL     P0.7    ; => if latch is transparent then P0.7 controls shutter directly
                    3318             ENDM
                    3319     
                    3320     ; 2 pulses on Shutter pin (latch has to be transparent)
                    3321     ShutterPinTick2 MACRO
                    3322             ShutterPinTick
                    3323             ShutterPinTick
                    3324             ENDM
                    3325     
                    3326     ; 4 pulses on Shutter pin (latch has to be transparent)
                    3327     ShutterPinTick4 MACRO
                    3328             ShutterPinTick2
                    3329             ShutterPinTick2
                    3330             ENDM
                    3331     
                    3332     ; 8 pulses on Shutter pin (latch has to be transparent)
                    3333     ShutterPinTick8 MACRO
                    3334             ShutterPinTick4
                    3335             ShutterPinTick4
                    3336             ENDM
                    3337     
                    3338     ; 16 pulses on Shutter pin (latch has to be transparent)
                    3339     ShutterPinTick16        MACRO
                    3340             ShutterPinTick8
                    3341             ShutterPinTick8
                    3342             ENDM
                    3343     
                    3344     ; 32 pulses on Shutter pin (latch has to be transparent)
                    3345     ShutterPinTick32        MACRO
                    3346             ShutterPinTick16
                    3347             ShutterPinTick16
                    3348             ENDM
                    3349     
                    3350     ; 64 pulses on Shutter pin (latch has to be transparent)
                    3351     ShutterPinTick64        MACRO
                    3352             ShutterPinTick32
                    3353             ShutterPinTick32
                    3354             ENDM
                    3355     
                    3356     ; 128 pulses on Shutter pin (latch has to be transparent)
                    3357     ShutterPinTick128       MACRO
                    3358             ShutterPinTick64
                    3359             ShutterPinTick64
                    3360             ENDM
                    3361     
                    3362     ; 256 pulses on Shutter pin (latch has to be transparent)
                    3363     ShutterPinTick256       MACRO
                    3364             ShutterPinTick128
                    3365             ShutterPinTick128
                    3366             ENDM
                    3367     
                    3368     ; Service code is here:
                    3369     ;-----------------------------
                    3370     
0DA9                3371       ShutOscBurst:
0DA9 C2AF           3372             CLR     EA                              ; Disable all interrrupts
0DAB 852180         3373             MOV     M_port,M_CmosIn                 ; Send Medipix CMOS inputs configuration to
                              latch
                    3374             ; Latch has to be transparent now:
0DAE D2A4           3375             SETB    LatchEnable                     ; Enable Medipix CMOS input latch
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    54

0DB0 75F000         3376             MOV     B,#0                            ; Make alays burst of 256 pulses in one bur
                             st
0DB3                3377       ShutOscTick:
                    3378             ShutterPinTick256
                    3379+1           ShutterPinTick128
                    3890+1           ShutterPinTick128
                    4401             ShutterPinTick256                       ; Make 512 pulses on shutter signal  => eac
                             h pulse takes 4 cycles = 200ns i.e. 5MHz
                    4402+1           ShutterPinTick128
                    4913+1           ShutterPinTick128
15B3 D5F00E         5424             DJNZ    B,ShutOscNextTick               ; Takes 4 cycles + 4 cycles of LJMP => two 
                             pulses is skipped
                    5425     
                    5426       ; Burst finished => close the latch
15B6 C2A4           5427             CLR     LatchEnable                     ; Close Medipix CMOS input latch - last M_p
                             ort content is stored in latch
                    5428             RefreshWatchdogBase                     ; Refresh watchdog timer
15BC D2AF           5431             SETB    EA                              ; Reenable interrrupts
                    5432     
                    5433       ; Check USB interface:
15BE 20A306         5434             JB      FT_RxF,ShutOscNextBurst         ; Check if FTDI is ready to read - if not m
                             ake another burst
15C1 D287           5435             SETB    P0.7                            ; Just Ensure that shutter is closed
15C3 22             5436             RET
                    5437     
15C4                5438       ShutOscNextTick:
15C4 020DB3         5439             JMP     ShutOscTick
15C7                5440       ShutOscNextBurst:
15C7 020DA9         5441             JMP     ShutOscBurst
                    5442     
                    5443     ;_______________________________________________________________________________
                    5444     ; Command used for coincidence measurements. Does followind actions:
                    5445     ;       - stops a trigger by macro TriggerStop
                    5446     ;       - EraseMpx (zeroes matrix) - shutter is closed by this command
                    5447     ;       - TODO command2 is set to this command: "=" = ComServ_ResetMpxStartTriggerStartInte
                             rval
                    5448     ;       - Configures interval timer to perform TODO command2
                    5449     ;       - Trigger is configured to perform CloseShutter
                    5450     ;       - Opens a shutter
                    5451     ;       - Restarts interval by call of IntervalRestart
                    5452     ;       - Starts trigger
                    5453     
15CA                5454     ComServ_ResetMpxStartTriggerStartInterval:
                    5455             TriggerStop
15CC 120967         5457             CALL    ComServ_EraseMatrix
15CF 74FA           5458             MOV     A,#250
15D1 121CCF         5459             CALL    WaitMicroseconds                ; Wait a little bit to avoid immediate trig
                             ger caused by EraseMatrix
                    5460     
15D4 75683D         5461             MOV     TODO_Command2,#'='              ; TODO command2 is this function i.e. ComSe
                             rv_ResetMpxStartTriggerStartInterval
                    5462     
15D7 E53C           5463             MOV     A,INTERVAL_TODO
15D9 C2E2           5464             CLR     TODO_StartInterval
15DB C2E4           5465             CLR     TODO_StartTrigger
15DD C2E0           5466             CLR     TODO_CloseShutter
15DF D2E7           5467             SETB    TODO_MakeCommand2
15E1 F53C           5468             MOV     INTERVAL_TODO,A                 ; When Interval is finished then TODO Comma
                             nd2 is executed
                    5469     
15E3 E558           5470             MOV     A,TRIGGER_TODO
15E5 C2E2           5471             CLR     TODO_StartInterval
15E7 C2E4           5472             CLR     TODO_StartTrigger
                    5473             ;SETB   TODO_StartScope
15E9 D2E0           5474             SETB    TODO_CloseShutter
                    5475             ;SETB   TODO_MakeCommand2
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    55

15EB F558           5476             MOV     TRIGGER_TODO,A                  ; When trigger is detected then shutter is 
                             closed and data transmitted
                    5477     
15ED D1E8           5478             CALL    IntervalRestart                 ; Interval is restarted => ComServ_ResetMpx
                             StartTriggerStartInterval will be called after
                    5479             OpenShutter                             ; Shutter is opened
                    5482+1           SET_CmosIn              ; Set correct M0 and M1 (needed for timepix, can't be combi
                             ned with M_Shutter - it must follow)
                    5487+1           SET_CmosIn              ; Shutter is open now
                    5491             TriggerStart                            ; Waiting for trigger is started
160B 22             5497             RET
                    5498     
                    5499     
                    5500     ;_______________________________________________________________________________
                    5501     ; Jump to bootloader:
                    5502     
160C                5503     ComServ_Flash:
160C C3             5504             CLR     C
160D 121D47         5505             CALL    FT_GetChar
1610 946C           5506             SUBB    A,#'l'
1612 7021           5507             JNZ     ComServ_Flash_Invalid
1614 121D47         5508             CALL    FT_GetChar
1617 9461           5509             SUBB    A,#'a'
1619 701A           5510             JNZ     ComServ_Flash_Invalid
161B 121D47         5511             CALL    FT_GetChar
161E 9473           5512             SUBB    A,#'s'
1620 7013           5513             JNZ     ComServ_Flash_Invalid
1622 121D47         5514             CALL    FT_GetChar
1625 9468           5515             SUBB    A,#'h'
1627 700C           5516             JNZ     ComServ_Flash_Invalid
                    5517     
1629 75C700         5518             MOV     EADRH,#0
162C 75C600         5519             MOV     EADRL,#0
162F 75B905         5520             MOV     ECON,#FLASH_ERASE               ; Erase the checksum page
1632 02E000         5521             JMP     0E000h                          ; Jump to bootloader
                    5522     
1635                5523       ComServ_Flash_Invalid:
1635 22             5524             RET
                    5525     
                    5526     ;_______________________________________________________________________________
                    5527     ; Test of LVDS lines: Requires three parameters:
                    5528     ;       1. Lower nible of SPICON reg.   : 0   0   0   0   CPOL   CPHA  SPR1  SPR2
                    5529     ;          CPOL - Clock polarity bit (1 = clock idles high, 0 = clock idles low)
                    5530     ;          CPHA - Clock phase bit    (1 = leading SCLOCK edge transmits data, 0 = trailing 
                             SCLOCK edge transmits data)
                    5531     ;       2. Enable_In pin state 1=High, 0=Low
                    5532     ;       3. Byte to be sent via SPI
                    5533     ; Returns two bytes:
                    5534     ;       1. Byte received from SPI
                    5535     ;       2. State of Enable_Out input pin
                    5536     ; Command ':'
                    5537     
1636                5538     ComServ_LVDSTest:
1636 C3             5539             CLR     C
1637 121D47         5540             CALL    FT_GetChar
163A 540F           5541             ANL     A,#0Fh          ; Ensure that higher nible is zero
163C 4430           5542             ORL     A,#30h          ; SPI is enabled in Master Mode
                    5543     
163E F5F8           5544             MOV     SPICON,A        ; Configure SPI
                    5545     
1640 121D47         5546             CALL    FT_GetChar
1643 A2E0           5547             MOV     C, ACC.0
1645 92A6           5548             MOV     M_EnableIn,C    ; Set Enable In to desired state
                    5549     
1647 121D47         5550             CALL    FT_GetChar      ; Get data to be sent
164A F5F7           5551             MOV     SPIDAT,A        ; Transmit the data
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    56

164C 30FFFD         5552             JNB     ISPI,$          ; Wait until whole byte is received by SPI
164F C2FF           5553             CLR     ISPI
                    5554     
1651 E5F7           5555             MOV     A,SPIDAT        ; Get received data
1653 121D3F         5556             CALL    FT_SendChar     ; Send the data via USB
                    5557     
1656 E4             5558             CLR     A
1657 A2A5           5559             MOV     C, M_EnableOut
1659 92E0           5560             MOV     ACC.0,C         ; Get state of Enable Out pin
165B 121D3F         5561             CALL    FT_SendChar     ; Send it via USB
                    5562     
165E 75F834         5563             MOV     SPICON,#SPI_CONFIG_MPX  ; Restore SPI configuration
1661 C3             5564             CLR     C
1662 22             5565             RET
                    5566     
                    5567     ;_______________________________________________________________________________
                    5568     ; Test of CMOS lines:
                    5569     ;       One input parameter - byte = CMOSIn
                    5570     ; Command 'I'
                    5571     
1663                5572     ComServ_CMOSTest:
1663 C3             5573             CLR     C
1664 8521F0         5574             MOV     B,M_CmosIn
1667 121D47         5575             CALL    FT_GetChar
166A F521           5576             MOV     M_CmosIn,A
                    5577             SET_CmosIn
1673 85F021         5581             MOV     M_CmosIn,B
1676 C3             5582             CLR     C
1677 22             5583             RET
                    5584     
                    5585     ;_______________________________________________________________________________
                    5586     ; Test of I2C lines:
                    5587     ;       One input parameter  - "X 0 0 0  0 0 SDA SCL"   or   "X 0 0 0  0 0 Tmpx_FREQ1 Tmpx_
                             FREQ0" if X is High then data will be just read (not written i.e. SDA and SCL bits are ignored)
                    5588     ;       One output parameter - "0 0 0 0  0 0 SDA SCL"   or   "0 0 0 0  0 0 Tmpx_FREQ1 Tmpx_
                             FREQ0"
                    5589     ; Command '\''
                    5590     
1678                5591     ComServ_I2CTest:
1678 C3             5592             CLR     C
1679 121D47         5593             CALL    FT_GetChar
                    5594     
167C 20E708         5595             JB      ACC.7, I2CTest_JustRead
                    5596     
167F A2E0           5597             MOV     C,ACC.0         ;
1681 92B6           5598             MOV     SCL_I2C, C      ; Set SCL (Tmpx_FREQ0)
                    5599     
1683 A2E1           5600             MOV     C,ACC.1         ;
1685 92B4           5601             MOV     SDA_I2C, C      ; Set SDA (Tmpx_FREQ1)
                    5602     
1687                5603       I2CTest_JustRead:
1687 E4             5604             CLR     A
1688 A2B6           5605             MOV     C, SCL_I2C
168A 92E0           5606             MOV     ACC.0,C         ; Get SCL_I2C (Tmpx_FREQ0)
168C A2B4           5607             MOV     C, SDA_I2C
168E 92E1           5608             MOV     ACC.1,C         ; Get SDA_I2C (Tmpx_FREQ1)
                    5609     
1690 121D3F         5610             CALL    FT_SendChar
                    5611     
1693 C3             5612             CLR     C
1694 22             5613             RET
                    5614     
                    5615     ;===============================================================================
                    5616     ; Interval timer
                    5617     ;===============================================================================
                    5618     
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    57

1695                5619     IntervalDefault:        ; Clears all registers and sets default Interval of 0.5 sec
                    5620     
1695 D1AF           5621             CALL    IntervalClear
1697 7537FF         5622             MOV     INTERVAL_TIME+5,#0FFh
169A 7536FF         5623             MOV     INTERVAL_TIME+4,#0FFh
169D 7535FF         5624             MOV     INTERVAL_TIME+3,#0FFh
16A0 753467         5625             MOV     INTERVAL_TIME+2,#067h
16A3 753369         5626             MOV     INTERVAL_TIME+1,#069h
16A6 75327F         5627             MOV     INTERVAL_TIME+0,#07Fh
                    5628     
16A9 E4             5629             CLR     A
16AA D2E0           5630             SETB    TODO_CloseShutter               ; Default TODO action is to close the shutt
                             er
16AC F53C           5631             MOV     INTERVAL_TODO,A
16AE 22             5632             RET
                    5633     
16AF                5634     IntervalClear:          ; Erase all registers of Interval timer (12 bytes from address INTE
                             RVAL_TIME)
                    5635     
16AF C000           5636             PUSH    00
16B1 C0F0           5637             PUSH    B
16B3 C0E0           5638             PUSH    ACC
                    5639     
                    5640             IntervalStop
16B9 7832           5643             MOV     R0,#INTERVAL_TIME
16BB 75F010         5644             MOV     B,#16
16BE E4             5645             CLR     A
16BF                5646         ClearTimer_:
16BF F6             5647             MOV     @R0,A
16C0 08             5648             INC     R0
16C1 D5F0FB         5649             DJNZ    B,ClearTimer_
                    5650     
16C4 D0E0           5651             POP     ACC
16C6 D0F0           5652             POP     B
16C8 D000           5653             POP     00
16CA 22             5654             RET
                    5655     
16CB                5656     IntervalMeasure:        ; Starts interval timer
                    5657                             ; INTERVAL_CURR register is cleared
                    5658                             ; T0 registers are cleared
                    5659                             ; INTERVAL_MODE is cleared
                    5660                             ; T0 is started => Timer is counting clocks - interupt can occur in
                              162 days :-)
                    5661     
                    5662             IntervalStop                            ; Stop the timer
16CF C0E0           5665             PUSH    ACC
16D1 E4             5666             CLR     A
16D2 F58A           5667             MOV     TL0, A
16D4 F58C           5668             MOV     TH0, A                          ; T0 is cleared
16D6 F538           5669             MOV     INTERVAL_CURR, A
16D8 F539           5670             MOV     INTERVAL_CURR+1, A
16DA F53A           5671             MOV     INTERVAL_CURR+2, A
16DC F53B           5672             MOV     INTERVAL_CURR+3, A              ; INTERVAL_CURR register is cleared
16DE 753D00         5673             MOV     INTERVAL_MODE,#0                ; INTERVAL_MODE is 0 => we are measuring
16E1 D0E0           5674             POP     ACC
                    5675             IntervalStart
16E7 22             5678             RET
                    5679     
16E8                5680     IntervalRestart:        ; Restarts interval timer:
                    5681                             ; Sets INTERVAL_CURR register to preselected INTERVAL_TIME
                    5682                             ; INTERVAL_MODE is set to 1 (=> normal overflow handling)
                    5683                             ; Sets T0 registers and starts the timer
                    5684     
                    5685             IntervalStop                            ; Stop the timer
16EC 85328A         5688             MOV     TL0, INTERVAL_TIME
16EF 85338C         5689             MOV     TH0, INTERVAL_TIME+1            ; Lower two bytes are copied directly to T0
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    58

16F2 853438         5690             MOV     INTERVAL_CURR,INTERVAL_TIME+2
16F5 853539         5691             MOV     INTERVAL_CURR+1,INTERVAL_TIME+3
16F8 85363A         5692             MOV     INTERVAL_CURR+2,INTERVAL_TIME+4
16FB 85373B         5693             MOV     INTERVAL_CURR+3,INTERVAL_TIME+5 ; Upper four bytes are copied to INTERVAL_C
                             URR register
                    5694     
16FE 753D01         5695             MOV     INTERVAL_MODE,#1                ; INTERVAL_MODE is 1 => we are generating a
                             n interrupt
                    5696             IntervalStart                           ; Start the timer again
1705 22             5699             RET
                    5700     
                    5701     ;_______________________________________________________________________________
                    5702     
1706                5703     ComServ_IntervalExpositionSet:
                    5704                             ; Combination of ComServ_IntervalSet which takes interval parameter
                             s from USB
                    5705                             ; and ComServ_IntervalExposition which starts IntervalExposition
                    5706     
1706 F17D           5707             call    ComServ_IntervalSet
                    5708     
1708                5709     ComServ_IntervalExposition:
                    5710                             ; Just alias for IntervalExposition
1708                5711     IntervalExposition:
                    5712                             ; Refils INTERVAL_CURR and T0 by content of INTERVAL_TIME
                    5713                             ; Opens shutter and starts Interval timer
                    5714     
                    5715     
                    5716             PeriodStop
                    5719             IntervalStop
                    5722             TriggerStop
                    5724             CounterStop                             ; Stop all processes
                    5727     
1716 121A45         5728             CALL    FrameCounterRestart             ; Restarts frame counter
                    5729     
1719 E4             5730             CLR     A
171A D2E0           5731             SETB    TODO_CloseShutter
171C F53C           5732             MOV     INTERVAL_TODO,A                 ; When Interval is finished then shutter wi
                             ll be closed and data transmitted
                    5733     
171E E4             5734             CLR     A
171F F566           5735             MOV     FRAME_TODO,A                    ; When data are transfered no action will b
                             e taken
                    5736     
1721 D1E8           5737             CALL    IntervalRestart
                    5738             OpenShutter
                    5741+1           SET_CmosIn              ; Set correct M0 and M1 (needed for timepix, can't be combi
                             ned with M_Shutter - it must follow)
                    5746+1           SET_CmosIn              ; Shutter is open now
1737 22             5750             RET
                    5751     
                    5752     
                    5753     ;_______________________________________________________________________________
                    5754     
1738                5755     ComServ_IntervalMultiExposition:
                    5756     
                    5757             PeriodStop
                    5760             IntervalStop
                    5763             TriggerStop
                    5765             CounterStop                             ; Stop all processes
                    5768     
1746 121A45         5769             CALL    FrameCounterRestart             ; Restart frame counter
                    5770     
1749 E4             5771             CLR     A
174A D2E0           5772             SETB    TODO_CloseShutter
174C F53C           5773             MOV     INTERVAL_TODO,A                 ; When Interval is finished then shutter wi
                             ll be closed and data transmitted
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    59

                    5774     
174E E4             5775             CLR     A
174F D2E2           5776             SETB    TODO_StartInterval
1751 D2E1           5777             SETB    TODO_OpenShutter
1753 F566           5778             MOV     FRAME_TODO,A                    ; When frame data are transfered the shutte
                             r wiil be opened and interval restarted
                    5779     
1755 D1E8           5780             CALL    IntervalRestart
                    5781             OpenShutter
                    5784+1           SET_CmosIn              ; Set correct M0 and M1 (needed for timepix, can't be combi
                             ned with M_Shutter - it must follow)
                    5789+1           SET_CmosIn              ; Shutter is open now
176B 22             5793             RET
                    5794     ;_______________________________________________________________________________
                    5795     
176C                5796     ComServ_AbortExposition:; Stops Current interval,
                    5797                             ; Closes shutter if it is opened, sends data (only if shutter was o
                             pened)
                    5798     
176C 12018D         5799             call    CloseShutterInt                 ; Close the shutter and stops interval
                    5800             PeriodStop
                    5803             CounterStop
                    5806             TriggerStop
1779 121A45         5808             CALL FrameCounterRestart
177C 22             5809             RET
                    5810     ;_______________________________________________________________________________
                    5811     
177D                5812     ComServ_IntervalSet:    ; Receives:
                    5813                             ; 6 bytes from USB (LSB byte first) and stores them in INTERVAL_TIM
                             E register
                    5814                             ; 7th byte is TODO mask
                    5815     
177D 7832           5816             MOV     R0,#INTERVAL_TIME
177F 75F006         5817             MOV     B,#6
1782                5818       OneIntervalByte:
1782 121D47         5819             CALL    FT_GetChar
1785 F4             5820             CPL     A
1786 F6             5821             MOV     @R0,A
1787 08             5822             INC     R0
1788 D5F0F7         5823             DJNZ    B,OneIntervalByte
                    5824     
178B 121D47         5825             CALL    FT_GetChar
178E F53C           5826             MOV     INTERVAL_TODO,A
1790 22             5827             RET
                    5828     ;_______________________________________________________________________________
                    5829     
1791                5830     ComServ_IntervalReset:
1791 D1CB           5831             CALL    IntervalMeasure
1793 22             5832             RET
                    5833     ;_______________________________________________________________________________
                    5834     
1794                5835     ComServ_IntervalStop:
                    5836             IntervalStop
1798 22             5839             RET
                    5840     ;_______________________________________________________________________________
                    5841     
1799                5842     ComServ_IntervalState:  ; Sends current status of Interfval Timer to FTDI
                    5843                             ;  1.    byte = run state: bit 0 = Is running (TR0), bit 1 = Is int
                             rrupt ensbled (ET0)
                    5844                             ;  2.    byte = INTERVAL_TODO mask
                    5845                             ;  3.-8. byte = INTERVAL_TIME (LSB byte first)
                    5846                             ;  9.-14.byte = INTERVAL_CURR (LSB byte first)
                    5847     
1799 E4             5848             CLR     A
179A A28C           5849             MOV     C,TR0
179C 92E0           5850             MOV     ACC.0,C
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    60

179E A2A9           5851             MOV     C,ET0
17A0 92E1           5852             MOV     ACC.1,C
17A2 121D3F         5853             CALL    FT_SendChar             ; Send flags (1. bit = Running, 2. bit = Interrupt 
                             Enable)
17A5 C3             5854             CLR     C
                    5855     
17A6 E53C           5856             MOV     A, INTERVAL_TODO
17A8 121D3F         5857             CALL    FT_SendChar             ; Send INTERVAL_TODO mask
                    5858     
17AB 75F006         5859             MOV     B,#6
17AE 7832           5860             MOV     R0,#INTERVAL_TIME
17B0                5861       OneIntervalByteSend:
17B0 E6             5862             MOV     A,@R0
17B1 F4             5863             CPL     A
17B2 121D3F         5864             CALL    FT_SendChar
17B5 08             5865             INC     R0
17B6 D5F0F7         5866             DJNZ    B,OneIntervalByteSend
                    5867     
17B9 858A82         5868             MOV     DPL,TL0
17BC 858C83         5869             MOV     DPH,TH0
17BF E582           5870             MOV     A,DPL
17C1 F4             5871             CPL     A
17C2 121D3F         5872             CALL    FT_SendChar
17C5 E583           5873             MOV     A,DPH
17C7 F4             5874             CPL     A
17C8 121D3F         5875             CALL    FT_SendChar
17CB E538           5876             MOV     A,INTERVAL_CURR
17CD F4             5877             CPL     A
17CE 121D3F         5878             CALL    FT_SendChar
17D1 E539           5879             MOV     A,INTERVAL_CURR+1
17D3 F4             5880             CPL     A
17D4 121D3F         5881             CALL    FT_SendChar
17D7 E53A           5882             MOV     A,INTERVAL_CURR+2
17D9 F4             5883             CPL     A
17DA 121D3F         5884             CALL    FT_SendChar
17DD E53B           5885             MOV     A,INTERVAL_CURR+3
17DF F4             5886             CPL     A
17E0 121D3F         5887             CALL    FT_SendChar
17E3 22             5888             RET
                    5889     
                    5890     ;_______________________________________________________________________________
                    5891     
17E4                5892     ComServ_IntervalElapsedTime:
17E4                5893     IntervalElapsedTime:    ; Computes elapsed interval time:
                    5894                             ; - if INTERVAL_MODE is 0 => interval has been measured, current va
                             lue is transmitted without any change
                    5895                             ; - if INTERVAL_MODE is 1 => interval generates an interrupt, curre
                             nt value is subtracted from INTERVAL_TIME and transmitted
                    5896                             ; Anyway it will transmit 6 bytes with elapsed time information (LS
                             B first).
                    5897     
17E4 E53D           5898             MOV     A,INTERVAL_MODE
17E6 7022           5899             JNZ     ITS_InterruptMode
                    5900     
17E8                5901       ITA_MeasureMode:
17E8 858A82         5902             MOV     DPL,TL0
17EB 858C83         5903             MOV     DPH,TH0
17EE E582           5904             MOV     A,DPL
17F0 121D3F         5905             CALL    FT_SendChar
17F3 E583           5906             MOV     A,DPH
17F5 121D3F         5907             CALL    FT_SendChar
17F8 E538           5908             MOV     A,INTERVAL_CURR
17FA 121D3F         5909             CALL    FT_SendChar
17FD E539           5910             MOV     A,INTERVAL_CURR+1
17FF B13F           5911             CALL    FT_SendChar
1801 E53A           5912             MOV     A,INTERVAL_CURR+2
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    61

1803 B13F           5913             CALL    FT_SendChar
1805 E53B           5914             MOV     A,INTERVAL_CURR+3
1807 B13F           5915             CALL    FT_SendChar
1809 22             5916             RET
                    5917     
180A                5918       ITS_InterruptMode:
180A 858A82         5919             MOV     DPL,TL0
180D 858C83         5920             MOV     DPH,TH0
                    5921     
1810 C3             5922             CLR     C
1811 E582           5923             MOV     A,DPL
1813 9532           5924             SUBB    A,INTERVAL_TIME
1815 B13F           5925             CALL    FT_SendChar
1817 E583           5926             MOV     A,DPH
1819 9533           5927             SUBB    A,INTERVAL_TIME+1
181B B13F           5928             CALL    FT_SendChar
181D E538           5929             MOV     A,INTERVAL_CURR
181F 9534           5930             SUBB    A,INTERVAL_TIME+2
1821 B13F           5931             CALL    FT_SendChar
1823 E539           5932             MOV     A,INTERVAL_CURR+1
1825 9535           5933             SUBB    A,INTERVAL_TIME+3
1827 B13F           5934             CALL    FT_SendChar
1829 E53A           5935             MOV     A,INTERVAL_CURR+2
182B 9536           5936             SUBB    A,INTERVAL_TIME+4
182D B13F           5937             CALL    FT_SendChar
182F E53B           5938             MOV     A,INTERVAL_CURR+3
1831 9537           5939             SUBB    A,INTERVAL_TIME+5
1833 B13F           5940             CALL    FT_SendChar
1835 22             5941             RET
                    5942     
                    5943     ;===============================================================================
                    5944     ; Counter
                    5945     ;===============================================================================
                    5946     
1836                5947     CounterDefault:         ; Clears all registers and sets default Vector and Service
                    5948     
1836 1152           5949             CALL    CounterClear
1838 754EFF         5950             MOV     COUNTER_COUNT+5,#0FFh
183B 754DFF         5951             MOV     COUNTER_COUNT+4,#0FFh
183E 754CFF         5952             MOV     COUNTER_COUNT+3,#0FFh
1841 754BFF         5953             MOV     COUNTER_COUNT+2,#0FFh
1844 754AFF         5954             MOV     COUNTER_COUNT+1,#0FFh
1847 7549FE         5955             MOV     COUNTER_COUNT+0,#0FEh
                    5956     
184A E4             5957             CLR     A
184B D2E5           5958             SETB    TODO_StartCounter
184D D2E0           5959             SETB    TODO_CloseShutter
184F F553           5960             MOV     COUNTER_TODO,A
1851 22             5961             RET
                    5962     
1852                5963     CounterClear:           ; Clears all registers used by Counter
                    5964     
1852 C000           5965             PUSH    00
1854 C0F0           5966             PUSH    B
1856 C0E0           5967             PUSH    ACC
                    5968     
                    5969             CounterStop
185C 7849           5972             MOV     R0,#COUNTER_COUNT
185E 75F00F         5973             MOV     B,#15
1861 E4             5974             CLR     A
1862                5975         ClearCounter_:
1862 F6             5976             MOV     @R0,A
1863 08             5977             INC     R0
1864 D5F0FB         5978             DJNZ    B,ClearCounter_
                    5979     
1867 D0E0           5980             POP     ACC
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    62

1869 D0F0           5981             POP     B
186B D000           5982             POP     00
186D 22             5983             RET
                    5984     
186E                5985     ComServ_CounterStart:   ; Alias for CounterRestart
                    5986     
                    5987     ;CounterRestart:                ; Restarts counter:
                    5988                             ; Sets COUNTER_CURR register to preselected COUNTER_COUNT
                    5989                             ; Sets T1 registers and starts the timer
                    5990     
                    5991     ;       CounterStop                             ; Stop the timer
                    5992     ;       MOV     TL1, COUNTER_COUNT
                    5993     ;       MOV     TH1, COUNTER_COUNT+1            ; Lower two bytes are copied directly to T1
                    5994     ;       MOV     COUNTER_CURR,COUNTER_COUNT+2
                    5995     ;       MOV     COUNTER_CURR+1,COUNTER_COUNT+3
                    5996     ;       MOV     COUNTER_CURR+2,COUNTER_COUNT+4
                    5997     ;       MOV     COUNTER_CURR+3,COUNTER_COUNT+5  ; Upper four bytes are copied to COUNTER_CU
                             RR register
                    5998     ;       CounterStart                            ; Start the timer again
                    5999     ;       RET
                    6000     
                    6001     ;_______________________________________________________________________________
                    6002     
186E                6003     ComServ_CounterSet:     ; Receives:
                    6004                             ; 6 bytes from USB (LSB byte first) and stores them in COUNTER_COUN
                             T register
                    6005                             ; 7th byte is TODO mask
                    6006     
186E 7849           6007             MOV     R0,#COUNTER_COUNT
1870 75F006         6008             MOV     B,#6
1873                6009       OneCounterByte:
1873 B147           6010             CALL    FT_GetChar
1875 F4             6011             CPL     A
1876 F6             6012             MOV     @R0,A
1877 08             6013             INC     R0
1878 D5F0F8         6014             DJNZ    B,OneCounterByte
                    6015     
187B B147           6016             CALL    FT_GetChar
187D F553           6017             MOV     COUNTER_TODO,A
                    6018     
187F C3             6019             CLR     C               ; CY=0 means no error
1880 22             6020             RET
                    6021     
                    6022     ;_______________________________________________________________________________
                    6023     
1881                6024     ComServ_CounterStop:
                    6025             CounterStop
1885 22             6028             RET
                    6029     ;_______________________________________________________________________________
                    6030     
                    6031     ;ComServ_CounterState:  ; Sends current status of Counter to FTDI
                    6032                             ;  1.    byte = run state: bit 0 = Is running (TR1), bit 1 = Is int
                             rrupt ensbled (ET1)
                    6033                             ;  2.    byte = COUNTER_TODO mask
                    6034                             ;  3.-8. byte = COUNTER_COUNT (LSB byte first)
                    6035                             ;  9.-14.byte = COUNTER_CURR (LSB byte first)
                    6036     
                    6037     ;        CLR    A
                    6038     ;        MOV    C,TR1
                    6039     ;        MOV    ACC.0,C
                    6040     ;        MOV    C,ET1
                    6041     ;        MOV    ACC.1,C
                    6042     ;        CALL    FT_SendChar             ; Send flags (1. bit = Running, 2. bit = Interrupt
                              Enable)
                    6043     ;        CLR    C;;;
                    6044     
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    63

                    6045     ;       MOV     A, COUNTER_TODO
                    6046     ;        CALL    FT_SendChar             ; Send COUNTER_TODO mask;
                    6047     
                    6048     ;       MOV     B,#6
                    6049     ;       MOV     R0,#COUNTER_COUNT
                    6050     ;  OneCounterByteSend:
                    6051     ;       MOV     A,@R0
                    6052     ;       CPL     A
                    6053     ;       CALL    FT_SendChar;
                    6054     ;       INC     R0
                    6055     ;       DJNZ    B,OneCounterByteSend
                    6056     
                    6057     ;       MOV     DPL,TL1
                    6058     ;       MOV     DPH,TH1
                    6059     ;       MOV     A,DPL
                    6060     ;       CPL     A
                    6061     ;       CALL    FT_SendChar
                    6062     ;       MOV     A,DPH
                    6063     ;       CPL     A
                    6064     ;       CALL    FT_SendChar
                    6065     ;       MOV     A,COUNTER_CURR
                    6066     ;       CPL     A
                    6067     ;       CALL    FT_SendChar
                    6068     ;       MOV     A,COUNTER_CURR+1
                    6069     ;       CPL     A
                    6070     ;       CALL    FT_SendChar
                    6071     ;       MOV     A,COUNTER_CURR+2
                    6072     ;       CPL     A
                    6073     ;       CALL    FT_SendChar
                    6074     ;       MOV     A,COUNTER_CURR+3
                    6075     ;       CPL     A
                    6076     ;       CALL    FT_SendChar
                    6077     ;        RET
                    6078     
                    6079     ;===============================================================================
                    6080     ; Period
                    6081     ;===============================================================================
                    6082     
1886                6083     PeriodDefault:          ; Clears all and sets default Period time to 1 sec
                    6084     
1886 11A5           6085             CALL    PeriodClear
1888 7543FF         6086             MOV     PERIOD_TIME+5,#0FFh
188B 7542FF         6087             MOV     PERIOD_TIME+4,#0FFh
188E 7541FF         6088             MOV     PERIOD_TIME+3,#0FFh
1891 7541FE         6089             MOV     PERIOD_TIME+3,#0feh
1894 7540CE         6090             MOV     PERIOD_TIME+2,#0ceh
1897 753FD2         6091             MOV     PERIOD_TIME+1,#0d2h
189A 753EFF         6092             MOV     PERIOD_TIME+0,#0ffh
                    6093     
189D E4             6094             CLR     A
189E D2E2           6095             SETB    TODO_StartInterval              ; The Interval will be launched each period
18A0 D2E1           6096             SETB    TODO_OpenShutter                ; The shutter will be opened at the beginin
                             g of each period
18A2 F548           6097             MOV     PERIOD_TODO,A
18A4 22             6098             RET
                    6099     
18A5                6100     PeriodClear:            ; Clears all registers used by Period
                    6101     
18A5 C000           6102             PUSH    00
18A7 C0F0           6103             PUSH    B
18A9 C0E0           6104             PUSH    ACC
                    6105     
                    6106             PeriodStop
18AF 783E           6109             MOV     R0,#PERIOD_TIME
18B1 75F00F         6110             MOV     B,#15
18B4 E4             6111             CLR     A
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    64

18B5                6112         ClearPeriod_:
18B5 F6             6113             MOV     @R0,A
18B6 08             6114             INC     R0
18B7 D5F0FB         6115             DJNZ    B,ClearPeriod_
                    6116     
18BA D0E0           6117             POP     ACC
18BC D0F0           6118             POP     B
18BE D000           6119             POP     00
18C0 22             6120             RET
                    6121     
                    6122     
18C1                6123     ComServ_PeriodStart:    ; Just alias for PeriodRestart
                    6124     
18C1                6125     PeriodRestart:          ; Restarts period timer:
                    6126                             ; Sets PERIOD_CURR register to preselected PERIOD_TIME
                    6127                             ; Sets T2 registers and starts the timer
                    6128     
                    6129             PeriodStop                              ; Stop the timer
18C5 853ECC         6132             MOV     TL2, PERIOD_TIME
18C8 853FCD         6133             MOV     TH2, PERIOD_TIME+1              ; Lower two bytes are copied directly to T0
18CB 854044         6134             MOV     PERIOD_CURR,PERIOD_TIME+2
18CE 854145         6135             MOV     PERIOD_CURR+1,PERIOD_TIME+3
18D1 854246         6136             MOV     PERIOD_CURR+2,PERIOD_TIME+4
18D4 854347         6137             MOV     PERIOD_CURR+3,PERIOD_TIME+5     ; Upper four bytes are copied to PERIOD_CUR
                             R register
                    6138             PeriodStart                             ; Start the timer again
18DB 22             6141             RET
                    6142     
                    6143     ;_______________________________________________________________________________
                    6144     
18DC                6145     ComServ_PeriodSet:      ; Receives:
                    6146                             ; - 6 bytes from USB (LSB byte first) and stores them in PERIOD_COU
                             NT register
                    6147                             ; - 7th byte is TODO mask
                    6148     
18DC 783E           6149             MOV     R0,#PERIOD_TIME
18DE 75F006         6150             MOV     B,#6
18E1                6151       OnePeriodByte:
18E1 B147           6152             CALL    FT_GetChar
18E3 F4             6153             CPL     A
18E4 F6             6154             MOV     @R0,A
18E5 08             6155             INC     R0
18E6 D5F0F8         6156             DJNZ    B,OnePeriodByte
                    6157     
18E9 B147           6158             CALL    FT_GetChar
18EB F548           6159             MOV     PERIOD_TODO,A
18ED 22             6160             RET
                    6161     
                    6162     ;_______________________________________________________________________________
                    6163     
18EE                6164     ComServ_PeriodStop:
                    6165             PeriodStop
18F2 22             6168             RET
                    6169     ;_______________________________________________________________________________
                    6170     
18F3                6171     ComServ_PeriodState:    ; Sends current status of Period to FTDI
                    6172                             ;  1.    byte = run state: bit 0 = Is running (TR2), bit 1 = Is int
                             rrupt ensbled (ET2)
                    6173                             ;  2.    byte = PERIOD_TODO mask
                    6174                             ;  3.-8. byte = PERIOD_COUNT (LSB byte first)
                    6175                             ;  9.-14.byte = PERIOD_CURR (LSB byte first)
                    6176     
18F3 E4             6177             CLR     A
18F4 A2CA           6178             MOV     C,TR2
18F6 92E0           6179             MOV     ACC.0,C
18F8 A2AD           6180             MOV     C,ET2
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    65

18FA 92E1           6181             MOV     ACC.1,C
18FC B13F           6182             CALL    FT_SendChar             ; Send flags (1. bit = Running, 2. bit = Interrupt 
                             Enable)
18FE C3             6183             CLR     C
                    6184     
18FF E548           6185             MOV     A, PERIOD_TODO
1901 B13F           6186             CALL    FT_SendChar             ; Send PERIOD_TODO mask
                    6187     
1903 75F006         6188             MOV     B,#6
1906 783E           6189             MOV     R0,#PERIOD_TIME
1908                6190       OnePeriodByteSend:
1908 E6             6191             MOV     A,@R0
1909 F4             6192             CPL     A
190A B13F           6193             CALL    FT_SendChar
190C 08             6194             INC     R0
190D D5F0F8         6195             DJNZ    B,OnePeriodByteSend
                    6196     
1910 85CC82         6197             MOV     DPL,TL2
1913 85CD83         6198             MOV     DPH,TH2
1916 E582           6199             MOV     A,DPL
1918 F4             6200             CPL     A
1919 B13F           6201             CALL    FT_SendChar
191B E583           6202             MOV     A,DPH
191D F4             6203             CPL     A
191E B13F           6204             CALL    FT_SendChar
1920 E544           6205             MOV     A,PERIOD_CURR
1922 F4             6206             CPL     A
1923 B13F           6207             CALL    FT_SendChar
1925 E545           6208             MOV     A,PERIOD_CURR+1
1927 F4             6209             CPL     A
1928 B13F           6210             CALL    FT_SendChar
192A E546           6211             MOV     A,PERIOD_CURR+2
192C F4             6212             CPL     A
192D B13F           6213             CALL    FT_SendChar
192F E547           6214             MOV     A,PERIOD_CURR+3
1931 F4             6215             CPL     A
1932 B13F           6216             CALL    FT_SendChar
1934 22             6217             RET
                    6218     
1935                6219     ComServ_PeriodicalExposition:
                    6220                             ; Refils PERIOD_CURR and T0 by content of PERIOD_TIME
                    6221                             ; Starts period timer
                    6222             PeriodStop
                    6225             IntervalStop
                    6228             TriggerStop
                    6230             CounterStop                             ; Stop all processes
                    6233     
1943 5145           6234             CALL    FrameCounterRestart             ; Restart frame counter
                    6235     
1945 E4             6236             CLR     A
1946 D2E2           6237             SETB    TODO_StartInterval              ; The Interval will be launched each period
1948 D2E1           6238             SETB    TODO_OpenShutter                ; The shutter will be opened at the beginin
                             g of each period
194A F548           6239             MOV     PERIOD_TODO,A
                    6240     
194C E4             6241             CLR     A
194D D2E0           6242             SETB    TODO_CloseShutter               ; The shutter will be closed at the end of 
                             each interval
194F F53C           6243             MOV     INTERVAL_TODO,A
                    6244     
1951 11C1           6245             CALL    PeriodRestart                   ; Restart period
1953 1216E8         6246             CALL    IntervalRestart                 ; Restart the interval
                    6247             OpenShutter                             ; Opens the shutter
                    6250+1           SET_CmosIn              ; Set correct M0 and M1 (needed for timepix, can't be combi
                             ned with M_Shutter - it must follow)
                    6255+1           SET_CmosIn              ; Shutter is open now
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    66

196A 22             6259             RET
                    6260     
                    6261     ;===============================================================================
                    6262     ; Trigger
                    6263     ;===============================================================================
                    6264     
196B                6265     TriggerDefault:         ; Clears all registers and sets default Vector and Service
                    6266     
196B 3190           6267             CALL    TriggerClear
                    6268     
                    6269             ; Default TODO mask:
196D E4             6270             CLR     A
196E D2E3           6271             SETB    TODO_StartScope
1970 D2E0           6272             SETB    TODO_CloseShutter
1972 F558           6273             MOV     TRIGGER_TODO,A
                    6274     
                    6275             ; Default COINC flags:
1974 E4             6276             CLR     A
                    6277     ;       SETB    COINC_TestLevel         ; This level of P3.0 (RxD) means coincidence (data 
                             have to be transmitted), oposite level means noncoincidence (data are scratched)
1975 D2E2           6278             SETB    COINC_Notify            ; The notification on P3.1 (TxD) should be generate
                             d
1977 D2E3           6279             SETB    COINC_NotifyInitLevel   ; This is default level of P3.1 (TxD)
1979 D2E4           6280             SETB    COINC_NotifyValidCoinc  ; If TRUE just coincidence will be notified, if FAL
                             SE each trigger generates notification
197B D2E5           6281             SETB    COINC_NotifyByPulse     ; If TRUE then two transitions (forming pulse) are 
                             generated on P3.1. If FALSE then just one
197D F559           6282             MOV     TRIGGER_COINC,A
197F 755A00         6283             MOV     TRIGGER_COINCDELAY,#0   ; Default is Maximum delay time
                    6284     
                    6285             ; Default pin configuration for coincidence mode:
1982 30E00A         6286             JNB     COINC_Test,ReturnTriggerDefault         ; If not coincidence mode then leav
                             e pins as they are now
1985 D2B0           6287             SETB    TriggerIn                               ; TriggerIn is configured as input
1987 30E205         6288             JNB     COINC_Notify,ReturnTriggerDefault       ; If no notification is desired the
                             n leave TriggerOut without any change
198A A2E3           6289             MOV     C,COINC_NotifyInitLevel                 ; Initial TriggerOut state is in Ca
                             rry flag
198C 92B1           6290             MOV     TriggerOut,C                            ; Carry flag is copied to TriggerOu
                             t
198E C3             6291             CLR     C                                       ; Reset carry flag to avoid transmi
                             ssion of error message
                    6292     
198F                6293       ReturnTriggerDefault:
198F 22             6294             RET
                    6295     
                    6296     
1990                6297     TriggerClear:           ; Clears all registers used by Trigger
                    6298     
1990 C000           6299             PUSH    00
1992 C0F0           6300             PUSH    B
1994 C0E0           6301             PUSH    ACC
                    6302     
                    6303             TriggerStop
1998 C218           6305             CLR     IgnoreNextTrg
199A 7854           6306             MOV     R0,#TRIGGER_COUNT
199C 75F009         6307             MOV     B,#9
199F E4             6308             CLR     A
19A0                6309         ClearTrigger_:
19A0 F6             6310             MOV     @R0,A
19A1 08             6311             INC     R0
19A2 D5F0FB         6312             DJNZ    B,ClearTrigger_
                    6313     
19A5 D0E0           6314             POP     ACC
19A7 D0F0           6315             POP     B
19A9 D000           6316             POP     00
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    67

19AB 22             6317             RET
                    6318     
19AC                6319     ComServ_TriggerStart:   ; Just Alias for TriggerRestart
                    6320     
19AC                6321     TriggerRestart:         ; Restarts Trigger
                    6322                             ; Clears trigger counter and enables interrupt
                    6323     
19AC E4             6324             CLR     A
19AD F554           6325             MOV     TRIGGER_COUNT+0,A
19AF F555           6326             MOV     TRIGGER_COUNT+1,A
19B1 F556           6327             MOV     TRIGGER_COUNT+2,A
19B3 F557           6328             MOV     TRIGGER_COUNT+3,A
                    6329             TriggerStart
19BD 22             6335             RET
                    6336     ;_______________________________________________________________________________
                    6337     
19BE                6338     ComServ_TriggerSet:     ; Receives:
                    6339                             ; 1 bytes from USB with Trigger TODO mask
                    6340     
19BE B147           6341             CALL    FT_GetChar
19C0 F558           6342             MOV     TRIGGER_TODO,A
19C2 22             6343             RET
                    6344     
                    6345     ;_______________________________________________________________________________
                    6346     
19C3                6347     ComServ_TriggerCoincSet:; Receives:
                    6348                             ; 1 byte from USB with TRIGGER_COINC mask
                    6349                             ; 1 byte from USB with TRIGGER_COINCDELAY
                    6350     
19C3 B147           6351             CALL    FT_GetChar
19C5 F559           6352             MOV     TRIGGER_COINC,A
19C7 B147           6353             CALL    FT_GetChar
19C9 F55A           6354             MOV     TRIGGER_COINCDELAY,A
                    6355     
19CB E559           6356             MOV     A,TRIGGER_COINC
19CD 30E00A         6357             JNB     COINC_Test,ReturnTriggerCoincSet
19D0 D2B0           6358             SETB    TriggerIn
19D2 30E205         6359             JNB     COINC_Notify,ReturnTriggerCoincSet
19D5 A2E3           6360             MOV     C,COINC_NotifyInitLevel
19D7 92B1           6361             MOV     TriggerOut,C
19D9 C3             6362             CLR     C
                    6363     
19DA                6364       ReturnTriggerCoincSet:
19DA 22             6365             RET
                    6366     
                    6367     ;_______________________________________________________________________________
                    6368     
                    6369     
19DB                6370     ComServ_TriggerStop:
                    6371             TriggerStop
19DD 22             6373             RET
                    6374     ;_______________________________________________________________________________
                    6375     
19DE                6376     ComServ_TriggerState:   ; Sends current status of Trigger to FTDI
                    6377                             ;  1.    byte = run state: bit 0 = Is enabled (EX0)
                    6378                             ;  2.    byte = TODO mask
                    6379                             ;  3.    byte = Port state:
                    6380                             ;                    P3.7 = BIAS CS     -RD
                    6381                             ;                    P3.6 = SCL_I2C     -WR
                    6382                             ;                    P3.5 = COUNTER     T1(CONVST)
                    6383                             ;                    P3.4 = SDA_I2C     T0/PWMC/PWM0/EXTCLK
                    6384                             ;                    P3.3 = DATA_OUT    INT1/MISO/PWM1
                    6385                             ;                    P3.2 = TRIGGER     INT0
                    6386                             ;                    P3.1 = TxD         TxD
                    6387                             ;                    P3.0 = RxD         RxD
                    6388                             ;  4.-7. byte = COUNT (LSB byte first)
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    68

                    6389     
19DE E4             6390             CLR     A
19DF A2A8           6391             MOV     C,EX0
19E1 92E0           6392             MOV     ACC.0,C
19E3 B13F           6393             CALL    FT_SendChar             ; Send flags (1. bit = Interrupt Enable)
19E5 C3             6394             CLR     C
                    6395     
19E6 E558           6396             MOV     A, TRIGGER_TODO
19E8 B13F           6397             CALL    FT_SendChar             ; Send TRIGGER_TODO mask
                    6398     
19EA E5B0           6399             MOV     A,P3
19EC B13F           6400             CALL    FT_SendChar             ; Send P3 state
                    6401     
19EE E554           6402             MOV     A,TRIGGER_COUNT
19F0 F4             6403             CPL     A
19F1 B13F           6404             CALL    FT_SendChar
19F3 E555           6405             MOV     A,TRIGGER_COUNT+1
19F5 F4             6406             CPL     A
19F6 B13F           6407             CALL    FT_SendChar
19F8 E556           6408             MOV     A,TRIGGER_COUNT+2
19FA F4             6409             CPL     A
19FB B13F           6410             CALL    FT_SendChar
19FD E557           6411             MOV     A,TRIGGER_COUNT+3
19FF F4             6412             CPL     A
1A00 B13F           6413             CALL    FT_SendChar
1A02 22             6414             RET
                    6415     
                    6416     ;===============================================================================
                    6417     ; Frame counter
                    6418     ;===============================================================================
                    6419     
1A03                6420     FrameCounterDefault:            ; Sets default number of frames (100) to be taken
                    6421     
1A03 755E9B         6422             MOV     FRAME_COUNT+0,#09bh
1A06 755FFF         6423             MOV     FRAME_COUNT+1,#0ffh
1A09 7560FF         6424             MOV     FRAME_COUNT+2,#0ffh
1A0C 7561FF         6425             MOV     FRAME_COUNT+3,#0ffh
1A0F 756600         6426             MOV     FRAME_TODO,#0
1A12 5145           6427             CALL    FrameCounterRestart
1A14 22             6428             RET
                    6429     
1A15                6430     FrameCounterClear:              ; Clears all registers used by Trigger
                    6431     
1A15 C000           6432             PUSH    00
1A17 C0F0           6433             PUSH    B
1A19 C0E0           6434             PUSH    ACC
                    6435     
1A1B 785E           6436             MOV     R0,#FRAME_COUNT
1A1D 75F009         6437             MOV     B,#9
1A20 E4             6438             CLR     A
1A21                6439         ClearFrameCounter_:
1A21 F6             6440             MOV     @R0,A
1A22 08             6441             INC     R0
1A23 D5F0FB         6442             DJNZ    B,ClearFrameCounter_
                    6443     
1A26 D0E0           6444             POP     ACC
1A28 D0F0           6445             POP     B
1A2A D000           6446             POP     00
1A2C 22             6447             RET
                    6448     
                    6449     ;_______________________________________________________________________________
                    6450     
1A2D                6451     ComServ_FrameCounterSet:
                    6452                             ; Receives from USB
                    6453                             ; 4 bytes with Frame count (LSB first)
                    6454                             ; 1 bytes with Frame TODO mask
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    69

                    6455     
1A2D B147           6456             CALL    FT_GetChar
1A2F F4             6457             CPL     A
1A30 F55E           6458             MOV     FRAME_COUNT+0,A
                    6459     
1A32 B147           6460             CALL    FT_GetChar
1A34 F4             6461             CPL     A
1A35 F55F           6462             MOV     FRAME_COUNT+1,A
                    6463     
1A37 B147           6464             CALL    FT_GetChar
1A39 F4             6465             CPL     A
1A3A F560           6466             MOV     FRAME_COUNT+2,A
                    6467     
1A3C B147           6468             CALL    FT_GetChar
1A3E F4             6469             CPL     A
1A3F F561           6470             MOV     FRAME_COUNT+3,A
                    6471     
1A41 B147           6472             CALL    FT_GetChar
1A43 F566           6473             MOV     FRAME_TODO,A
                    6474     ;_______________________________________________________________________________
                    6475     
1A45                6476     ComServ_FrameCounterStart:
                    6477                             ; Just Alias for FrameCounterRestart
                    6478     
1A45                6479     FrameCounterRestart:    ; Restarts Frame counter
                    6480                             ; Reloads FRAME_CURR with FRAME_COUNT
                    6481     
1A45 C2AF           6482             CLR     EA
1A47 855E62         6483             MOV     FRAME_CURR+0,FRAME_COUNT+0
1A4A 855F63         6484             MOV     FRAME_CURR+1,FRAME_COUNT+1
1A4D 856064         6485             MOV     FRAME_CURR+2,FRAME_COUNT+2
1A50 856165         6486             MOV     FRAME_CURR+3,FRAME_COUNT+3
1A53 D2AF           6487             SETB    EA
1A55 22             6488             RET
                    6489     ;_______________________________________________________________________________
                    6490     
1A56                6491     ComServ_FrameCounterState:
                    6492                             ; Sends current status of Frame counter to FTDI
                    6493                             ;  1.    byte = TODO mask
                    6494                             ;  2.-5. byte = COUNT (LSB byte first)
                    6495                             ;  6.-9. byte = CURR (LSB byte first)
                    6496     
1A56 E566           6497             MOV     A, FRAME_TODO
1A58 B13F           6498             CALL    FT_SendChar             ; Send FRAME_TODO mask
                    6499     
1A5A E55E           6500             MOV     A,FRAME_COUNT
1A5C F4             6501             CPL     A
1A5D B13F           6502             CALL    FT_SendChar
                    6503     
1A5F E55F           6504             MOV     A,FRAME_COUNT+1
1A61 F4             6505             CPL     A
1A62 B13F           6506             CALL    FT_SendChar
                    6507     
1A64 E560           6508             MOV     A,FRAME_COUNT+2
1A66 F4             6509             CPL     A
1A67 B13F           6510             CALL    FT_SendChar
                    6511     
1A69 E561           6512             MOV     A,FRAME_COUNT+3
1A6B F4             6513             CPL     A
1A6C B13F           6514             CALL    FT_SendChar
                    6515     
1A6E E562           6516             MOV     A,FRAME_CURR
1A70 F4             6517             CPL     A
1A71 B13F           6518             CALL    FT_SendChar
                    6519     
1A73 E563           6520             MOV     A,FRAME_CURR+1
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    70

1A75 F4             6521             CPL     A
1A76 B13F           6522             CALL    FT_SendChar
                    6523     
1A78 E564           6524             MOV     A,FRAME_CURR+2
1A7A F4             6525             CPL     A
1A7B B13F           6526             CALL    FT_SendChar
                    6527     
1A7D E565           6528             MOV     A,FRAME_CURR+3
1A7F F4             6529             CPL     A
1A80 B13F           6530             CALL    FT_SendChar
                    6531     
1A82 22             6532             RET
                    6533     
                    6534     ;===============================================================================
                    6535     ; DELAY
                    6536     ;===============================================================================
                    6537     
                    6538     ; Sets default values of delay => no delay
1A83                6539     DelayDefault:
1A83 E4             6540             CLR     A
1A84 F55B           6541             MOV     DELAY_TODOWHEN,A
1A86 F55C           6542             MOV     DELAY_HOWMUCH,A
1A88 F55D           6543             MOV     DELAY_HOWMUCH+1,A
1A8A 22             6544             RET
                    6545     
                    6546     ; Receives configuration of delay from FTDI
1A8B                6547     ComServ_SetDelay:
                    6548                             ; 2 bytes with count (LSB first)
                    6549                             ; 1 bytes with TODO mask
1A8B B147           6550             CALL    FT_GetChar
1A8D F4             6551             CPL     A
1A8E F55C           6552             MOV     DELAY_HOWMUCH+0,A
                    6553     
1A90 B147           6554             CALL    FT_GetChar
1A92 F4             6555             CPL     A
1A93 F55D           6556             MOV     DELAY_HOWMUCH+1,A
                    6557     
1A95 B147           6558             CALL    FT_GetChar
1A97 F55B           6559             MOV     DELAY_TODOWHEN,A
1A99 22             6560             RET
                    6561     
                    6562     ; Calibrated delay loop
                    6563     ; Protects all registers
1A9A                6564     MakeDelay:
1A9A C0E0           6565             PUSH    ACC
1A9C C084           6566             PUSH    DPP
1A9E C083           6567             PUSH    DPH
1AA0 C082           6568             PUSH    DPL
                    6569     
1AA2 855C82         6570             MOV     DPL,DELAY_HOWMUCH
1AA5 855D83         6571             MOV     DPH,DELAY_HOWMUCH+1
1AA8 758400         6572             MOV     DPP,#0
                    6573     
1AAB                6574       InnerDelayLoop:
1AAB A3             6575             INC     DPTR            ;3
1AAC E582           6576             MOV     A,DPL           ;1
1AAE 4583           6577             ORL     A,DPH           ;1
1AB0 70F9           6578             JNZ     InnerDelayLoop  ;3      => 8 cycles at 20MHz = 8 x 50 ns = 400 ns period
                    6579     
1AB2 D082           6580             POP     DPL
1AB4 D083           6581             POP     DPH
1AB6 D084           6582             POP     DPP
1AB8 D0E0           6583             POP     ACC
1ABA 22             6584             RET
                    6585     
                    6586     ; Calibrated delay loop
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    71

                    6587     ; Protects all registers except of ACC
1ABB                6588     MakeDelayNotPushA:
1ABB C084           6589             PUSH    DPP
1ABD C083           6590             PUSH    DPH
1ABF C082           6591             PUSH    DPL
                    6592     
1AC1 855C82         6593             MOV     DPL,DELAY_HOWMUCH
1AC4 855D83         6594             MOV     DPH,DELAY_HOWMUCH+1
1AC7 758400         6595             MOV     DPP,#0
                    6596     
1ACA                6597       InnerDelayLoop1:
1ACA A3             6598             INC     DPTR            ;3
1ACB E582           6599             MOV     A,DPL           ;1
1ACD 4583           6600             ORL     A,DPH           ;1
1ACF 70F9           6601             JNZ     InnerDelayLoop1 ;3      => 8 cycles at 20MHz = 8 x 50 ns = 400 ns period
                    6602     
1AD1 D082           6603             POP     DPL
1AD3 D083           6604             POP     DPH
1AD5 D084           6605             POP     DPP
1AD7 22             6606             RET
                    6607     ;===============================================================================
                    6608     ; TODO
                    6609     ;===============================================================================
                    6610     
1AD8                6611     ComServ_SetTODO:        ; Receives two TODO commands
                    6612     
1AD8 B147           6613             CALL    FT_GetChar
1ADA F567           6614             MOV     TODO_Command1,A
1ADC B147           6615             CALL    FT_GetChar
1ADE F568           6616             MOV     TODO_Command2,A
1AE0 22             6617             RET
                    6618     
1AE1                6619     ComServ_GetTODO:        ; Transmits two TODO commands
                    6620     
1AE1 E567           6621             MOV     A,TODO_Command1
1AE3 B13F           6622             CALL    FT_SendChar
1AE5 E568           6623             MOV     A,TODO_Command2
1AE7 B13F           6624             CALL    FT_SendChar
1AE9 22             6625             RET
                    6626     
1AEA                6627     ComServ_MakeTODO:       ; Performs ToDO actions given by mask received from USB
                    6628     
1AEA B147           6629             CALL    FT_GetChar
1AEC 02039D         6630             JMP     ProcessTODO
                    6631     
                    6632     ;===============================================================================
                    6633     ; Scope
                    6634     ;===============================================================================
                    6635     
1AEF                6636     ComServ_TriggerOutHigh:
1AEF D2B1           6637             SETB    TriggerOut
1AF1 22             6638             RET
                    6639     
1AF2                6640     ComServ_TriggerOutLow:
1AF2 C2B1           6641             CLR     TriggerOut
1AF4 22             6642             RET
                    6643     
1AF5                6644     ComServ_TriggerOutCpl:
1AF5 B2B1           6645             CPL     TriggerOut
1AF7 22             6646             RET
                    6647     
                    6648     ;===============================================================================
                    6649     ; Scope
                    6650     ;===============================================================================
                    6651     
1AF8                6652     ScopeSetDefaults:               ; Set default values of all registers
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    72

                    6653                                     ; initializes XRAM buffer
                    6654                                     ; initializes ADC
                    6655     
1AF8 7569C1         6656             MOV     SCOPE_SAMPLES,#Low(SCOPE_MAXCOUNT-1)
1AFB 756A01         6657             MOV     SCOPE_SAMPLES+1,#High(SCOPE_MAXCOUNT-1)
1AFE 756BBC         6658             MOV     SCOPE_TIMING, #0BCh
1B01 756C02         6659             MOV     SCOPE_CHANNELS, #SCOPE_DEFCHANMSK
                    6660     
1B04 8000           6661             JMP     ScopeSetup
                    6662     
                    6663     ;-------------------------------------------------------------------------------
                    6664     
1B06                6665     ScopeSetup:                     ; Configures XRAM memory buffer for DMA ADC measurement
                    6666                                     ; Configures ADC to perform DMA measurement
                    6667     
1B06 C000           6668             PUSH    00
1B08 C001           6669             PUSH    01
1B0A C002           6670             PUSH    02
1B0C C0F0           6671             PUSH    B
1B0E C082           6672             PUSH    DPL
1B10 C083           6673             PUSH    DPH
1B12 C0E0           6674             PUSH    ACC
1B14 C0D0           6675             PUSH    PSW
                    6676     
1B16 C2AF           6677             CLR     EA              ; disable interrupts
                    6678     
1B18 C3             6679             CLR     C
1B19 74C1           6680             MOV     A,#Low(SCOPE_MAXCOUNT-1)
1B1B 9569           6681             SUBB    A,SCOPE_SAMPLES
1B1D 7401           6682             MOV     A,#High(SCOPE_MAXCOUNT-1)
1B1F 956A           6683             SUBB    A,SCOPE_SAMPLES+1
1B21 5007           6684             JNC     CheckScopeChannels
1B23 7569C1         6685             MOV     SCOPE_SAMPLES,#Low(SCOPE_MAXCOUNT-1)
1B26 756A01         6686             MOV     SCOPE_SAMPLES+1,#High(SCOPE_MAXCOUNT-1)
1B29 C3             6687             CLR     C
                    6688     
1B2A                6689       CheckScopeChannels:
1B2A E56C           6690             MOV     A,SCOPE_CHANNELS
1B2C 7004           6691             JNZ     SetupScopeScanBits      ; No channel is selected => select default (channel
                              1)
1B2E E502           6692             MOV     A,SCOPE_DEFCHANMSK      ; Set default channel
1B30 F56C           6693             MOV     SCOPE_CHANNELS,A        ; Put it to register
                    6694     
                    6695       ; Scan bits in SCOPE_CHANNELS and fill SCOPE_CHANBUFF by indexes of selected bits, also S
                             COPE_CHANCNT will be determined
1B32                6696       SetupScopeScanBits:
1B32 757500         6697             MOV     SCOPE_CHANCNT,#0        ; Initialize SCOPE_CHANCNT with zero
1B35 786D           6698             MOV     R0,#SCOPE_CHANBUFF      ; Address of channel buffer is in R0
1B37 75F000         6699             MOV     B,#0                    ; BIt counter
1B3A                6700       SetupScopeCheckChan:
1B3A 13             6701             RRC     A                       ; Last bit is in CY
1B3B 5006           6702             JNC     SetupScopeNext          ; This channel shuld not be measured
1B3D A6F0           6703             MOV     @R0,B                   ; In B is order of the channel => set it to current
                              buffer position
1B3F 0575           6704             INC     SCOPE_CHANCNT           ; Number of channels incremented
1B41 08             6705             INC     R0                      ; Go to next buffer position
1B42 C3             6706             CLR     C                       ; Clear CY to don't overflow back to A
1B43                6707       SetupScopeNext:
1B43 05F0           6708             INC     B                       ; Increment bit counter
1B45 70F3           6709             JNZ     SetupScopeCheckChan
                    6710     
                    6711       ; Channel numbers have to be in upper nibble => have to swap bytes in SCOPE_CHANBUFF
1B47                6712       SetupScopeSwap:
1B47 8575F0         6713             MOV     B,SCOPE_CHANCNT
1B4A 786D           6714             MOV     R0,#SCOPE_CHANBUFF
1B4C                6715       SetupScopeChanSwap:
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    73

1B4C E6             6716             MOV     A,@R0
1B4D C4             6717             SWAP    A
1B4E F6             6718             MOV     @R0,A
1B4F 08             6719             INC     R0
1B50 D5F0F9         6720             DJNZ    B,SetupScopeChanSwap
                    6721     
                    6722       ; Prepare XRAM memory buffer for DMA conversion:
1B53                6723       SetupScopeXRAM:
1B53 A969           6724             MOV     R1,SCOPE_SAMPLES
1B55 AA6A           6725             MOV     R2,SCOPE_SAMPLES+1
                    6726     
1B57 900020         6727             MOV     DPTR,#SCOPE_BUFF
1B5A 758400         6728             MOV     DPP,#0
                    6729     
1B5D                6730         SSCopySerie:
1B5D 8575F0         6731             MOV     B,SCOPE_CHANCNT
1B60 786D           6732             MOV     R0,#SCOPE_CHANBUFF
                    6733     
1B62                6734         SSCopyByte:
1B62 E6             6735             MOV     A,@R0
1B63 F0             6736             MOVX    @dptr,A         ; Configure channel
1B64 A3             6737             INC     dptr
1B65 E4             6738             CLR     A
1B66 F0             6739             MOVX    @dptr,A         ; Space for data
1B67 A3             6740             INC     dptr
                    6741     
1B68 C3             6742             CLR     C
1B69 E9             6743             MOV     A,R1
1B6A 9401           6744             SUBB    A,#1
1B6C F9             6745             MOV     R1,A
1B6D EA             6746             MOV     A,R2
1B6E 9400           6747             SUBB    A,#0
1B70 FA             6748             MOV     R2,A
1B71 4006           6749             JC      SSFinished      ; Check if it is right number of samples
                    6750     
1B73                6751         SSGoToNext:
1B73 08             6752             INC     R0              ; Next channel
1B74 D5F0EB         6753             DJNZ    B,SSCopyByte    ; Continue if it is not last channel
1B77 80E4           6754             JMP     SSCopySerie     ; For the last channel rotate back to the first one
                    6755     
1B79                6756         SSFinished:
1B79 E6             6757             MOV     A,@R0
1B7A F0             6758             MOVX    @dptr,A
1B7B A3             6759             INC     dptr            ; Repeat last channel
1B7C E4             6760             CLR     A
1B7D F0             6761             MOVX    @dptr,A         ; Space
1B7E A3             6762             INC     dptr
1B7F 74F0           6763             MOV     A,#0F0h
1B81 F0             6764             MOVX    @dptr,A         ; Stop condition
1B82 A3             6765             INC     dptr
                    6766     
1B83 D0D0           6767             POP     PSW
1B85 D0E0           6768             POP     ACC
1B87 D083           6769             POP     DPH
1B89 D082           6770             POP     DPL
1B8B D0F0           6771             POP     B
1B8D D002           6772             POP     02
1B8F D001           6773             POP     01
1B91 D000           6774             POP     00
                    6775     
1B93 8000           6776             JMP     ScopeSetupADC   ; Memory is prepared => can setup the ADC:
                    6777     
                    6778     ;-------------------------------------------------------------------------------
                    6779     
1B95                6780     ScopeSetupADC:                  ; Setup ADC for DMA continuous conversion to
                    6781                                     ; scope external memory buffer
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    74

                    6782                                     ; Timing is defined by SCOPE_TIMING register
                    6783     
1B95 C2AF           6784             CLR     EA                      ; disable interrupts
1B97 75EF00         6785             MOV     ADCCON1,#00h            ; ADC must be powered down during DMA configuring
1B9A 75D220         6786             MOV     DMAL,#LOW(SCOPE_BUFF)   ; start address for DMA operation
1B9D 75D300         6787             MOV     DMAH,#HIGH(SCOPE_BUFF)  ; (must write DMA registers in this
1BA0 75D400         6788             MOV     DMAP,#0                 ;  order:  DMAL, DMAH, DMAP)
1BA3 856BEF         6789             MOV     ADCCON1,SCOPE_TIMING    ; speed is given by /2 4 acq clocks => (16+4)*2=40 
                             cycles => at 20MHz 2 us / conversion
1BA6 D2AF           6790             SETB    EA                      ; reenable all interrupts
1BA8 22             6791             RET
                    6792     
                    6793     ;-------------------------------------------------------------------------------
                    6794     
1BA9                6795     ScopeSingleShotMeasurement:     ; Starts DMA ADC measurement
                    6796                                     ; Assumes the Scope memory buffer and ADC properly configur
                             ed
                    6797                                     ; When measurement finishes interrupt procedure will be cal
                             led
                    6798     
1BA9 E522           6799             MOV     A,ADCused               ; Have to wait for ADC
1BAB 70FC           6800             JNZ     ScopeSingleShotMeasurement
                    6801     
                    6802             ScopeStart
1BB8 22             6808             RET
                    6809     
                    6810     ;-------------------------------------------------------------------------------
                    6811     
1BB9                6812     ComServ_ScopeSendData:
1BB9                6813     ScopeSendData:                  ; Sends ADC data from Scope external memory buffer to FTDI
                    6814                                     ; Doesn't make any measurement!
                    6815                                     ; This procedure is called from background service BackServ
                             _Scope
                    6816     
1BB9 E569           6817             MOV     A,SCOPE_SAMPLES         ; Sends the number of counts (lower byte)
1BBB B13F           6818             CALL    FT_SendChar
1BBD E56A           6819             MOV     A,SCOPE_SAMPLES+1       ; Sends the number of counts (upper byte)
1BBF B13F           6820             CALL    FT_SendChar
                    6821     
1BC1 A969           6822             MOV     R1,SCOPE_SAMPLES
1BC3 AA6A           6823             MOV     R2,SCOPE_SAMPLES+1
                    6824     
1BC5 900020         6825             MOV     DPTR,#SCOPE_BUFF
1BC8 758400         6826             MOV     DPP,#0
                    6827     
1BCB                6828         SSdCopyByte:
1BCB E0             6829             MOVX    A,@dptr
1BCC B13F           6830             CALL    FT_SendChar
1BCE A3             6831             INC     dptr
1BCF E0             6832             MOVX    A,@dptr
1BD0 B13F           6833             CALL    FT_SendChar
1BD2 A3             6834             INC     dptr
                    6835     
1BD3 C3             6836             CLR     C
1BD4 E9             6837             MOV     A,R1
1BD5 9401           6838             SUBB    A,#1
1BD7 F9             6839             MOV     R1,A
1BD8 EA             6840             MOV     A,R2
1BD9 9400           6841             SUBB    A,#0
1BDB FA             6842             MOV     R2,A
1BDC 50ED           6843             JNC     SSdCopyByte     ; Check if it is right number of samples
                    6844     
1BDE C3             6845             CLR     C               ; Cy=0 indicates no Error
1BDF 22             6846             RET
                    6847     
                    6848     ;_______________________________________________________________________________
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    75

                    6849     
1BE0                6850     ComServ_ScopeConfigure:         ; Configures:
                    6851                                     ;  - channels to measure (1 byte mask)
                    6852                                     ;  - number of samples  (2 bytes, lower first)
                    6853                                     ;  - timing (1 byte)
1BE0 B147           6854             CALL    FT_GetChar
1BE2 F8             6855             MOV     R0,A
1BE3 B147           6856             CALL    FT_GetChar
1BE5 F9             6857             MOV     R1,A
1BE6 B147           6858             CALL    FT_GetChar
1BE8 FA             6859             MOV     R2,A
1BE9 B147           6860             CALL    FT_GetChar
                    6861     
1BEB 540F           6862             ANL     A,#00Fh
1BED 23             6863             RL      A
1BEE 23             6864             RL      A
1BEF 4480           6865             ORL     A,#080h                 ; Power up the ADC
                    6866     
1BF1 C2AF           6867             CLR     EA
1BF3 F56B           6868             MOV     SCOPE_TIMING,A
1BF5 886C           6869             MOV     SCOPE_CHANNELS,R0
1BF7 8969           6870             MOV     SCOPE_SAMPLES,R1
1BF9 8A6A           6871             MOV     SCOPE_SAMPLES+1,R2
                    6872     
1BFB 7106           6873             CALL    ScopeSetup
1BFD D2AF           6874             SETB    EA
1BFF 22             6875             RET
                    6876     
                    6877     ;===============================================================================
                    6878     ; Voltage Monitor
                    6879     ;===============================================================================
                    6880     
1C00                6881     MonitorSetup:                   ; Setups XRAM memory buffer for Monitor DMA ADC measurement
                    6882                                     ; Does not change ADC configuration
1C00 7800           6883             MOV     R0,#00h
1C02 9003A8         6884             MOV     DPTR,#MONITOR_BUFF      ; set DPTR to DMASTART address
1C05 758400         6885             MOV     DPP,#0                  ; DPP can be nonzero then external XRAM would be ad
                             dressed
                    6886     
1C08                6887       SmXRAMChannel:
1C08 E8             6888             MOV     A,R0                    ; set up x-mem with init value
1C09 F0             6889             MOVX    @DPTR,A
1C0A A3             6890             INC     DPTR
1C0B 2410           6891             ADD     A,#10h
1C0D F8             6892             MOV     R0,A
                    6893     
1C0E E4             6894             CLR     A                       ; clear second byte
1C0F F0             6895             MOVX    @DPTR,A
1C10 A3             6896             INC     DPTR
1C11 B8D0F4         6897             CJNE    R0,#0D0h,SmXRAMChannel
                    6898     
1C14 74C0           6899             MOV     A,#0C0h                 ; repeat last channel for valid stop condition
1C16 F0             6900             MOVX    @DPTR,A
1C17 A3             6901             INC     DPTR
1C18 E4             6902             CLR     A                       ; clear second byte
1C19 F0             6903             MOVX    @DPTR,A
1C1A A3             6904             INC     DPTR
                    6905     
1C1B 74F0           6906             MOV     A,#0F0h                 ; DMA stop condition
1C1D F0             6907             MOVX    @DPTR,A
1C1E 22             6908             RET
                    6909     
                    6910     ;-------------------------------------------------------------------------------
                    6911     
1C1F                6912     MonitorSingleShotMeasurement:   ; ADC is assumed tobe configured for Scope:
                    6913                                     ;  - All Interrupts are disabled!
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    76

                    6914                                     ;  - ADC is configured to make DMA conversion to Monitor XR
                             AM
                    6915                                     ;  - DMA Conversion to Monitor XRAM is started
                    6916                                     ;  - Waits for end of conversion
                    6917                                     ;  - SetupScopeADC is called to retrieve original configura
                             tion
                    6918                                     ;  - ADC Interrupt is reenabled
                    6919     
1C1F E522           6920             MOV     A,ADCused               ; Have to wait for ADC
1C21 70FC           6921             JNZ     MonitorSingleShotMeasurement
1C23 D211           6922             SETB    ADCused_Monitor         ; Monitor uses ADC
1C25 D219           6923             SETB    ScopeTgrDisabled                ; Just to prevent trigger of the scope
                    6924     
1C27 C2AF           6925             CLR     EA                      ; disable interrupts
1C29 75EF00         6926             MOV     ADCCON1,#00h            ; ADC must be powered down during DMA configuring
1C2C 75D2A8         6927             MOV     DMAL,#LOW(MONITOR_BUFF) ; start address for DMA operation
1C2F 75D303         6928             MOV     DMAH,#HIGH(MONITOR_BUFF); (must write DMA registers in this
1C32 75D400         6929             MOV     DMAP,#0                 ;  order:  DMAL, DMAH, DMAP)
1C35 75D840         6930             MOV     ADCCON2,#040h           ; enable DMA mode
1C38 75EF9C         6931             MOV     ADCCON1,#09Ch           ; speed CoreClock/4, 4 acq clocks => (16+4)*4=80 cy
                             cles => at 20MHz 4us/conversion => 4*13 = 52us all
1C3B D2AE           6932             SETB    EADC                    ; Enable ADC interrupt
1C3D D2AF           6933             SETB    EA                      ; reenable interrupts
                    6934     
1C3F D2DD           6935             SETB    CCONV                   ; start continuous ADC conversions using DMA
1C41 2011FD         6936             JB      ADCused_Monitor,$       ; wait for end of conversion
1C44 C219           6937             CLR     ScopeTgrDisabled                ; Trigger can start the scope now
                    6938     
1C46 75F00D         6939             MOV     B,#13                   ; Send 13 measured channels of MONITR_BUFF in XRAM
1C49 9003A8         6940             MOV     DPTR,#MONITOR_BUFF
1C4C                6941       MSsMSendChannel:
1C4C E0             6942             MOVX    A,@DPTR
1C4D B13F           6943             CALL    FT_SendChar
1C4F A3             6944             INC     DPTR
1C50 E0             6945             MOVX    A,@DPTR
1C51 B13F           6946             CALL    FT_SendChar
1C53 A3             6947             INC     DPTR
1C54 D5F0F5         6948             DJNZ    B,MSsMSendChannel
                    6949     
1C57 7195           6950             CALL    ScopeSetupADC           ; Retrieve ADC configuration for scope
1C59 D2AE           6951             SETB    EADC                    ; Enable ADC interrupt
1C5B D2AF           6952             SETB    EA                      ; Enable all interrupts
1C5D 22             6953             RET
                    6954     
                    6955     ;===============================================================================
                    6956     ; For debugging:
                    6957     ;===============================================================================
                    6958     
1C5E                6959     SendTODOdescription:    ; Will send ASCII description od TODO mask in ACC in format of back
                             ground string
                    6960     
1C5E C0F0           6961             PUSH    B
1C60 C083           6962             PUSH    DPH
1C62 C082           6963             PUSH    DPL
                    6964     
1C64 F5F0           6965             MOV     B,A
1C66 7422           6966             MOV     A,#'"'
1C68 B13F           6967             CALL    FT_SendChar
                    6968     
1C6A 900813         6969             MOV     DPTR,#Str_TODO
1C6D B170           6970             CALL    FT_SendString
                    6971     
1C6F E5F0           6972             MOV     A,B
                    6973     
1C71 30E005         6974             JNB     TODO_CloseShutter, No_TODO_CloseShutter
1C74 900822         6975             MOV     dptr,#Str_TODO_CloseShutter
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    77

1C77 B170           6976             CALL    FT_SendString
                    6977     
1C79                6978       No_TODO_CloseShutter:
1C79 30E105         6979             JNB     TODO_OpenShutter, No_TODO_OpenShutter
1C7C 900831         6980             MOV     dptr,#Str_TODO_OpenShutter
1C7F B170           6981             CALL    FT_SendString
                    6982     
1C81                6983       No_TODO_OpenShutter:
1C81 30E205         6984             JNB     TODO_StartInterval, No_TODO_StartInterval
1C84 90083F         6985             MOV     dptr,#Str_TODO_StartInterval
1C87 B170           6986             CALL    FT_SendString
                    6987     
1C89                6988       No_TODO_StartInterval:
1C89 30E305         6989             JNB     TODO_StartScope, No_TODO_StartScope
1C8C 90084F         6990             MOV     dptr,#Str_TODO_StartScope
1C8F B170           6991             CALL    FT_SendString
                    6992     
1C91                6993       No_TODO_StartScope:
1C91 30E405         6994             JNB     TODO_StartTrigger, No_TODO_StartTrigger
1C94 90085C         6995             MOV     dptr,#Str_TODO_StartTrigger
1C97 B170           6996             CALL    FT_SendString
                    6997     
1C99                6998       No_TODO_StartTrigger:
1C99 30E505         6999             JNB     TODO_StartCounter, No_TODO_StartCounter
1C9C 90086B         7000             MOV     dptr,#Str_TODO_StartCounter
1C9F B170           7001             CALL    FT_SendString
                    7002     
1CA1                7003       No_TODO_StartCounter:
1CA1 30E605         7004             JNB     TODO_MakeCommand1, No_TODO_MakeCommand1
1CA4 90087A         7005             MOV     dptr,#Str_TODO_Command1
1CA7 B170           7006             CALL    FT_SendString
                    7007     
1CA9                7008       No_TODO_MakeCommand1:
1CA9 30E705         7009             JNB     TODO_MakeCommand2, No_TODO_MakeCommand2
1CAC 900884         7010             MOV     dptr,#Str_TODO_Command2
1CAF B170           7011             CALL    FT_SendString
                    7012     
1CB1                7013       No_TODO_MakeCommand2:
1CB1 7422           7014             MOV     A,#'"'
1CB3 B13F           7015             CALL    FT_SendChar
1CB5 740D           7016             MOV     A,#0dh
1CB7 B13F           7017             CALL    FT_SendChar
                    7018     
1CB9 E5F0           7019             MOV     A,B
1CBB D082           7020             POP     DPL
1CBD D083           7021             POP     DPH
1CBF D0F0           7022             POP     B
1CC1 22             7023             RET
                    7024     
                    7025     ;===============================================================================
                    7026     ; Subroutines, Utilities
                    7027     ;===============================================================================
                    7028     
1CC2                7029     WaitMicrosecond:
                    7030                     ; Waits 1 microsecond by NOP
                    7031                     ; Expets call by LCALL
                    7032     
                    7033             ; CALL                          ; 4/3 cycles (Use LCALL to be precise)
1CC2 00             7034             NOP                             ; 1
                    7035     
1CC3 00             7036             NOP
1CC4 00             7037             NOP
1CC5 00             7038             NOP
1CC6 00             7039             NOP
1CC7 00             7040             NOP
                    7041     
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    78

1CC8 00             7042             NOP
1CC9 00             7043             NOP
1CCA 00             7044             NOP
1CCB 00             7045             NOP
1CCC 00             7046             NOP
                    7047     
1CCD 00             7048             NOP
1CCE 22             7049             RET                             ; 4 cycles
                    7050     
                    7051     
1CCF                7052     WaitMicroseconds:
                    7053                     ; Waits roughly A microseconds (use LCALL to be precise)
                    7054                     ; Expects: 20MHz clock => 50 ns/cycle
                    7055                     ; 1 us = 20 cycles;
                    7056                                             ; cycles:
                    7057             ;CALL command of caller         ; 4/3 (LCALL, ACALL)    4
1CCF C0F0           7058             push    b                       ; 2                     6
1CD1 C0E0           7059             push    acc                     ; 2                     8
1CD3 F5F0           7060             MOV     B,A                     ; 1                     9
1CD5 8010           7061             SJMP    OneMicLoopEntry         ; 3                     12
                    7062     
1CD7                7063       OneMicrosecnd:
1CD7 00             7064             NOP                             ; 1
1CD8 00             7065             NOP                             ; 2
1CD9 00             7066             NOP                             ; 3
1CDA 00             7067             NOP                             ; 4
1CDB 00             7068             NOP                             ; 5
                    7069     
1CDC 00             7070             NOP                             ; 6
1CDD 00             7071             NOP                             ; 7
1CDE 00             7072             NOP                             ; 8
1CDF 00             7073             NOP                             ; 9
1CE0 00             7074             NOP                             ; 10
                    7075     
1CE1 00             7076             NOP                             ; 11
1CE2 00             7077             NOP                             ; 12
1CE3 00             7078             NOP                             ; 13
1CE4 00             7079             NOP                             ; 14
1CE5 00             7080             NOP                             ; 15
                    7081     
1CE6 00             7082             NOP                             ; 16
1CE7                7083         OneMicLoopEntry:
1CE7 D5F0ED         7084             DJNZ    B,OneMicrosecnd         ; 20 cycles = 1 us
                    7085     
1CEA                7086        WaitMicrosEnd:
1CEA D0E0           7087             pop     acc                     ; 2                     14
1CEC D0F0           7088             pop     b                       ; 2                     16
1CEE 22             7089             ret                             ; 4                     20
                    7090     
                    7091     
1CEF                7092     Wait10MicroSeconds:
                    7093                     ; Waits roughly A tens of microseconds
1CEF C0F0           7094             push    b
1CF1 C0E0           7095             push    acc
1CF3 C082           7096             push    dpl
1CF5 F582           7097             mov     dpl,a
1CF7                7098         TenMicroSeconds_:
1CF7 75F032         7099             mov b,#50
1CFA                7100           TenMicroInner_:
1CFA D5F0FD         7101             djnz b,TenMicroInner_           ; Waits 0.01 of milisecond
1CFD D582F7         7102             djnz dpl,TenMicroSeconds_
                    7103     
1D00 D082           7104             POP     DPL
1D02 D0E0           7105             POP     ACC
1D04 D0F0           7106             POP     B
1D06 22             7107             RET
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    79

                    7108     
1D07                7109     Wait:           ; Waits roughly A milliseconds
                    7110     
1D07 C0F0           7111             push b
1D09 C082           7112             push dpl
1D0B C083           7113             push dph
                    7114     
1D0D F583           7115             mov  dph,a
                    7116     
1D0F                7117       Milisecond:
1D0F 758264         7118             mov dpl,#100
                    7119     
1D12                7120         TenMicroSeconds:
1D12 75F032         7121             mov b,#50
1D15                7122           TenMicroInner:
1D15 D5F0FD         7123             djnz b,TenMicroInner            ; Waits 0.01 of milisecond
1D18 D582F7         7124             djnz dpl,TenMicroSeconds        ; Waits 1 milisecond
                    7125     
1D1B D583F1         7126             djnz dph,Milisecond
                    7127     
1D1E D083           7128             pop dph
1D20 D082           7129             pop dpl
1D22 D0F0           7130             pop b
1D24 22             7131             ret
                    7132     
                    7133     
1D25                7134     WaitTenth:      ; Waits tenth of second
1D25 C0E0           7135             push acc
1D27 7464           7136             mov a,#100
1D29 B107           7137             call Wait
1D2B D0E0           7138             pop acc
1D2D 22             7139             ret
                    7140     
1D2E                7141     WaitQuarter:    ; Waits quarter of second
1D2E C0E0           7142             push acc
1D30 74FA           7143             mov a,#250
1D32 B107           7144             call Wait
1D34 D0E0           7145             pop acc
1D36 22             7146             ret
                    7147     
1D37                7148     WaitHalf:       ; Waits half of second
1D37 B12E           7149             call WaitQuarter
1D39 80F3           7150             jmp  WaitQuarter
                    7151     
1D3B                7152     WaitSecond:     ; Waits one second
1D3B B137           7153             call WaitHalf
1D3D 80F8           7154             jmp  WaitHalf
                    7155     
                    7156     ;===============================================================================
                    7157     ; FTDI support:
                    7158     ;===============================================================================
                    7159     
                    7160     ; Symbols:
  0080              7161     FT_port   EQU   P0      ; Port P0 is set as I/O gate
  00A0              7162     FT_RD     EQU   P2.0    ; P3.7 drives reading from FTDI (active low)
  00A1              7163     FT_WR     EQU   P2.1    ; P3.6 drives writing to FTDI (active high)
  00A2              7164     FT_TxE    EQU   P2.2    ; P2.1 monitor the write buffer (low -> data can be writed)
  00A3              7165     FT_RxF    EQU   P2.3    ; P2.0 monitor the read buffer (low -> data can be readed)
                    7166     
                    7167     ;_______________________________________________________________________________
                    7168                                                                        ; FT_SendChar
                    7169     
1D3F                7170     FT_SendChar:    ; sends byte contained in A to FTDI
                    7171     
                    7172             ;MOV     FT_port,A       ; Send data from accumulator to FTDI port
                    7173             ;JB      FT_TxE,$        ; Wait util FTDI is ready to write     
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    80

                    7174             ;CLR     FT_WR           ; Make a write pulse
                    7175             ;SETB    FT_WR
                    7176                     
                    7177             ;;;; UART ;;;;
1D3F C299           7178             CLR     TI
1D41 F599           7179             MOV     SBUF,A
1D43 3099FD         7180             JNB     TI,$
1D46 22             7181             RET
                    7182     ;_______________________________________________________________________________
                    7183                                                                         ; FT_GetChar
                    7184     
1D47                7185     FT_GetChar:     ; waits for a byte to be received from FTDI
                    7186                     ; places this character into A.
                    7187     
                    7188             ;MOV     FT_port,#0FFh   ; Set FT_port as input
                    7189             ;JB      FT_RxF,$        ; Wait until FTDI is ready to read
                    7190             ;CLR     FT_RD
                    7191             ;MOV     A,FT_port       ; Get data from FTDI port to accumulator
                    7192             ;SETB    FT_RD           ; Make read data pulse 
                    7193             
                    7194             RefreshWatchdog
                    7196+1           RefreshWatchdogBase
                    7200     
                    7201             ;;;; UART ;;;;
1D4F 3098F5         7202             JNB     RI, FT_GetChar             ; test if it is a reception
1D52 C298           7203             CLR     RI                             ; clear reception flag for next reception
1D54 E599           7204             MOV     A,SBUF         
1D56 22             7205             RET
                    7206     ;_______________________________________________________________________________
                    7207                                                                         ; FT_GetChar
                    7208     
1D57                7209     FT_CheckChar:   ; gets a byte from FTDI places this character into A.
                    7210                     ; if FTDI is not ready returns CY=1
                    7211     
1D57 209802         7212             JB     RI,FT_TakeChar  ; Check if FTDI is ready to be read (if ready then jump)
1D5A D3             7213             SETB    C
1D5B 22             7214             RET
                    7215     
                    7216     
1D5C                7217       FT_TakeChar:
1D5C C298           7218             CLR RI                         ; clear reception flag for next reception
1D5E E599           7219             MOV A,SBUF  
1D60 C3             7220             CLR     C
1D61 22             7221             RET
                    7222     
                    7223     ;_______________________________________________________________________________
                    7224     
1D62                7225     FT_ClearFIFO:   ; gets all characters in FTDI FIFO
                    7226     
1D62 7580FF         7227             MOV     FT_port,#0FFh           ; Set FT_port as input
1D65 20A307         7228             JB      FT_RxF,ftClearEnd       ; Check if FTDI is ready to read
1D68                7229       ftClrNext:
1D68 C2A0           7230             CLR     FT_RD
1D6A D2A0           7231             SETB    FT_RD                   ; Make read data pulse
1D6C 30A3F9         7232             JNB     FT_RxF,ftClrNext        ; Check if FTDI is ready to read
                    7233     
1D6F                7234       ftClearEnd:
1D6F 22             7235             RET
                    7236     ;_______________________________________________________________________________
                    7237                                                                      ; FT_SendString
                    7238     
1D70                7239     FT_SendString:  ; sends zero terminated ASCII string stored in program memory to FTDI
                    7240                     ; starting at location DPTR
                    7241     
1D70 C0E0           7242             PUSH    ACC
                    7243     
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    81

1D72                7244       FT_010:
1D72 E4             7245             CLR     A
1D73 93             7246             MOVC    A,@A+DPTR
1D74 600A           7247             JZ      FT_020          ; test terminating zero
                    7248             ;MOV     FT_port,A       ; Send data from accumulator to FTDI port
                    7249     
                    7250             ;;;; UART ;;;;
                    7251             ;;;; Posln textovho infa ;;;;
1D76 C299           7252             CLR     TI              ; write uart
1D78 F599           7253             MOV     SBUF,A          
1D7A 3099FD         7254             JNB     TI,$            ; Wait until UART is written
                    7255     
1D7D A3             7256             INC     DPTR
                    7257             ;JB      FT_TxE,$        ; Wait util FTDI is ready to write
                    7258             ;CLR     FT_WR           ; Make a write pulse
                    7259             ;SETB    FT_WR
                    7260             
1D7E 80F2           7261             JMP     FT_010          ; Go to next character
                    7262     
1D80                7263       FT_020:
1D80 D0E0           7264             POP     ACC
1D82 22             7265             RET
                    7266     ;_______________________________________________________________________________
                    7267     
                    7268     END
                             
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    82

SYMBOL TABLE LISTING
------ ----- -------


N A M E                                    T Y P E  V A L U E   ATTRIBUTES

ACC . . . . . . . . . . . . . . . . . .    D ADDR   00E0H   A   
ADCCON1 . . . . . . . . . . . . . . . .    D ADDR   00EFH   A   
ADCCON2 . . . . . . . . . . . . . . . .    D ADDR   00D8H   A   
ADCCON3 . . . . . . . . . . . . . . . .    D ADDR   00F5H   A   
ADCDATAH. . . . . . . . . . . . . . . .    D ADDR   00DAH   A   
ADCDATAL. . . . . . . . . . . . . . . .    D ADDR   00D9H   A   
ADCGAINH. . . . . . . . . . . . . . . .    D ADDR   00F4H   A   
ADCGAINL. . . . . . . . . . . . . . . .    D ADDR   00F3H   A   
ADCI. . . . . . . . . . . . . . . . . .    B ADDR   00D8H.7 A   
ADCOFSH . . . . . . . . . . . . . . . .    D ADDR   00F2H   A   
ADCOFSL . . . . . . . . . . . . . . . .    D ADDR   00F1H   A   
ADCUSED . . . . . . . . . . . . . . . .    D ADDR   0022H   A   
ADCUSED_MONITOR . . . . . . . . . . . .    B ADDR   0022H.1 A   
ADCUSED_SCOPE . . . . . . . . . . . . .    B ADDR   0022H.0 A   
B . . . . . . . . . . . . . . . . . . .    D ADDR   00F0H   A   
BACKGROUND. . . . . . . . . . . . . . .    D ADDR   0020H   A   
BACKSERVTRIGGERCOINC. . . . . . . . . .    C ADDR   043FH   A   
BACKSERVTRIGGERINVCOINC . . . . . . . .    C ADDR   0449H   A   
BACKSERVTRIGGERVALCOINC . . . . . . . .    C ADDR   0442H   A   
BACKSERV_COUNTER. . . . . . . . . . . .    C ADDR   0450H   A   
BACKSERV_INTERVAL . . . . . . . . . . .    C ADDR   0425H   A   
BACKSERV_PERIOD . . . . . . . . . . . .    C ADDR   042CH   A   
BACKSERV_READMATRIX . . . . . . . . . .    C ADDR   0468H   A   
BACKSERV_SCOPE. . . . . . . . . . . . .    C ADDR   0457H   A   
BACKSERV_TRIGGER. . . . . . . . . . . .    C ADDR   0433H   A   
BACK_COUNTER. . . . . . . . . . . . . .    B ADDR   0020H.3 A   
BACK_INTERVAL . . . . . . . . . . . . .    B ADDR   0020H.0 A   
BACK_PERIOD . . . . . . . . . . . . . .    B ADDR   0020H.1 A   
BACK_READMATRIX . . . . . . . . . . . .    B ADDR   0020H.5 A   
BACK_SCOPE. . . . . . . . . . . . . . .    B ADDR   0020H.4 A   
BACK_TODOCOM1 . . . . . . . . . . . . .    B ADDR   0020H.6 A   
BACK_TODOCOM2 . . . . . . . . . . . . .    B ADDR   0020H.7 A   
BACK_TRIGGER. . . . . . . . . . . . . .    B ADDR   0020H.2 A   
CAP2. . . . . . . . . . . . . . . . . .    B ADDR   00C8H.0 A   
CCONV . . . . . . . . . . . . . . . . .    B ADDR   00D8H.5 A   
CERN_CABLE. . . . . . . . . . . . . . .    N NUMB   0000H   A   
CFG841. . . . . . . . . . . . . . . . .    D ADDR   00AFH   A   
CHECKBACKFINISHED . . . . . . . . . . .    C ADDR   038FH   A   
CHECKBACKGROUND . . . . . . . . . . . .    C ADDR   0331H   A   
CHECKBACKGROUNDBODY . . . . . . . . . .    C ADDR   033EH   A   
CHECKBACKGROUNDPROC . . . . . . . . . .    C ADDR   0291H   A   
CHECKBACK_COMMAND1. . . . . . . . . . .    C ADDR   036DH   A   
CHECKBACK_COMMAND2. . . . . . . . . . .    C ADDR   037EH   A   
CHECKBACK_COUNTER . . . . . . . . . . .    C ADDR   0358H   A   
CHECKBACK_INTERVAL. . . . . . . . . . .    C ADDR   0343H   A   
CHECKBACK_PERIOD. . . . . . . . . . . .    C ADDR   034AH   A   
CHECKBACK_READMATRIX. . . . . . . . . .    C ADDR   0366H   A   
CHECKBACK_SCOPE . . . . . . . . . . . .    C ADDR   035FH   A   
CHECKBACK_TRIGGER . . . . . . . . . . .    C ADDR   0351H   A   
CHECKFTDICOMMAND. . . . . . . . . . . .    C ADDR   029AH   A   
CHECKSCOPECHANNELS. . . . . . . . . . .    C ADDR   1B2AH   A   
CHIPBOARD_ID. . . . . . . . . . . . . .    X ADDR   0000H   A   
CHIPID. . . . . . . . . . . . . . . . .    D ADDR   00C2H   A   
CHKBACKRETURN . . . . . . . . . . . . .    C ADDR   0394H   A   
CLEARCOUNTER_ . . . . . . . . . . . . .    C ADDR   1862H   A   
CLEARFRAMECOUNTER_. . . . . . . . . . .    C ADDR   1A21H   A   
CLEARPERIOD_. . . . . . . . . . . . . .    C ADDR   18B5H   A   
CLEARTIMER_ . . . . . . . . . . . . . .    C ADDR   16BFH   A   
CLEARTRIGGER_ . . . . . . . . . . . . .    C ADDR   19A0H   A   
CLOSESHUTTER. . . . . . . . . . . . . .    C ADDR   015AH   A   
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    83

CLOSESHUTTERINT . . . . . . . . . . . .    C ADDR   018DH   A   
CLOSESHUTTERINTTIMEPIX. . . . . . . . .    C ADDR   01A8H   A   
CLOSESHUTTERTIMEPIX . . . . . . . . . .    C ADDR   0171H   A   
CNT2. . . . . . . . . . . . . . . . . .    B ADDR   00C8H.1 A   
COINCAPPROVED . . . . . . . . . . . . .    C ADDR   009DH   A   
COINCFINALNOTIFDONE . . . . . . . . . .    C ADDR   0512H   A   
COINCFINALNOTIFICATION. . . . . . . . .    C ADDR   04F2H   A   
COINCFINALNOTIFYMAKE. . . . . . . . . .    C ADDR   0500H   A   
COINCIDENCEMODE . . . . . . . . . . . .    C ADDR   0083H   A   
COINCIDENCEMODEEND. . . . . . . . . . .    C ADDR   00B1H   A   
COINCNOTIFPULSE . . . . . . . . . . . .    C ADDR   00AAH   A   
COINCREJECTED . . . . . . . . . . . . .    C ADDR   0093H   A   
COINCRESETEVENTFLAGS. . . . . . . . . .    C ADDR   050CH   A   
COINCTESTHIGH . . . . . . . . . . . . .    C ADDR   0083H   A   
COINCTESTLOW. . . . . . . . . . . . . .    C ADDR   008BH   A   
COINC_COINCEVENT. . . . . . . . . . . .    B ADDR   00E0H.6 A   
COINC_INVALIDCOINC. . . . . . . . . . .    B ADDR   00E0H.7 A   
COINC_NOTIFY. . . . . . . . . . . . . .    B ADDR   00E0H.2 A   
COINC_NOTIFYBYPULSE . . . . . . . . . .    B ADDR   00E0H.5 A   
COINC_NOTIFYINITLEVEL . . . . . . . . .    B ADDR   00E0H.3 A   
COINC_NOTIFYVALIDCOINC. . . . . . . . .    B ADDR   00E0H.4 A   
COINC_TEST. . . . . . . . . . . . . . .    B ADDR   00E0H.0 A   
COMMANDRECEIVED . . . . . . . . . . . .    C ADDR   0282H   A   
COMPSERV_CPURESET . . . . . . . . . . .    C ADDR   08A6H   A   
COMSERV_ABORTEXPOSITION . . . . . . . .    C ADDR   176CH   A   
COMSERV_CHIPBOARDID . . . . . . . . . .    C ADDR   0B57H   A   
COMSERV_CLOSESHUTTER. . . . . . . . . .    C ADDR   0C70H   A   
COMSERV_CLOSESHUTTERANDSENDDATA . . . .    C ADDR   0C74H   A   
COMSERV_CMOSTEST. . . . . . . . . . . .    C ADDR   1663H   A   
COMSERV_COUNTERSET. . . . . . . . . . .    C ADDR   186EH   A   
COMSERV_COUNTERSTART. . . . . . . . . .    C ADDR   186EH   A   
COMSERV_COUNTERSTOP . . . . . . . . . .    C ADDR   1881H   A   
COMSERV_DCSWITCHOFF . . . . . . . . . .    C ADDR   0D3CH   A   
COMSERV_DCSWITCHON. . . . . . . . . . .    C ADDR   0D39H   A   
COMSERV_ERASEMATRIX . . . . . . . . . .    C ADDR   0967H   A   
COMSERV_FLASH . . . . . . . . . . . . .    C ADDR   160CH   A   
COMSERV_FLASH_INVALID . . . . . . . . .    C ADDR   1635H   A   
COMSERV_FRAMECOUNTERSET . . . . . . . .    C ADDR   1A2DH   A   
COMSERV_FRAMECOUNTERSTART . . . . . . .    C ADDR   1A45H   A   
COMSERV_FRAMECOUNTERSTATE . . . . . . .    C ADDR   1A56H   A   
COMSERV_GETTODO . . . . . . . . . . . .    C ADDR   1AE1H   A   
COMSERV_HELP. . . . . . . . . . . . . .    C ADDR   0D17H   A   
COMSERV_I2CTEST . . . . . . . . . . . .    C ADDR   1678H   A   
COMSERV_INFO. . . . . . . . . . . . . .    C ADDR   0D32H   A   
COMSERV_INTERVALELAPSEDTIME . . . . . .    C ADDR   17E4H   A   
COMSERV_INTERVALEXPOSITION. . . . . . .    C ADDR   1708H   A   
COMSERV_INTERVALEXPOSITIONSET . . . . .    C ADDR   1706H   A   
COMSERV_INTERVALMULTIEXPOSITION . . . .    C ADDR   1738H   A   
COMSERV_INTERVALRESET . . . . . . . . .    C ADDR   1791H   A   
COMSERV_INTERVALSET . . . . . . . . . .    C ADDR   177DH   A   
COMSERV_INTERVALSTATE . . . . . . . . .    C ADDR   1799H   A   
COMSERV_INTERVALSTOP. . . . . . . . . .    C ADDR   1794H   A   
COMSERV_LVDSTEST. . . . . . . . . . . .    C ADDR   1636H   A   
COMSERV_MAKETODO. . . . . . . . . . . .    C ADDR   1AEAH   A   
COMSERV_MEDIPIXCOUNT. . . . . . . . . .    C ADDR   0961H   A   
COMSERV_OPENSHUTTER . . . . . . . . . .    C ADDR   0C58H   A   
COMSERV_OSCILATINGSHUTTER . . . . . . .    C ADDR   0DA9H   A   
COMSERV_PERIODICALEXPOSITION. . . . . .    C ADDR   1935H   A   
COMSERV_PERIODSET . . . . . . . . . . .    C ADDR   18DCH   A   
COMSERV_PERIODSTART . . . . . . . . . .    C ADDR   18C1H   A   
COMSERV_PERIODSTATE . . . . . . . . . .    C ADDR   18F3H   A   
COMSERV_PERIODSTOP. . . . . . . . . . .    C ADDR   18EEH   A   
COMSERV_POLARITYNEGATIVE. . . . . . . .    C ADDR   0CFDH   A   
COMSERV_POLARITYPOSITIVE. . . . . . . .    C ADDR   0D07H   A   
COMSERV_READMATRIX. . . . . . . . . . .    C ADDR   0A1FH   A   
COMSERV_READMATRIXCLEAR . . . . . . . .    C ADDR   0A7BH   A   
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    84

COMSERV_RESET . . . . . . . . . . . . .    C ADDR   08AFH   A   
COMSERV_RESETBIAS . . . . . . . . . . .    C ADDR   0D77H   A   
COMSERV_RESETMPXSTARTTRIGGERSTARTINTERVAL  C ADDR   15CAH   A   
COMSERV_RESETTODEFAULT. . . . . . . . .    C ADDR   08C4H   A   
COMSERV_SCOPECONFIGURE. . . . . . . . .    C ADDR   1BE0H   A   
COMSERV_SCOPESENDDATA . . . . . . . . .    C ADDR   1BB9H   A   
COMSERV_SELECTFSR0. . . . . . . . . . .    C ADDR   0CE9H   A   
COMSERV_SELECTFSR1. . . . . . . . . . .    C ADDR   0CF3H   A   
COMSERV_SENDCMOSSETTINGS. . . . . . . .    C ADDR   0D11H   A   
COMSERV_SETBIAS . . . . . . . . . . . .    C ADDR   0D62H   A   
COMSERV_SETDAC. . . . . . . . . . . . .    C ADDR   0D7AH   A   
COMSERV_SETDACS . . . . . . . . . . . .    C ADDR   0C18H   A   
COMSERV_SETDELAY. . . . . . . . . . . .    C ADDR   1A8BH   A   
COMSERV_SETMATRIXDEFAULT. . . . . . . .    C ADDR   08DAH   A   
COMSERV_SETMATRIXDEFAULTNOTIFY. . . . .    C ADDR   094DH   A   
COMSERV_SETMATRIXSTREAM . . . . . . . .    C ADDR   09CAH   A   
COMSERV_SETMATRIXTESTPATTERN. . . . . .    C ADDR   0948H   A   
COMSERV_SETTODO . . . . . . . . . . . .    C ADDR   1AD8H   A   
COMSERV_SETTPXCLOCK . . . . . . . . . .    C ADDR   0D3FH   A   
COMSERV_SYNCHONIZATION. . . . . . . . .    C ADDR   0DA2H   A   
COMSERV_TESTFSR . . . . . . . . . . . .    C ADDR   0AC7H   A   
COMSERV_TESTFSRCYCLIC . . . . . . . . .    C ADDR   0B34H   A   
COMSERV_TESTPULSE . . . . . . . . . . .    C ADDR   0C79H   A   
COMSERV_TRIGGERCOINCSET . . . . . . . .    C ADDR   19C3H   A   
COMSERV_TRIGGEROUTCPL . . . . . . . . .    C ADDR   1AF5H   A   
COMSERV_TRIGGEROUTHIGH. . . . . . . . .    C ADDR   1AEFH   A   
COMSERV_TRIGGEROUTLOW . . . . . . . . .    C ADDR   1AF2H   A   
COMSERV_TRIGGERSET. . . . . . . . . . .    C ADDR   19BEH   A   
COMSERV_TRIGGERSTART. . . . . . . . . .    C ADDR   19ACH   A   
COMSERV_TRIGGERSTATE. . . . . . . . . .    C ADDR   19DEH   A   
COMSERV_TRIGGERSTOP . . . . . . . . . .    C ADDR   19DBH   A   
COMSERV_WATCHDOGTEST. . . . . . . . . .    C ADDR   0D9FH   A   
COM_TABLE . . . . . . . . . . . . . . .    C ADDR   0513H   A   
COUNTERCLEAR. . . . . . . . . . . . . .    C ADDR   1852H   A   
COUNTERDEFAULT. . . . . . . . . . . . .    C ADDR   1836H   A   
COUNTERINCREMENT. . . . . . . . . . . .    C ADDR   0115H   A   
COUNTEROVERFLOW . . . . . . . . . . . .    C ADDR   011DH   A   
COUNTERRETURN . . . . . . . . . . . . .    C ADDR   0125H   A   
COUNTER_COUNT . . . . . . . . . . . . .    D ADDR   0049H   A   
COUNTER_CURR. . . . . . . . . . . . . .    D ADDR   004FH   A   
COUNTER_TODO. . . . . . . . . . . . . .    D ADDR   0053H   A   
CPHA. . . . . . . . . . . . . . . . . .    B ADDR   00F8H.2 A   
CPOL. . . . . . . . . . . . . . . . . .    B ADDR   00F8H.3 A   
CS0 . . . . . . . . . . . . . . . . . .    B ADDR   00D8H.0 A   
CS080 . . . . . . . . . . . . . . . . .    C ADDR   0C2FH   A   
CS1 . . . . . . . . . . . . . . . . . .    B ADDR   00D8H.1 A   
CS2 . . . . . . . . . . . . . . . . . .    B ADDR   00D8H.2 A   
CS3 . . . . . . . . . . . . . . . . . .    B ADDR   00D8H.3 A   
CSSTC_0 . . . . . . . . . . . . . . . .    C ADDR   0D44H   A   
CSSTC_1 . . . . . . . . . . . . . . . .    C ADDR   0D4BH   A   
CSSTC_2 . . . . . . . . . . . . . . . .    C ADDR   0D54H   A   
CSSTC_3 . . . . . . . . . . . . . . . .    C ADDR   0D5DH   A   
DAC0H . . . . . . . . . . . . . . . . .    D ADDR   00FAH   A   
DAC0L . . . . . . . . . . . . . . . . .    D ADDR   00F9H   A   
DAC1H . . . . . . . . . . . . . . . . .    D ADDR   00FCH   A   
DAC1L . . . . . . . . . . . . . . . . .    D ADDR   00FBH   A   
DACCON. . . . . . . . . . . . . . . . .    D ADDR   00FDH   A   
DACDEFENDS. . . . . . . . . . . . . . .    C ADDR   0BE6H   A   
DCON. . . . . . . . . . . . . . . . . .    D ADDR   00E8H   A   
DCSHUTDOWN. . . . . . . . . . . . . . .    B ADDR   00A0H.7 A   
DELAYDEFAULT. . . . . . . . . . . . . .    C ADDR   1A83H   A   
DELAY_HOWMUCH . . . . . . . . . . . . .    D ADDR   005CH   A   
DELAY_TODOWHEN. . . . . . . . . . . . .    D ADDR   005BH   A   
DMA . . . . . . . . . . . . . . . . . .    B ADDR   00D8H.6 A   
DMAH. . . . . . . . . . . . . . . . . .    D ADDR   00D3H   A   
DMAL. . . . . . . . . . . . . . . . . .    D ADDR   00D2H   A   
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    85

DMAP. . . . . . . . . . . . . . . . . .    D ADDR   00D4H   A   
DONTREFRESHNOW. . . . . . . . . . . . .    C ADDR   0277H   A   
DPCON . . . . . . . . . . . . . . . . .    D ADDR   00A7H   A   
DPH . . . . . . . . . . . . . . . . . .    D ADDR   0083H   A   
DPL . . . . . . . . . . . . . . . . . .    D ADDR   0082H   A   
DPP . . . . . . . . . . . . . . . . . .    D ADDR   0084H   A   
DRM_1 . . . . . . . . . . . . . . . . .    C ADDR   09BDH   A   
DUMMYREADMATRIX . . . . . . . . . . . .    C ADDR   09A7H   A   
EA. . . . . . . . . . . . . . . . . . .    B ADDR   00A8H.7 A   
EADC. . . . . . . . . . . . . . . . . .    B ADDR   00A8H.6 A   
EADRH . . . . . . . . . . . . . . . . .    D ADDR   00C7H   A   
EADRL . . . . . . . . . . . . . . . . .    D ADDR   00C6H   A   
ECON. . . . . . . . . . . . . . . . . .    D ADDR   00B9H   A   
EDATA1. . . . . . . . . . . . . . . . .    D ADDR   00BCH   A   
EDATA2. . . . . . . . . . . . . . . . .    D ADDR   00BDH   A   
EDATA3. . . . . . . . . . . . . . . . .    D ADDR   00BEH   A   
EDATA4. . . . . . . . . . . . . . . . .    D ADDR   00BFH   A   
ENDOFCOMMAND. . . . . . . . . . . . . .    C ADDR   02FEH   A   
ENDOFPROCESSCOMMAND . . . . . . . . . .    C ADDR   0328H   A   
ERASEMATRIXBYTE . . . . . . . . . . . .    C ADDR   0987H   A   
ERASEMATRIXBYTECONTINUE . . . . . . . .    C ADDR   0998H   A   
ERASEMATRIXEND. . . . . . . . . . . . .    C ADDR   09A1H   A   
ERROROCCURED. . . . . . . . . . . . . .    C ADDR   030BH   A   
ES. . . . . . . . . . . . . . . . . . .    B ADDR   00A8H.4 A   
ET0 . . . . . . . . . . . . . . . . . .    B ADDR   00A8H.1 A   
ET1 . . . . . . . . . . . . . . . . . .    B ADDR   00A8H.3 A   
ET2 . . . . . . . . . . . . . . . . . .    B ADDR   00A8H.5 A   
EX0 . . . . . . . . . . . . . . . . . .    B ADDR   00A8H.0 A   
EXEN2 . . . . . . . . . . . . . . . . .    B ADDR   00C8H.3 A   
EXF2. . . . . . . . . . . . . . . . . .    B ADDR   00C8H.6 A   
F1. . . . . . . . . . . . . . . . . . .    B ADDR   00D0H.1 A   
FLASH_ERASE . . . . . . . . . . . . . .    N NUMB   0005H   A   
FLASH_READ. . . . . . . . . . . . . . .    N NUMB   0001H   A   
FLASH_READBYTE. . . . . . . . . . . . .    N NUMB   0081H   A   
FLASH_VERIFY. . . . . . . . . . . . . .    N NUMB   0004H   A   
FLASH_WRITE . . . . . . . . . . . . . .    N NUMB   0002H   A   
FLASH_WRITEBYTE . . . . . . . . . . . .    N NUMB   0082H   A   
FRAMECOUNTERCLEAR . . . . . . . . . . .    C ADDR   1A15H   A   
FRAMECOUNTERDEFAULT . . . . . . . . . .    C ADDR   1A03H   A   
FRAMECOUNTERINCREMENT . . . . . . . . .    C ADDR   04CEH   A   
FRAMECOUNTEROVERFLOW. . . . . . . . . .    C ADDR   04D6H   A   
FRAMECOUNTERRESTART . . . . . . . . . .    C ADDR   1A45H   A   
FRAMECOUNTTEST. . . . . . . . . . . . .    C ADDR   04C9H   A   
FRAMEDONE . . . . . . . . . . . . . . .    C ADDR   04EDH   A   
FRAME_COUNT . . . . . . . . . . . . . .    D ADDR   005EH   A   
FRAME_CURR. . . . . . . . . . . . . . .    D ADDR   0062H   A   
FRAME_TODO. . . . . . . . . . . . . . .    D ADDR   0066H   A   
FTCLEAREND. . . . . . . . . . . . . . .    C ADDR   1D6FH   A   
FTCLRNEXT . . . . . . . . . . . . . . .    C ADDR   1D68H   A   
FT_010. . . . . . . . . . . . . . . . .    C ADDR   1D72H   A   
FT_020. . . . . . . . . . . . . . . . .    C ADDR   1D80H   A   
FT_CHECKCHAR. . . . . . . . . . . . . .    C ADDR   1D57H   A   
FT_CLEARFIFO. . . . . . . . . . . . . .    C ADDR   1D62H   A   
FT_GETCHAR. . . . . . . . . . . . . . .    C ADDR   1D47H   A   
FT_PORT . . . . . . . . . . . . . . . .    D ADDR   0080H   A   
FT_RD . . . . . . . . . . . . . . . . .    B ADDR   00A0H.0 A   
FT_RXF. . . . . . . . . . . . . . . . .    B ADDR   00A0H.3 A   
FT_SENDCHAR . . . . . . . . . . . . . .    C ADDR   1D3FH   A   
FT_SENDSTRING . . . . . . . . . . . . .    C ADDR   1D70H   A   
FT_TAKECHAR . . . . . . . . . . . . . .    C ADDR   1D5CH   A   
FT_TXE. . . . . . . . . . . . . . . . .    B ADDR   00A0H.2 A   
FT_WR . . . . . . . . . . . . . . . . .    B ADDR   00A0H.1 A   
GENERATESINGLEPULSE . . . . . . . . . .    C ADDR   0C9FH   A   
GETCHIPBOARDTYPEANDIDSILENT . . . . . .    C ADDR   0B75H   A   
GOTONEXTIDBYTES . . . . . . . . . . . .    C ADDR   0BC9H   A   
GOTONEXTIDBYTESDECA . . . . . . . . . .    C ADDR   0BC8H   A   
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    86

HELPFINISHED. . . . . . . . . . . . . .    C ADDR   0D2CH   A   
HELPSINGLECOMMAND . . . . . . . . . . .    C ADDR   0D20H   A   
HOUR. . . . . . . . . . . . . . . . . .    D ADDR   00A5H   A   
HTHSEC. . . . . . . . . . . . . . . . .    D ADDR   00A2H   A   
I2CADD. . . . . . . . . . . . . . . . .    D ADDR   009BH   A   
I2CADD1 . . . . . . . . . . . . . . . .    D ADDR   0091H   A   
I2CADD2 . . . . . . . . . . . . . . . .    D ADDR   0092H   A   
I2CADD3 . . . . . . . . . . . . . . . .    D ADDR   0093H   A   
I2CCON. . . . . . . . . . . . . . . . .    D ADDR   00E8H   A   
I2CDAT. . . . . . . . . . . . . . . . .    D ADDR   009AH   A   
I2CGC . . . . . . . . . . . . . . . . .    B ADDR   00E8H.6 A   
I2CI. . . . . . . . . . . . . . . . . .    B ADDR   00E8H.0 A   
I2CID0. . . . . . . . . . . . . . . . .    B ADDR   00E8H.4 A   
I2CID1. . . . . . . . . . . . . . . . .    B ADDR   00E8H.5 A   
I2CM. . . . . . . . . . . . . . . . . .    B ADDR   00E8H.3 A   
I2CRS . . . . . . . . . . . . . . . . .    B ADDR   00E8H.2 A   
I2CSI . . . . . . . . . . . . . . . . .    B ADDR   00E8H.7 A   
I2CTEST_JUSTREAD. . . . . . . . . . . .    C ADDR   1687H   A   
I2CTX . . . . . . . . . . . . . . . . .    B ADDR   00E8H.1 A   
IEIP2 . . . . . . . . . . . . . . . . .    D ADDR   00A9H   A   
IGNORENEXTTRG . . . . . . . . . . . . .    B ADDR   0023H.0 A   
INITMEDIPIX . . . . . . . . . . . . . .    C ADDR   022EH   A   
INNERDELAYLOOP. . . . . . . . . . . . .    C ADDR   1AABH   A   
INNERDELAYLOOP1 . . . . . . . . . . . .    C ADDR   1ACAH   A   
INTERVALCLEAR . . . . . . . . . . . . .    C ADDR   16AFH   A   
INTERVALDEFAULT . . . . . . . . . . . .    C ADDR   1695H   A   
INTERVALELAPSEDTIME . . . . . . . . . .    C ADDR   17E4H   A   
INTERVALEXPOSITION. . . . . . . . . . .    C ADDR   1708H   A   
INTERVALINCREMENT . . . . . . . . . . .    C ADDR   00E8H   A   
INTERVALMEASURE . . . . . . . . . . . .    C ADDR   16CBH   A   
INTERVALOVERFLOW. . . . . . . . . . . .    C ADDR   00F0H   A   
INTERVALRESTART . . . . . . . . . . . .    C ADDR   16E8H   A   
INTERVALRETURN. . . . . . . . . . . . .    C ADDR   00FEH   A   
INTERVAL_CURR . . . . . . . . . . . . .    D ADDR   0038H   A   
INTERVAL_MODE . . . . . . . . . . . . .    D ADDR   003DH   A   
INTERVAL_TIME . . . . . . . . . . . . .    D ADDR   0032H   A   
INTERVAL_TODO . . . . . . . . . . . . .    D ADDR   003CH   A   
INTVAL. . . . . . . . . . . . . . . . .    D ADDR   00A6H   A   
INT_ADCI. . . . . . . . . . . . . . . .    C ADDR   00CDH   A   
INT_IE0 . . . . . . . . . . . . . . . .    C ADDR   005FH   A   
INT_IE1 . . . . . . . . . . . . . . . .    C ADDR   0107H   A   
INT_ISPI_I2CI . . . . . . . . . . . . .    C ADDR   012EH   A   
INT_PSMI. . . . . . . . . . . . . . . .    C ADDR   005DH   A   
INT_RI_TI . . . . . . . . . . . . . . .    C ADDR   012FH   A   
INT_TF0 . . . . . . . . . . . . . . . .    C ADDR   00DBH   A   
INT_TF1 . . . . . . . . . . . . . . . .    C ADDR   0108H   A   
INT_TF2_EXF2. . . . . . . . . . . . . .    C ADDR   0130H   A   
INT_TII . . . . . . . . . . . . . . . .    C ADDR   0159H   A   
INT_WDS . . . . . . . . . . . . . . . .    C ADDR   005EH   A   
ISPI. . . . . . . . . . . . . . . . . .    B ADDR   00F8H.7 A   
IT0 . . . . . . . . . . . . . . . . . .    B ADDR   0088H.0 A   
ITA_MEASUREMODE . . . . . . . . . . . .    C ADDR   17E8H   A   
ITS_INTERRUPTMODE . . . . . . . . . . .    C ADDR   180AH   A   
JUSTMONITOR . . . . . . . . . . . . . .    C ADDR   00D4H   A   
JUSTREFRESHWATCHDOG . . . . . . . . . .    C ADDR   02C4H   A   
LATCHENABLE . . . . . . . . . . . . . .    B ADDR   00A0H.4 A   
MAIN. . . . . . . . . . . . . . . . . .    C ADDR   01C8H   A   
MAKEDELAY . . . . . . . . . . . . . . .    C ADDR   1A9AH   A   
MAKEDELAYNOTPUSHA . . . . . . . . . . .    C ADDR   1ABBH   A   
MAKEREFRESHWATCHDOG . . . . . . . . . .    C ADDR   02BAH   A   
MAKEWATHCHDOGREFRESH. . . . . . . . . .    C ADDR   02A9H   A   
MCO . . . . . . . . . . . . . . . . . .    B ADDR   00E8H.5 A   
MDE . . . . . . . . . . . . . . . . . .    B ADDR   00E8H.6 A   
MDI . . . . . . . . . . . . . . . . . .    B ADDR   00E8H.4 A   
MDO . . . . . . . . . . . . . . . . . .    B ADDR   00E8H.7 A   
MILISECOND. . . . . . . . . . . . . . .    C ADDR   1D0FH   A   
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    87

MIN . . . . . . . . . . . . . . . . . .    D ADDR   00A4H   A   
MONITORSETUP. . . . . . . . . . . . . .    C ADDR   1C00H   A   
MONITORSINGLESHOTMEASUREMENT. . . . . .    C ADDR   1C1FH   A   
MONITOR_BUFF. . . . . . . . . . . . . .    X ADDR   03A8H   A   
MPX21_DOUBLE. . . . . . . . . . . . . .    C ADDR   0891H   A   
MPX21_QUAD. . . . . . . . . . . . . . .    C ADDR   0897H   A   
MPX21_SINGLE. . . . . . . . . . . . . .    C ADDR   088EH   A   
MPX21_TRIPLE. . . . . . . . . . . . . .    C ADDR   0894H   A   
MPXMXR_DOUBLE . . . . . . . . . . . . .    C ADDR   089DH   A   
MPXMXR_QUAD . . . . . . . . . . . . . .    C ADDR   08A3H   A   
MPXMXR_SINGLE . . . . . . . . . . . . .    C ADDR   089AH   A   
MPXMXR_TRIPLE . . . . . . . . . . . . .    C ADDR   08A0H   A   
MPX_CHIPS . . . . . . . . . . . . . . .    D ADDR   0030H   A   
MPX_ISMXR . . . . . . . . . . . . . . .    D ADDR   0031H   A   
MSSMSENDCHANNEL . . . . . . . . . . . .    C ADDR   1C4CH   A   
M_CMOSIN. . . . . . . . . . . . . . . .    D ADDR   0021H   A   
M_ENABLEIN. . . . . . . . . . . . . . .    B ADDR   00A0H.6 A   
M_ENABLEOUT . . . . . . . . . . . . . .    B ADDR   00A0H.5 A   
M_ENABLEPULSE . . . . . . . . . . . . .    B ADDR   0021H.2 A   
M_M0. . . . . . . . . . . . . . . . . .    B ADDR   0021H.6 A   
M_M1. . . . . . . . . . . . . . . . . .    B ADDR   0021H.5 A   
M_POLARITY. . . . . . . . . . . . . . .    B ADDR   0021H.3 A   
M_PORT. . . . . . . . . . . . . . . . .    D ADDR   0080H   A   
M_PULSEADRESS . . . . . . . . . . . . .    B ADDR   0021H.1 A   
M_RESET . . . . . . . . . . . . . . . .    B ADDR   0021H.0 A   
M_SHUTTER . . . . . . . . . . . . . . .    B ADDR   0021H.7 A   
M_SPAREFSR. . . . . . . . . . . . . . .    B ADDR   0021H.4 A   
NCT_MXRCHIPBOARD. . . . . . . . . . . .    C ADDR   0C00H   A   
NCT_NOTMXRCHIPBOARD . . . . . . . . . .    C ADDR   0C05H   A   
NCT_SENDTYPE. . . . . . . . . . . . . .    C ADDR   0C08H   A   
NEXTITEM. . . . . . . . . . . . . . . .    C ADDR   0313H   A   
NONCOINCIDENCEMODE. . . . . . . . . . .    C ADDR   00B3H   A   
NORMALRESET . . . . . . . . . . . . . .    C ADDR   0228H   A   
NOTIFYCHIPBOARDTYPE . . . . . . . . . .    C ADDR   0BF4H   A   
NOTIFYNUMBEROFCHIPS . . . . . . . . . .    C ADDR   094FH   A   
NO_TODO_CLOSESHUTTER. . . . . . . . . .    C ADDR   1C79H   A   
NO_TODO_MAKECOMMAND1. . . . . . . . . .    C ADDR   1CA9H   A   
NO_TODO_MAKECOMMAND2. . . . . . . . . .    C ADDR   1CB1H   A   
NO_TODO_OPENSHUTTER . . . . . . . . . .    C ADDR   1C81H   A   
NO_TODO_STARTCOUNTER. . . . . . . . . .    C ADDR   1CA1H   A   
NO_TODO_STARTINTERVAL . . . . . . . . .    C ADDR   1C89H   A   
NO_TODO_STARTSCOPE. . . . . . . . . . .    C ADDR   1C91H   A   
NO_TODO_STARTTRIGGER. . . . . . . . . .    C ADDR   1C99H   A   
OFLAGS. . . . . . . . . . . . . . . . .    D ADDR   0023H   A   
ONECOUNTERBYTE. . . . . . . . . . . . .    C ADDR   1873H   A   
ONEINTERVALBYTE . . . . . . . . . . . .    C ADDR   1782H   A   
ONEINTERVALBYTESEND . . . . . . . . . .    C ADDR   17B0H   A   
ONEMICLOOPENTRY . . . . . . . . . . . .    C ADDR   1CE7H   A   
ONEMICROSECND . . . . . . . . . . . . .    C ADDR   1CD7H   A   
ONEPERIODBYTE . . . . . . . . . . . . .    C ADDR   18E1H   A   
ONEPERIODBYTESEND . . . . . . . . . . .    C ADDR   1908H   A   
OTHERIDBYTEFOLLOWSS . . . . . . . . . .    C ADDR   0BDEH   A   
P0. . . . . . . . . . . . . . . . . . .    D ADDR   0080H   A   
P2. . . . . . . . . . . . . . . . . . .    D ADDR   00A0H   A   
P3. . . . . . . . . . . . . . . . . . .    D ADDR   00B0H   A   
PADC. . . . . . . . . . . . . . . . . .    B ADDR   00B8H.6 A   
PERIODCLEAR . . . . . . . . . . . . . .    C ADDR   18A5H   A   
PERIODDEFAULT . . . . . . . . . . . . .    C ADDR   1886H   A   
PERIODINCREMENT . . . . . . . . . . . .    C ADDR   013FH   A   
PERIODOVERFLOW. . . . . . . . . . . . .    C ADDR   0147H   A   
PERIODRESTART . . . . . . . . . . . . .    C ADDR   18C1H   A   
PERIODRETURN. . . . . . . . . . . . . .    C ADDR   0150H   A   
PERIOD_CURR . . . . . . . . . . . . . .    D ADDR   0044H   A   
PERIOD_TIME . . . . . . . . . . . . . .    D ADDR   003EH   A   
PERIOD_TODO . . . . . . . . . . . . . .    D ADDR   0048H   A   
PLLCON. . . . . . . . . . . . . . . . .    D ADDR   00D7H   A   
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    88

PRE0. . . . . . . . . . . . . . . . . .    B ADDR   00C0H.4 A   
PRE1. . . . . . . . . . . . . . . . . .    B ADDR   00C0H.5 A   
PRE2. . . . . . . . . . . . . . . . . .    B ADDR   00C0H.6 A   
PRE3. . . . . . . . . . . . . . . . . .    B ADDR   00C0H.7 A   
PROCESSCOMMAND. . . . . . . . . . . . .    C ADDR   02CDH   A   
PROCESSTODO . . . . . . . . . . . . . .    C ADDR   039DH   A   
PSI . . . . . . . . . . . . . . . . . .    B ADDR   00B8H.7 A   
PSMCON. . . . . . . . . . . . . . . . .    D ADDR   00DFH   A   
PSW . . . . . . . . . . . . . . . . . .    D ADDR   00D0H   A   
PT2 . . . . . . . . . . . . . . . . . .    B ADDR   00B8H.5 A   
PWM0H . . . . . . . . . . . . . . . . .    D ADDR   00B2H   A   
PWM0L . . . . . . . . . . . . . . . . .    D ADDR   00B1H   A   
PWM1H . . . . . . . . . . . . . . . . .    D ADDR   00B4H   A   
PWM1L . . . . . . . . . . . . . . . . .    D ADDR   00B3H   A   
PWMCON. . . . . . . . . . . . . . . . .    D ADDR   00AEH   A   
PX0 . . . . . . . . . . . . . . . . . .    B ADDR   00B8H.0 A   
RCAP2H. . . . . . . . . . . . . . . . .    D ADDR   00CBH   A   
RCAP2L. . . . . . . . . . . . . . . . .    D ADDR   00CAH   A   
RCLK. . . . . . . . . . . . . . . . . .    B ADDR   00C8H.5 A   
READMATRIX. . . . . . . . . . . . . . .    C ADDR   0A23H   A   
READMATRIXANDTIME . . . . . . . . . . .    C ADDR   0A20H   A   
READMATRIXCLEAR . . . . . . . . . . . .    C ADDR   0A7FH   A   
READMATRIXCLEARANDTIME. . . . . . . . .    C ADDR   0A7CH   A   
READMATRIXCLEARCONTINUE . . . . . . . .    C ADDR   0ABAH   A   
READMATRIXCLEAREND. . . . . . . . . . .    C ADDR   0AC1H   A   
READMATRIXCLEARLOOP . . . . . . . . . .    C ADDR   0AA0H   A   
READMATRIXCLEARLOOPENTRY. . . . . . . .    C ADDR   0AA2H   A   
READMATRIXCONTINUE. . . . . . . . . . .    C ADDR   0A66H   A   
READMATRIXEND . . . . . . . . . . . . .    C ADDR   0A75H   A   
READMATRIXLOOP. . . . . . . . . . . . .    C ADDR   0A44H   A   
READMATRIXLOOPENTRY . . . . . . . . . .    C ADDR   0A49H   A   
READOUTANDSENDMATRIX. . . . . . . . . .    C ADDR   04B9H   A   
READOUTORRESETMATRIX. . . . . . . . . .    C ADDR   046EH   A   
RESETBYWATCHDOG . . . . . . . . . . . .    C ADDR   0220H   A   
RESETMATRIXNOTIFYANDCONTINUE. . . . . .    C ADDR   0476H   A   
RETURNTRIGGERCOINCSET . . . . . . . . .    C ADDR   19DAH   A   
RETURNTRIGGERDEFAULT. . . . . . . . . .    C ADDR   198FH   A   
RI. . . . . . . . . . . . . . . . . . .    B ADDR   0098H.0 A   
SBUF. . . . . . . . . . . . . . . . . .    D ADDR   0099H   A   
SCL_I2C . . . . . . . . . . . . . . . .    B ADDR   00B0H.6 A   
SCON. . . . . . . . . . . . . . . . . .    D ADDR   0098H   A   
SCONV . . . . . . . . . . . . . . . . .    B ADDR   00D8H.4 A   
SCOPESENDDATA . . . . . . . . . . . . .    C ADDR   1BB9H   A   
SCOPESETDEFAULTS. . . . . . . . . . . .    C ADDR   1AF8H   A   
SCOPESETUP. . . . . . . . . . . . . . .    C ADDR   1B06H   A   
SCOPESETUPADC . . . . . . . . . . . . .    C ADDR   1B95H   A   
SCOPESINGLESHOTMEASUREMENT. . . . . . .    C ADDR   1BA9H   A   
SCOPETGRDISABLED. . . . . . . . . . . .    B ADDR   0023H.1 A   
SCOPE_BUFF. . . . . . . . . . . . . . .    X ADDR   0020H   A   
SCOPE_BUFFLEN . . . . . . . . . . . . .    N NUMB   0388H   A   
SCOPE_CHANBUFF. . . . . . . . . . . . .    D ADDR   006DH   A   
SCOPE_CHANCNT . . . . . . . . . . . . .    D ADDR   0075H   A   
SCOPE_CHANNELS. . . . . . . . . . . . .    D ADDR   006CH   A   
SCOPE_DATALEN . . . . . . . . . . . . .    N NUMB   0384H   A   
SCOPE_DEFCHANMSK. . . . . . . . . . . .    N NUMB   0002H   A   
SCOPE_MAXCOUNT. . . . . . . . . . . . .    N NUMB   01C2H   A   
SCOPE_SAMPLES . . . . . . . . . . . . .    D ADDR   0069H   A   
SCOPE_TIMING. . . . . . . . . . . . . .    D ADDR   006BH   A   
SDA_I2C . . . . . . . . . . . . . . . .    B ADDR   00B0H.4 A   
SEC . . . . . . . . . . . . . . . . . .    D ADDR   00A3H   A   
SENDREPORT. . . . . . . . . . . . . . .    C ADDR   0306H   A   
SENDTODODESCRIPTION . . . . . . . . . .    C ADDR   1C5EH   A   
SETBIAS . . . . . . . . . . . . . . . .    C ADDR   0D65H   A   
SETDAC. . . . . . . . . . . . . . . . .    C ADDR   0D8FH   A   
SETDAC0 . . . . . . . . . . . . . . . .    C ADDR   0D91H   A   
SETDAC1 . . . . . . . . . . . . . . . .    C ADDR   0D98H   A   
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    89

SETDACDEFBYTES. . . . . . . . . . . . .    C ADDR   0BB3H   A   
SETDACDEFNEXTBYTES. . . . . . . . . . .    C ADDR   0BE0H   A   
SETMATRIXBYTEDEFCONTINUE. . . . . . . .    C ADDR   0920H   A   
SETMATRIXCONTINUE . . . . . . . . . . .    C ADDR   0A10H   A   
SETMATRIXDEFBYTE. . . . . . . . . . . .    C ADDR   0903H   A   
SETMATRIXDEFEND . . . . . . . . . . . .    C ADDR   0942H   A   
SETMATRIXDEFERROR . . . . . . . . . . .    C ADDR   095DH   A   
SETMATRIXEND. . . . . . . . . . . . . .    C ADDR   0A19H   A   
SETMATRIXLOOP . . . . . . . . . . . . .    C ADDR   09E7H   A   
SETMATRIXNOMPXDETECTED. . . . . . . . .    C ADDR   0917H   A   
SETMATRIXR2 . . . . . . . . . . . . . .    C ADDR   08DCH   A   
SETMATRIXSTARTBYTES . . . . . . . . . .    C ADDR   08FCH   A   
SETUPSCOPECHANSWAP. . . . . . . . . . .    C ADDR   1B4CH   A   
SETUPSCOPECHECKCHAN . . . . . . . . . .    C ADDR   1B3AH   A   
SETUPSCOPENEXT. . . . . . . . . . . . .    C ADDR   1B43H   A   
SETUPSCOPESCANBITS. . . . . . . . . . .    C ADDR   1B32H   A   
SETUPSCOPESWAP. . . . . . . . . . . . .    C ADDR   1B47H   A   
SETUPSCOPEXRAM. . . . . . . . . . . . .    C ADDR   1B53H   A   
SHUTOSCBURST. . . . . . . . . . . . . .    C ADDR   0DA9H   A   
SHUTOSCNEXTBURST. . . . . . . . . . . .    C ADDR   15C7H   A   
SHUTOSCNEXTTICK . . . . . . . . . . . .    C ADDR   15C4H   A   
SHUTOSCTICK . . . . . . . . . . . . . .    C ADDR   0DB3H   A   
SMXRAMCHANNEL . . . . . . . . . . . . .    C ADDR   1C08H   A   
SP. . . . . . . . . . . . . . . . . . .    D ADDR   0081H   A   
SPE . . . . . . . . . . . . . . . . . .    B ADDR   00F8H.5 A   
SPH . . . . . . . . . . . . . . . . . .    D ADDR   00B7H   A   
SPICON. . . . . . . . . . . . . . . . .    D ADDR   00F8H   A   
SPIDAT. . . . . . . . . . . . . . . . .    D ADDR   00F7H   A   
SPIM. . . . . . . . . . . . . . . . . .    B ADDR   00F8H.4 A   
SPI_CONFIG_BIAS . . . . . . . . . . . .    N NUMB   0033H   A   
SPI_CONFIG_CLOCK. . . . . . . . . . . .    N NUMB   0034H   A   
SPI_CONFIG_MPX. . . . . . . . . . . . .    N NUMB   0034H   A   
SPI_CONFIG_MPX_1. . . . . . . . . . . .    N NUMB   0034H   A   
SPI_CONFIG_MPX_2. . . . . . . . . . . .    N NUMB   0035H   A   
SPI_CONFIG_MPX_3. . . . . . . . . . . .    N NUMB   0036H   A   
SPI_CONFIG_MPX_4. . . . . . . . . . . .    N NUMB   0037H   A   
SPR0. . . . . . . . . . . . . . . . . .    B ADDR   00F8H.0 A   
SPR1. . . . . . . . . . . . . . . . . .    B ADDR   00F8H.1 A   
SSCOPYBYTE. . . . . . . . . . . . . . .    C ADDR   1B62H   A   
SSCOPYSERIE . . . . . . . . . . . . . .    C ADDR   1B5DH   A   
SSDCOPYBYTE . . . . . . . . . . . . . .    C ADDR   1BCBH   A   
SSFINISHED. . . . . . . . . . . . . . .    C ADDR   1B79H   A   
SSGOTONEXT. . . . . . . . . . . . . . .    C ADDR   1B73H   A   
STREAMLENGTH_MEDIPIX21. . . . . . . . .    C ADDR   088EH   A   
STREAMLENGTH_MEDIPIXMXR . . . . . . . .    C ADDR   089AH   A   
STR_COINCIDENCEEVENTINVALID . . . . . .    C ADDR   07DBH   A   
STR_COINCIDENCEEVENTVALID . . . . . . .    C ADDR   07C6H   A   
STR_COMMAND1. . . . . . . . . . . . . .    C ADDR   07F2H   A   
STR_COMMAND2. . . . . . . . . . . . . .    C ADDR   07FEH   A   
STR_COUNTERFINISHED . . . . . . . . . .    C ADDR   079CH   A   
STR_ERROR . . . . . . . . . . . . . . .    C ADDR   06D3H   A   
STR_ERRORFSR. . . . . . . . . . . . . .    C ADDR   0754H   A   
STR_FRAMESFINISHED. . . . . . . . . . .    C ADDR   0761H   A   
STR_HELP. . . . . . . . . . . . . . . .    C ADDR   069DH   A   
STR_INFO. . . . . . . . . . . . . . . .    C ADDR   0665H   A   
STR_INTERVALFINISHED. . . . . . . . . .    C ADDR   0774H   A   
STR_MEDIPINOTENABLEOUT. . . . . . . . .    C ADDR   0728H   A   
STR_MEDIPIX20CNT. . . . . . . . . . . .    C ADDR   0627H   A   
STR_MEDIPIXCNT. . . . . . . . . . . . .    C ADDR   0617H   A   
STR_MEDIPIXMXRCNT . . . . . . . . . . .    C ADDR   063BH   A   
STR_MEDIPIXNOTCONNECTED . . . . . . . .    C ADDR   0703H   A   
STR_OK. . . . . . . . . . . . . . . . .    C ADDR   0613H   A   
STR_ONLINE. . . . . . . . . . . . . . .    C ADDR   05F8H   A   
STR_PERIODFINISHED. . . . . . . . . . .    C ADDR   0789H   A   
STR_READY . . . . . . . . . . . . . . .    C ADDR   060CH   A   
STR_READYSPC. . . . . . . . . . . . . .    C ADDR   060BH   A   
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    90

STR_SCOPE . . . . . . . . . . . . . . .    C ADDR   080AH   A   
STR_SYNCSTRING. . . . . . . . . . . . .    C ADDR   06AEH   A   
STR_TIMEPIXCNT. . . . . . . . . . . . .    C ADDR   064FH   A   
STR_TODO. . . . . . . . . . . . . . . .    C ADDR   0813H   A   
STR_TODO_CLOSESHUTTER . . . . . . . . .    C ADDR   0822H   A   
STR_TODO_COMMAND1 . . . . . . . . . . .    C ADDR   087AH   A   
STR_TODO_COMMAND2 . . . . . . . . . . .    C ADDR   0884H   A   
STR_TODO_OPENSHUTTER. . . . . . . . . .    C ADDR   0831H   A   
STR_TODO_STARTCOUNTER . . . . . . . . .    C ADDR   086BH   A   
STR_TODO_STARTINTERVAL. . . . . . . . .    C ADDR   083FH   A   
STR_TODO_STARTSCOPE . . . . . . . . . .    C ADDR   084FH   A   
STR_TODO_STARTTRIGGER . . . . . . . . .    C ADDR   085CH   A   
STR_TRIGGERFINISHED . . . . . . . . . .    C ADDR   07B2H   A   
STR_UNKNOWNCOMBEG . . . . . . . . . . .    C ADDR   06ECH   A   
STR_UNKNOWNCOMEND . . . . . . . . . . .    C ADDR   0700H   A   
STR_VERSION . . . . . . . . . . . . . .    C ADDR   0695H   A   
T2. . . . . . . . . . . . . . . . . . .    B ADDR   0090H.0 A   
T2CON . . . . . . . . . . . . . . . . .    D ADDR   00C8H   A   
T2EX. . . . . . . . . . . . . . . . . .    B ADDR   0090H.1 A   
T3CON . . . . . . . . . . . . . . . . .    D ADDR   009EH   A   
T3FD. . . . . . . . . . . . . . . . . .    D ADDR   009DH   A   
TCLK. . . . . . . . . . . . . . . . . .    B ADDR   00C8H.4 A   
TDCLOSESHUTTER. . . . . . . . . . . . .    C ADDR   03BAH   A   
TDCLOSESHUTTEREND . . . . . . . . . . .    C ADDR   03CDH   A   
TDCLOSESHUTTERMAKE. . . . . . . . . . .    C ADDR   03C7H   A   
TDMAKECOMMAND1. . . . . . . . . . . . .    C ADDR   041AH   A   
TDMAKECOMMAND1END . . . . . . . . . . .    C ADDR   041FH   A   
TDMAKECOMMAND2. . . . . . . . . . . . .    C ADDR   041FH   A   
TDMAKECOMMAND2END . . . . . . . . . . .    C ADDR   0424H   A   
TDOPENSHUTTER . . . . . . . . . . . . .    C ADDR   03CDH   A   
TDOPENSHUTTEREND. . . . . . . . . . . .    C ADDR   03F6H   A   
TDOPENSHUTTERMAKE . . . . . . . . . . .    C ADDR   03DAH   A   
TDOPENSHUTTERNOINT. . . . . . . . . . .    C ADDR   03E2H   A   
TDRETURN. . . . . . . . . . . . . . . .    C ADDR   0424H   A   
TDSTARTINTERVAL . . . . . . . . . . . .    C ADDR   03F6H   A   
TDSTARTINTERVALEND. . . . . . . . . . .    C ADDR   0408H   A   
TDSTARTINTERVALMAKE . . . . . . . . . .    C ADDR   0403H   A   
TDSTARTSCOPE. . . . . . . . . . . . . .    C ADDR   039DH   A   
TDSTARTSCOPEEND . . . . . . . . . . . .    C ADDR   03BAH   A   
TDSTARTSCOPEMAKE. . . . . . . . . . . .    C ADDR   03ADH   A   
TDSTARTTRIGGER. . . . . . . . . . . . .    C ADDR   0408H   A   
TDSTARTTRIGGEREND . . . . . . . . . . .    C ADDR   041AH   A   
TDSTARTTRIGGERMAKE. . . . . . . . . . .    C ADDR   0415H   A   
TENMICROINNER . . . . . . . . . . . . .    C ADDR   1D15H   A   
TENMICROINNER_. . . . . . . . . . . . .    C ADDR   1CFAH   A   
TENMICROSECONDS . . . . . . . . . . . .    C ADDR   1D12H   A   
TENMICROSECONDS_. . . . . . . . . . . .    C ADDR   1CF7H   A   
TESTFSRCYCL_NOERR . . . . . . . . . . .    C ADDR   0B3BH   A   
TESTFSRDONEOK . . . . . . . . . . . . .    C ADDR   0B32H   A   
TESTFSRENABLEOUT. . . . . . . . . . . .    C ADDR   0B13H   A   
TESTFSRFAILED . . . . . . . . . . . . .    C ADDR   0B0CH   A   
TESTFSRSENDBYTE . . . . . . . . . . . .    C ADDR   0AF8H   A   
TESTITEM. . . . . . . . . . . . . . . .    C ADDR   02DDH   A   
TF2 . . . . . . . . . . . . . . . . . .    B ADDR   00C8H.7 A   
TH0 . . . . . . . . . . . . . . . . . .    D ADDR   008CH   A   
TH1 . . . . . . . . . . . . . . . . . .    D ADDR   008DH   A   
TH2 . . . . . . . . . . . . . . . . . .    D ADDR   00CDH   A   
TI. . . . . . . . . . . . . . . . . . .    B ADDR   0098H.1 A   
TIMECON . . . . . . . . . . . . . . . .    D ADDR   00A1H   A   
TL0 . . . . . . . . . . . . . . . . . .    D ADDR   008AH   A   
TL1 . . . . . . . . . . . . . . . . . .    D ADDR   008BH   A   
TL2 . . . . . . . . . . . . . . . . . .    D ADDR   00CCH   A   
TMOD. . . . . . . . . . . . . . . . . .    D ADDR   0089H   A   
TMPX_FREQ0. . . . . . . . . . . . . . .    B ADDR   00B0H.6 A   
TMPX_FREQ1. . . . . . . . . . . . . . .    B ADDR   00B0H.4 A   
TODO_CLOSESHUTTER . . . . . . . . . . .    B ADDR   00E0H.0 A   
A51 MACRO ASSEMBLER  MEDIPIX                                                              06/27/2015 21:20:09 PAGE    91

TODO_COMMAND1 . . . . . . . . . . . . .    D ADDR   0067H   A   
TODO_COMMAND2 . . . . . . . . . . . . .    D ADDR   0068H   A   
TODO_MAKECOMMAND1 . . . . . . . . . . .    B ADDR   00E0H.6 A   
TODO_MAKECOMMAND2 . . . . . . . . . . .    B ADDR   00E0H.7 A   
TODO_OPENSHUTTER. . . . . . . . . . . .    B ADDR   00E0H.1 A   
TODO_STARTCOUNTER . . . . . . . . . . .    B ADDR   00E0H.5 A   
TODO_STARTINTERVAL. . . . . . . . . . .    B ADDR   00E0H.2 A   
TODO_STARTSCOPE . . . . . . . . . . . .    B ADDR   00E0H.3 A   
TODO_STARTTRIGGER . . . . . . . . . . .    B ADDR   00E0H.4 A   
TR0 . . . . . . . . . . . . . . . . . .    B ADDR   0088H.4 A   
TR1 . . . . . . . . . . . . . . . . . .    B ADDR   0088H.6 A   
TR2 . . . . . . . . . . . . . . . . . .    B ADDR   00C8H.2 A   
TRANSMITSINGLEID. . . . . . . . . . . .    C ADDR   0B5DH   A   
TRIGGERCLEAR. . . . . . . . . . . . . .    C ADDR   1990H   A   
TRIGGERDEFAULT. . . . . . . . . . . . .    C ADDR   196BH   A   
TRIGGEREVENT. . . . . . . . . . . . . .    C ADDR   00C2H   A   
TRIGGERIN . . . . . . . . . . . . . . .    B ADDR   00B0H.0 A   
TRIGGERINCREMENT. . . . . . . . . . . .    C ADDR   00BAH   A   
TRIGGEROUT. . . . . . . . . . . . . . .    B ADDR   00B0H.1 A   
TRIGGERRESTART. . . . . . . . . . . . .    C ADDR   19ACH   A   
TRIGGERVERYRETURN . . . . . . . . . . .    C ADDR   00CCH   A   
TRIGGER_COINC . . . . . . . . . . . . .    D ADDR   0059H   A   
TRIGGER_COINCDELAY. . . . . . . . . . .    D ADDR   005AH   A   
TRIGGER_COUNT . . . . . . . . . . . . .    D ADDR   0054H   A   
TRIGGER_TODO. . . . . . . . . . . . . .    D ADDR   0058H   A   
UNKNOWNCOM. . . . . . . . . . . . . . .    C ADDR   0317H   A   
VERSION_MAJOR . . . . . . . . . . . . .    N NUMB   0001H   A   
VERSION_MINOR . . . . . . . . . . . . .    N NUMB   0002H   A   
VERSION_SUBMINOR. . . . . . . . . . . .    N NUMB   0000H   A   
WAIT. . . . . . . . . . . . . . . . . .    C ADDR   1D07H   A   
WAIT10MICROSECONDS. . . . . . . . . . .    C ADDR   1CEFH   A   
WAITFORCOMMAND. . . . . . . . . . . . .    C ADDR   026CH   A   
WAITFORCOMMANDOPTIM . . . . . . . . . .    C ADDR   0289H   A   
WAITFORCOMMANDOPTIMLOOP . . . . . . . .    C ADDR   028CH   A   
WAITFORSCOPE. . . . . . . . . . . . . .    C ADDR   046AH   A   
WAITHALF. . . . . . . . . . . . . . . .    C ADDR   1D37H   A   
WAITINGFORPES . . . . . . . . . . . . .    C ADDR   0A50H   A   
WAITINGFORPESCLEAR. . . . . . . . . . .    C ADDR   0AA9H   A   
WAITMICROSECOND . . . . . . . . . . . .    C ADDR   1CC2H   A   
WAITMICROSECONDS. . . . . . . . . . . .    C ADDR   1CCFH   A   
WAITMICROSEND . . . . . . . . . . . . .    C ADDR   1CEAH   A   
WAITQUARTER . . . . . . . . . . . . . .    C ADDR   1D2EH   A   
WAITSECOND. . . . . . . . . . . . . . .    C ADDR   1D3BH   A   
WAITTENTH . . . . . . . . . . . . . . .    C ADDR   1D25H   A   
WATCHDOGCONFIG. . . . . . . . . . . . .    C ADDR   025FH   A   
WATCHDOG_ALERT. . . . . . . . . . . . .    C ADDR   06DBH   A   
WCOL. . . . . . . . . . . . . . . . . .    B ADDR   00F8H.6 A   
WDCON . . . . . . . . . . . . . . . . .    D ADDR   00C0H   A   
WDE . . . . . . . . . . . . . . . . . .    B ADDR   00C0H.1 A   
WDIR. . . . . . . . . . . . . . . . . .    B ADDR   00C0H.3 A   
WDS . . . . . . . . . . . . . . . . . .    B ADDR   00C0H.2 A   
WDWR. . . . . . . . . . . . . . . . . .    B ADDR   00C0H.0 A   
WFCO_SHUTTERCLOSED1 . . . . . . . . . .    C ADDR   0291H   A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
